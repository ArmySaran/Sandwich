<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0c8ce9">
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ - POS System for Sandwich Shop">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sandwich POS">

    <title>ü•™ ‡∏£‡πâ‡∏≤‡∏ô Sandwich ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏° - POS System</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•™</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•™</text></svg>">

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js" defer></script>

    <!-- Local JavaScript files -->
    <script src="js/config.js" defer></script>
    <script src="js/database.js" defer></script>

    <style>
        /* CSS Custom Properties */
        :root {
            /* Colors */
            --primary: #0c8ce9;
            --primary-dark: #0159a2;
            --primary-light: #bae1fc;
            --secondary: #f97316;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;

            /* Neutral Colors */
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;

            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;

            /* Spacing */
            --spacing-1: 0.25rem;
            --spacing-2: 0.5rem;
            --spacing-3: 0.75rem;
            --spacing-4: 1rem;
            --spacing-5: 1.25rem;
            --spacing-6: 1.5rem;
            --spacing-8: 2rem;
            --spacing-12: 3rem;

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

            /* Z-index */
            --z-modal: 1000;
            --z-dropdown: 100;
            --z-header: 10;
        }

        /* Reset and Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--gray-50);
            color: var(--gray-900);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Mobile-First Responsive Grid */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-4);
        }

        .grid {
            display: grid;
            gap: var(--spacing-4);
        }

        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }

        @media (min-width: 640px) {
            .sm\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .sm\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        @media (min-width: 768px) {
            .md\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }

        /* Flexbox Utilities */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: var(--spacing-2); }
        .gap-4 { gap: var(--spacing-4); }

        /* Layout Components */
        .app-header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: var(--spacing-4);
            position: sticky;
            top: 0;
            z-index: var(--z-header);
            box-shadow: var(--shadow-sm);
        }

        .app-content {
            padding: var(--spacing-4) 0 80px 0;
            min-height: calc(100vh - 140px);
        }

        .app-nav {
            background: var(--white);
            border-top: 1px solid var(--gray-200);
            padding: var(--spacing-2) var(--spacing-4);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: var(--z-header);
            box-shadow: 0 -1px 3px 0 rgb(0 0 0 / 0.1);
        }

        /* Button Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            padding: var(--spacing-3) var(--spacing-4);
            font-size: var(--font-size-sm);
            font-weight: 500;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            min-height: 44px; /* Touch target */
            -webkit-user-select: none;
            user-select: none;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-sm {
            padding: var(--spacing-2) var(--spacing-3);
            font-size: var(--font-size-xs);
            min-height: 36px;
        }

        .btn-lg {
            padding: var(--spacing-4) var(--spacing-6);
            font-size: var(--font-size-lg);
            min-height: 52px;
        }

        /* Card Component */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: var(--spacing-4) var(--spacing-6);
            border-bottom: 1px solid var(--gray-200);
        }

        .card-body {
            padding: var(--spacing-6);
        }

        .card-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-2);
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: var(--spacing-2);
            overflow-x: auto;
            padding-bottom: var(--spacing-2);
            -webkit-overflow-scrolling: touch;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-1);
            padding: var(--spacing-2);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 60px;
            text-align: center;
            color: var(--gray-500);
            text-decoration: none;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        .nav-icon {
            font-size: var(--font-size-xl);
        }

        .nav-label {
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: var(--spacing-4);
        }

        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--spacing-2);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: var(--font-size-base);
            transition: border-color 0.15s ease;
            min-height: 44px; /* Touch target */
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(12 140 233 / 0.1);
        }

        .form-select {
            width: 100%;
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: var(--font-size-base);
            background: var(--white);
            cursor: pointer;
            min-height: 44px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: var(--z-modal);
            padding: var(--spacing-4);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .modal-header {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            cursor: pointer;
            padding: var(--spacing-2);
            border-radius: var(--radius);
            color: var(--gray-500);
            min-height: 44px;
            min-width: 44px;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .modal-body {
            padding: var(--spacing-6);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: var(--spacing-4);
            right: var(--spacing-4);
            z-index: var(--z-modal);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
            pointer-events: none;
        }

        .toast {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-4);
            max-width: 300px;
            pointer-events: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--error);
        }

        .toast-warning {
            border-left: 4px solid var(--warning);
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .block { display: block; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .text-sm { font-size: var(--font-size-sm); }
        .text-lg { font-size: var(--font-size-lg); }
        .text-xl { font-size: var(--font-size-xl); }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-700 { color: var(--gray-700); }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .mb-2 { margin-bottom: var(--spacing-2); }
        .mb-4 { margin-bottom: var(--spacing-4); }
        .mt-4 { margin-top: var(--spacing-4); }
        .p-4 { padding: var(--spacing-4); }
        .px-4 { padding-left: var(--spacing-4); padding-right: var(--spacing-4); }
        .py-4 { padding-top: var(--spacing-4); padding-bottom: var(--spacing-4); }

        /* Responsive Utilities */
        @media (max-width: 640px) {
            .container {
                padding: 0 var(--spacing-3);
            }

            .app-header {
                padding: var(--spacing-3);
            }

            .card-body {
                padding: var(--spacing-4);
            }

            .modal-content {
                margin: var(--spacing-2);
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --gray-50: #1e293b;
                --gray-100: #334155;
                --gray-200: #475569;
                --gray-900: #f8fafc;
                --white: #0f172a;
            }
        }

        /* Loading States */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Screen Management */
        .screen {
            display: none;
            min-height: calc(100vh - 140px);
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Menu Grid for POS */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--spacing-3);
        }

        .menu-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .menu-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .menu-item-image {
            width: 60px;
            height: 60px;
            border-radius: var(--radius);
            background: var(--gray-100);
            margin: 0 auto var(--spacing-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-2xl);
        }

        .menu-item-name {
            font-weight: 500;
            margin-bottom: var(--spacing-1);
        }

        .menu-item-price {
            color: var(--primary);
            font-weight: 600;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: var(--spacing-4) 0;
        }

        @media (max-width: 640px) {
            .chart-container {
                height: 250px;
            }
        }

        /* Customer Card */
        .customer-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .customer-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .customer-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .customer-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: var(--font-size-lg);
        }

        /* Payment Method Selection */
        .payment-method {
            border: 2px solid var(--gray-200);
        }

        .payment-method.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }

        .payment-section {
            display: none;
        }

        .payment-section.active {
            display: block;
        }

        /* Low Stock Alert */
        .low-stock {
            border-left: 4px solid var(--error);
            background: var(--error-50);
        }

        /* Stats Cards */
        .stat-card {
            text-align: center;
            padding: var(--spacing-4);
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }

        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--spacing-1);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--spacing-1) var(--spacing-2);
            font-size: var(--font-size-xs);
            font-weight: 500;
            border-radius: var(--radius);
        }

        .badge-success {
            background: var(--success-50);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-50);
            color: var(--warning);
        }

        .badge-error {
            background: var(--error-50);
            color: var(--error);
        }

        /* Space utilities */
        .space-y-2 > * + * { margin-top: var(--spacing-2); }
        .space-y-3 > * + * { margin-top: var(--spacing-3); }
        .space-y-4 > * + * { margin-top: var(--spacing-4); }

        /* Max height utilities */
        .max-h-60 { max-height: 15rem; }
        .overflow-y-auto { overflow-y: auto; }
    </style>
</head>
<body>
    <!-- App Header -->
    <header class="app-header">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="text-2xl">ü•™</div>
                <div>
                    <h1 class="font-semibold text-lg">‡∏£‡πâ‡∏≤‡∏ô Sandwich ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏°</h1>
                    <p class="text-sm text-gray-500">POS System</p>
                </div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="showSettings()">
                ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="app-content">
        <div class="container">
            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="screen active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Today's Sales -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title text-primary">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                            <p class="text-3xl font-bold text-success" id="today-sales">‡∏ø0</p>
                            <p class="text-sm text-gray-500">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="last-update">--:--</span></p>
                        </div>
                    </div>

                    <!-- Today's Orders -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title text-primary">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                            <p class="text-3xl font-bold text-primary" id="today-orders">0</p>
                            <p class="text-sm text-gray-500">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h3 class="card-title">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <button class="btn btn-primary" onclick="switchScreen('pos-screen')">
                                üõí ‡∏Ç‡∏≤‡∏¢
                            </button>
                            <button class="btn btn-secondary" onclick="switchScreen('inventory-screen')">
                                üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ
                            </button>
                            <button class="btn btn-secondary" onclick="switchScreen('reports-screen')">
                                üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                            </button>
                            <button class="btn btn-secondary" onclick="showExpenseModal()">
                                üí∏ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sales Chart -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- POS Screen -->
            <div id="pos-screen" class="screen">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Menu Items -->
                    <div class="lg:col-span-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‡πÄ‡∏°‡∏ô‡∏π</h3>
                                <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." id="menu-search">
                            </div>
                            <div class="card-body">
                                <div class="menu-grid" id="menu-container">
                                    <!-- Menu items will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Cart -->
                    <div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                            </div>
                            <div class="card-body">
                                <div id="cart-items" class="mb-4">
                                    <p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                                </div>
                                <div class="border-t pt-4">
                                    <div class="flex justify-between items-center mb-4">
                                        <span class="font-semibold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                        <span class="text-xl font-bold text-primary" id="cart-total">‡∏ø0</span>
                                    </div>
                                    <button class="btn btn-success btn-lg w-full" onclick="processPayment()" disabled id="checkout-btn">
                                        üí∞ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Screen -->
            <div id="inventory-screen" class="screen">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Menu Management -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="exportData()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
                                <label class="btn btn-secondary btn-sm cursor-pointer">
                                    üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                                    <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                                </label>
                                <button class="btn btn-primary btn-sm" onclick="showAddMenuItemModal()">
                                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <div class="flex gap-2 mb-3">
                                    <select class="form-select flex-1" id="menu-category-filter" onchange="filterMenuItems()">
                                        <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                                        <option value="sandwich">ü•™ ‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä</option>
                                        <option value="beverage">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                        <option value="side">üçü ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</option>
                                        <option value="dessert">üç∞ ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                                        <option value="combo">üçΩÔ∏è ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</option>
                                    </select>
                                    <button class="btn btn-secondary btn-sm" onclick="showManageCategoriesModal()">
                                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                                    </button>
                                </div>
                                <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." id="menu-search" oninput="filterMenuItems()">
                            </div>
                            <div class="grid grid-cols-1 gap-3" id="menu-items-container">
                                <!-- Menu items will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Ingredient Management -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddIngredientModal()">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <div class="flex gap-2 mb-3">
                                    <select class="form-select flex-1" id="ingredient-status-filter" onchange="filterIngredients()">
                                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                        <option value="low_stock">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏ï‡πà‡∏≥</option>
                                        <option value="out_of_stock">‡∏´‡∏°‡∏î</option>
                                        <option value="in_stock">‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</option>
                                    </select>
                                </div>
                                <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö..." id="ingredient-search" oninput="filterIngredients()">
                            </div>
                            <div class="grid grid-cols-1 gap-3" id="ingredients-container">
                                <!-- Ingredients will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Screen -->
            <div id="reports-screen" class="screen">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Sales Report -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
                            <select class="form-select" id="sales-period" onchange="updateSalesReport()">
                                <option value="7">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                <option value="30">30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                <option value="90">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="salesReportChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Products -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h3>
                        </div>
                        <div class="card-body">
                            <div id="top-products-list">
                                <!-- Top products will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Profit Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≥‡πÑ‡∏£</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-success" id="total-revenue">‡∏ø0</div>
                                    <div class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-error" id="total-costs">‡∏ø0</div>
                                    <div class="text-sm text-gray-500">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-primary" id="net-profit">‡∏ø0</div>
                                    <div class="text-sm text-gray-500">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="profitChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Analytics -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-primary" id="total-customers">0</div>
                                    <div class="text-sm text-gray-500">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-secondary" id="returning-customers">0</div>
                                    <div class="text-sm text-gray-500">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥</div>
                                </div>
                            </div>
                            <div id="top-customers-list">
                                <!-- Top customers will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Management Screen -->
            <div id="customers-screen" class="screen">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Customer List -->
                    <div class="lg:col-span-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                                <button class="btn btn-primary btn-sm" onclick="showAddCustomerModal()">
                                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." id="customer-search">
                                </div>
                                <div id="customers-list" class="space-y-3">
                                    <!-- Customers will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Stats -->
                    <div>
                        <div class="card mb-6">
                            <div class="card-header">
                                <h3 class="card-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                            </div>
                            <div class="card-body">
                                <div class="space-y-4">
                                    <div class="flex justify-between">
                                        <span>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                                        <span class="font-semibold text-primary" id="new-customers-today">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</span>
                                        <span class="font-semibold text-success" id="returning-today">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                        <span class="font-semibold text-secondary" id="total-points-issued">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Loyalty Program -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" class="form-input" id="points-rate" value="1" min="0" step="0.1">
                                        <span class="text-sm text-gray-500">% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm w-full" onclick="updateLoyaltySettings()">
                                    ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="app-nav">
        <div class="nav">
            <a href="#" class="nav-item active" onclick="switchScreen('dashboard-screen')" data-screen="dashboard">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
            </a>
            <a href="#" class="nav-item" onclick="switchScreen('pos-screen')" data-screen="pos">
                <div class="nav-icon">üõí</div>
                <div class="nav-label">‡∏Ç‡∏≤‡∏¢</div>
            </a>
            <a href="#" class="nav-item" onclick="switchScreen('inventory-screen')" data-screen="inventory">
                <div class="nav-icon">üì¶</div>
                <div class="nav-label">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</div>
            </a>
            <a href="#" class="nav-item" onclick="switchScreen('reports-screen')" data-screen="reports">
                <div class="nav-icon">üìã</div>
                <div class="nav-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            </a>
            <a href="#" class="nav-item" onclick="switchScreen('customers-screen')" data-screen="customers">
                <div class="nav-icon">üë•</div>
                <div class="nav-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            </a>
        </div>
    </nav>

    <!-- Modals -->

    <!-- Expense Modal -->
    <div id="expense-modal" class="modal">
        <div class="modal-backdrop" onclick="closeExpenseModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>
                <button class="modal-close" onclick="closeExpenseModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="expense-form">
                    <div class="form-group">
                        <label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <input type="text" class="form-input" id="expense-item" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö, ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" class="form-input" id="expense-amount" placeholder="0" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <select class="form-select" id="expense-category" required>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                            <option value="ingredients">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
                            <option value="utilities">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option>
                            <option value="marketing">‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
                            <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea class="form-input" id="expense-notes" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary flex-1" onclick="closeExpenseModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-backdrop" onclick="closeSettings()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
                    <input type="text" class="form-input" id="shop-name" value="‡∏£‡πâ‡∏≤‡∏ô Sandwich ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏°">
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                    <input type="tel" class="form-input" id="shop-phone" placeholder="08X-XXX-XXXX">
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <textarea class="form-input" id="shop-address" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ (%)</label>
                    <input type="number" class="form-input" id="tax-rate" value="7" min="0" max="20" step="0.1">
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="time" class="form-input" id="open-time" value="06:00">
                        <input type="time" class="form-input" id="close-time" value="20:00">
                    </div>
                </div>
                <div class="flex gap-4">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closeSettings()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary flex-1" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="modal">
        <div class="modal-backdrop" onclick="closeAddCustomerModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                <button class="modal-close" onclick="closeAddCustomerModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="customer-form">
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" class="form-input" id="customer-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                        <input type="tel" class="form-input" id="customer-phone" placeholder="08X-XXX-XXXX">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" class="form-input" id="customer-email" placeholder="customer@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                        <input type="date" class="form-input" id="customer-birthday">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea class="form-input" id="customer-notes" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary flex-1" onclick="closeAddCustomerModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Customer Selection Modal -->
    <div id="customer-select-modal" class="modal">
        <div class="modal-backdrop" onclick="closeCustomerSelectModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                <button class="modal-close" onclick="closeCustomerSelectModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." id="customer-select-search">
                </div>
                <div id="customer-select-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Customer list will be loaded here -->
                </div>
                <div class="mt-4">
                    <button class="btn btn-secondary w-full" onclick="selectWalkInCustomer()">
                        üö∂‚Äç‚ôÇÔ∏è ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Inventory Modal -->
    <div id="add-inventory-modal" class="modal">
        <div class="modal-backdrop" onclick="closeAddInventoryModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                <button class="modal-close" onclick="closeAddInventoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="inventory-form">
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" class="form-input" id="item-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                            <input type="number" class="form-input" id="item-stock" placeholder="0" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <select class="form-select" id="item-unit" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>
                                <option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
                                <option value="‡πÅ‡∏ú‡πà‡∏ô">‡πÅ‡∏ú‡πà‡∏ô</option>
                                <option value="‡∏Å‡∏Å.">‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</option>
                                <option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏°</option>
                                <option value="‡∏•‡∏¥‡∏ï‡∏£">‡∏•‡∏¥‡∏ï‡∏£</option>
                                <option value="‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á">‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á</option>
                                <option value="‡∏´‡πà‡∏≠">‡∏´‡πà‡∏≠</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-input" id="item-cost" placeholder="0" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-input" id="item-price" placeholder="0" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
                            <input type="number" class="form-input" id="item-min-stock" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                            <select class="form-select" id="item-supplier">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea class="form-input" id="item-notes" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary flex-1" onclick="closeAddInventoryModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-backdrop" onclick="closePaymentModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <button class="modal-close" onclick="closePaymentModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="mb-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-primary mb-2" id="payment-total">‡∏ø0</div>
                        <div class="text-gray-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <div class="flex gap-2">
                        <input type="text" class="form-input flex-1" id="payment-customer" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" readonly>
                        <button class="btn btn-secondary btn-sm" onclick="showCustomerSelectModal()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="btn btn-secondary payment-method active" data-method="cash" onclick="selectPaymentMethod('cash')">
                            üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                        </button>
                        <button class="btn btn-secondary payment-method" data-method="card" onclick="selectPaymentMethod('card')">
                            üí≥ ‡∏ö‡∏±‡∏ï‡∏£
                        </button>
                        <button class="btn btn-secondary payment-method" data-method="transfer" onclick="selectPaymentMethod('transfer')">
                            üì± ‡πÇ‡∏≠‡∏ô
                        </button>
                        <button class="btn btn-secondary payment-method" data-method="qr" onclick="selectPaymentMethod('qr')">
                            üî≤ QR Code
                        </button>
                    </div>
                </div>

                <div id="cash-payment" class="payment-section">
                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤</label>
                        <input type="number" class="form-input" id="cash-received" placeholder="0" min="0" step="0.01" onchange="calculateChange()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</label>
                        <div class="text-xl font-bold text-success" id="change-amount">‡∏ø0</div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="apply-discount" onchange="toggleDiscount()">
                        <label for="apply-discount" class="form-label mb-0">‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                    </div>
                    <div id="discount-section" class="hidden mt-2">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" class="form-input" id="discount-amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" min="0" step="0.01" onchange="applyDiscount()">
                            <select class="form-select" id="discount-type" onchange="applyDiscount()">
                                <option value="amount">‡∏ö‡∏≤‡∏ó</option>
                                <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closePaymentModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-success flex-1" onclick="confirmPayment()">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- JavaScript -->
    <script>
        'use strict';

        // Application State
        const AppState = {
            currentScreen: 'dashboard-screen',
            cart: [],
            currentCustomer: null,
            menuItems: [],
            inventory: [],
            sales: [],
            expenses: [],
            customers: [],
            employees: [],
            suppliers: [],
            promotions: [],
            notifications: [],
            settings: {
                shopName: '‡∏£‡πâ‡∏≤‡∏ô Sandwich ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏°',
                shopPhone: '',
                shopAddress: '',
                taxRate: 7,
                currency: 'THB',
                businessHours: {
                    open: '06:00',
                    close: '20:00'
                },
                loyaltyPoints: {
                    enabled: true,
                    rate: 0.01 // 1% cashback
                }
            },
            // Chart references
            dashboardChart: null,
            salesChart: null,
            productsChart: null,
            salesReportChart: null
        };

        // Utility Functions
        const Utils = {
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('th-TH', {
                    style: 'currency',
                    currency: 'THB',
                    minimumFractionDigits: 0
                }).format(amount);
            },

            formatDate: (date) => {
                return new Intl.DateTimeFormat('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            },

            generateId: () => {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },

            createPlaceholderImage: (text = 'No Image', width = 100, height = 100) => {
                const svg = `
                    <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                        <rect width="100%" height="100%" fill="#e5e7eb"/>
                        <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" font-family="sans-serif" font-size="12" fill="#6b7280">
                            ${text.length > 15 ? text.substring(0, 15) + '...' : text}
                        </text>
                    </svg>
                `;
                return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
            },

            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Toast Notification System
        const Toast = {
            show: (message, type = 'success', duration = 3000) => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;

                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };

                toast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${icons[type] || icons.info}</span>
                        <span>${message}</span>
                    </div>
                `;

                container.appendChild(toast);

                // Trigger animation
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                // Auto remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            container.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            }
        };

        // Toast function alias for compatibility
        const showToast = (message, type = 'success', duration = 3000) => {
            Toast.show(message, type, duration);
        };

        // Screen Navigation
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Show target screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                AppState.currentScreen = screenId;
            }

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const navItem = document.querySelector(`[data-screen="${screenId.replace('-screen', '')}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            // Load screen data
            switch(screenId) {
                case 'dashboard-screen':
                    loadDashboard();
                    break;
                case 'pos-screen':
                    loadPOSMenu();
                    break;
                case 'inventory-screen':
                    loadMenuItems();
                    loadIngredients();
                    break;
                case 'reports-screen':
                    loadReports();
                    break;
            }
        }

        // POS Functions
        async function loadPOSMenu() {
            try {
                if (!window.db || !window.db.isReady) {
                    console.log('‚è≥ Database not ready for POS menu, retrying...');
                    setTimeout(loadPOSMenu, 1000);
                    return;
                }

                const menuItems = await window.db.getMenuItems();
                const container = document.getElementById('menu-container');

                if (!container) return;

                container.innerHTML = menuItems.map(item => `
                    <div class="menu-item" data-item-id="${item.id}">
                        <div class="menu-item-image">
                            <img src="${item.image || Utils.createPlaceholderImage(item.name)}"
                                 alt="${item.name}" loading="lazy" onerror="this.src='${Utils.createPlaceholderImage('No Image')}'">
                        </div>
                        <div class="menu-item-info">
                            <h4>${item.name}</h4>
                            <p class="price">${Utils.formatCurrency(item.price)}</p>
                            <button class="btn btn-primary btn-sm" onclick="addToCart('${item.id}')">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                    </div>
                `).join('');

                // Setup search functionality
                const searchInput = document.getElementById('menu-search');
                if (searchInput) {
                    searchInput.addEventListener('input', filterPOSMenu);
                }

            } catch (error) {
                console.error('‚ùå Error loading POS menu:', error);
            }
        }

        function filterPOSMenu() {
            const searchTerm = document.getElementById('menu-search').value.toLowerCase();
            const menuItems = document.querySelectorAll('#menu-container .menu-item');

            menuItems.forEach(item => {
                const itemName = item.querySelector('h4').textContent.toLowerCase();
                item.style.display = itemName.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function addToCart(itemId) {
            try {
                const menuItem = await window.db.findById('menu_items', itemId);
                if (!menuItem) return;

                // Check if item already exists in cart
                const existingItem = AppState.cart.find(item => item.id === itemId);

                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    AppState.cart.push({
                        id: itemId,
                        name: menuItem.name,
                        price: menuItem.price,
                        quantity: 1
                    });
                }

                updateCartDisplay();
                showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${menuItem.name} ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');

            } catch (error) {
                console.error('‚ùå Error adding to cart:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function updateCartDisplay() {
            const cartContainer = document.getElementById('cart-items');
            const totalElement = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (!cartContainer || !totalElement || !checkoutBtn) return;

            if (AppState.cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
                totalElement.textContent = Utils.formatCurrency(0);
                checkoutBtn.disabled = true;
                return;
            }

            cartContainer.innerHTML = AppState.cart.map(item => `
                <div class="cart-item flex justify-between items-center p-2 border-b">
                    <div class="flex-1">
                        <h5 class="font-medium">${item.name}</h5>
                        <p class="text-sm text-gray-500">${Utils.formatCurrency(item.price)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm btn-outline" onclick="updateCartItemQuantity('${item.id}', -1)">-</button>
                        <span class="px-2">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline" onclick="updateCartItemQuantity('${item.id}', 1)">+</button>
                        <button class="btn btn-sm btn-error" onclick="removeFromCart('${item.id}')">üóë</button>
                    </div>
                </div>
            `).join('');

            const total = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalElement.textContent = Utils.formatCurrency(total);
            checkoutBtn.disabled = false;
        }

        function updateCartItemQuantity(itemId, change) {
            const item = AppState.cart.find(item => item.id === itemId);
            if (!item) return;

            item.quantity += change;

            if (item.quantity <= 0) {
                removeFromCart(itemId);
            } else {
                updateCartDisplay();
            }
        }

        function removeFromCart(itemId) {
            AppState.cart = AppState.cart.filter(item => item.id !== itemId);
            updateCartDisplay();
        }

        async function editIngredient(ingredientId) {
            try {
                const ingredient = await window.db.findById('ingredients', ingredientId);
                if (!ingredient) return;

                const modalHTML = `
                    <div id="edit-ingredient-modal" class="modal active">
                        <div class="modal-backdrop" onclick="closeEditIngredientModal()"></div>
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                                <button class="modal-close" onclick="closeEditIngredientModal()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-ingredient-form">
                                    <input type="hidden" id="edit-ingredient-id" value="${ingredient.id}">
                                    <div class="form-group">
                                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                                        <input type="text" class="form-input" id="edit-ingredient-name" value="${ingredient.name}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                                        <input type="text" class="form-input" id="edit-ingredient-unit" value="${ingredient.unit}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                                        <input type="number" class="form-input" id="edit-ingredient-cost" value="${ingredient.cost_per_unit}" min="0" step="0.01" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                        <input type="number" class="form-input" id="edit-ingredient-quantity" value="${ingredient.quantity}" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
                                        <input type="number" class="form-input" id="edit-ingredient-min-stock" value="${ingredient.minimum_stock}" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                                        <input type="text" class="form-input" id="edit-ingredient-supplier" value="${ingredient.supplier || ''}">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeEditIngredientModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button type="button" class="btn btn-primary" onclick="saveEditedIngredient()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                console.error('‚ùå Error loading ingredient for edit:', error);
            }
        }

        function closeEditIngredientModal() {
            const modal = document.getElementById('edit-ingredient-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveEditedIngredient() {
            try {
                const id = document.getElementById('edit-ingredient-id').value;
                const ingredient = {
                    name: document.getElementById('edit-ingredient-name').value,
                    unit: document.getElementById('edit-ingredient-unit').value,
                    cost_per_unit: parseFloat(document.getElementById('edit-ingredient-cost').value),
                    quantity: parseInt(document.getElementById('edit-ingredient-quantity').value),
                    minimum_stock: parseInt(document.getElementById('edit-ingredient-min-stock').value),
                    supplier: document.getElementById('edit-ingredient-supplier').value
                };

                await window.db.update('ingredients', id, ingredient);
                showToast('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeEditIngredientModal();
                await loadIngredients();

            } catch (error) {
                console.error('‚ùå Error updating ingredient:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function restockIngredient(ingredientId) {
            try {
                const ingredient = await window.db.findById('ingredients', ingredientId);
                if (!ingredient) return;

                const modalHTML = `
                    <div id="restock-modal" class="modal active">
                        <div class="modal-backdrop" onclick="closeRestockModal()"></div>
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ: ${ingredient.name}</h3>
                                <button class="modal-close" onclick="closeRestockModal()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <form id="restock-form">
                                    <input type="hidden" id="restock-ingredient-id" value="${ingredient.id}">
                                    <div class="form-group">
                                        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                        <input type="number" class="form-input" value="${ingredient.quantity}" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°</label>
                                        <input type="number" class="form-input" id="restock-amount" placeholder="0" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                                        <input type="text" class="form-input" id="restock-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°, ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Ñ">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeRestockModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button type="button" class="btn btn-primary" onclick="confirmRestock()">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                console.error('‚ùå Error loading ingredient for restock:', error);
            }
        }

        function closeRestockModal() {
            const modal = document.getElementById('restock-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function confirmRestock() {
            try {
                const ingredientId = document.getElementById('restock-ingredient-id').value;
                const additionalAmount = parseInt(document.getElementById('restock-amount').value);
                const note = document.getElementById('restock-note').value;

                if (!additionalAmount || additionalAmount <= 0) {
                    showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }

                const ingredient = await window.db.findById('ingredients', ingredientId);
                const newQuantity = ingredient.quantity + additionalAmount;

                await window.db.update('ingredients', ingredientId, {
                    quantity: newQuantity
                });

                // Record transaction
                await window.db.create('transactions', {
                    type: 'restock',
                    item_id: ingredientId,
                    item_name: ingredient.name,
                    quantity: additionalAmount,
                    note: note,
                    created_at: new Date().toISOString()
                });

                showToast(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ ${ingredient.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
                closeRestockModal();
                await loadIngredients();

            } catch (error) {
                console.error('‚ùå Error restocking ingredient:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Customer Functions
        function loadCustomers() {
            if (AppState.customers.length === 0) {
                // Initialize with sample customers
                AppState.customers = [
                    {
                        id: '1',
                        name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
                        phone: '081-234-5678',
                        email: 'somchai@email.com',
                        points: 150,
                        totalSpent: 1250,
                        visits: 25,
                        joinDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                        lastVisit: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
                    },
                    {
                        id: '2',
                        name: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                        phone: '082-345-6789',
                        email: 'somying@email.com',
                        points: 89,
                        totalSpent: 890,
                        visits: 18,
                        joinDate: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString(),
                        lastVisit: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
                    }
                ];
            }
            renderCustomers();
        }

        function renderCustomers(searchTerm = '') {
            const container = document.getElementById('customer-list');
            if (!container) return;

            const filteredCustomers = AppState.customers.filter(customer =>
                customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                customer.phone.includes(searchTerm)
            );

            container.innerHTML = filteredCustomers.map(customer => `
                <div class="customer-card" onclick="selectCustomer('${customer.id}')">
                    <div class="customer-header">
                        <div class="customer-info">
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-contact">${customer.phone}</div>
                            ${customer.email ? `<div class="customer-contact">${customer.email}</div>` : ''}
                        </div>
                        <div class="customer-stats">
                            <div class="stat-item">
                                <div class="stat-value">${customer.points}</div>
                                <div class="stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                            </div>
                        </div>
                    </div>
                    <div class="customer-footer">
                        <div class="customer-badges">
                            <div class="badge badge-primary">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏° ${customer.visits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                            <div class="badge badge-secondary">${Utils.formatCurrency(customer.totalSpent)}</div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editCustomer('${customer.id}')">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function selectCustomer(customerId) {
            const customer = AppState.customers.find(c => c.id === customerId);
            if (!customer) return;

            AppState.currentCustomer = customer;

            // Update UI to show selected customer
            const customerDisplay = document.getElementById('selected-customer');
            if (customerDisplay) {
                customerDisplay.innerHTML = `
                    <div class="selected-customer-info">
                        <span class="customer-name">${customer.name}</span>
                        <span class="customer-points">${customer.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                        <button class="btn btn-sm btn-secondary" onclick="clearCustomer()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                `;
                customerDisplay.style.display = 'block';
            }

            Toast.show(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${customer.name}`, 'success');

            // Auto switch back to POS if on customer screen
            if (AppState.currentScreen === 'customer-screen') {
                switchScreen('pos-screen');
            }
        }

        function clearCustomer() {
            AppState.currentCustomer = null;
            const customerDisplay = document.getElementById('selected-customer');
            if (customerDisplay) {
                customerDisplay.style.display = 'none';
            }
            Toast.show('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'info');
        }

        function showAddCustomerModal() {
            const modal = document.getElementById('add-customer-modal');
            if (!modal) {
                console.error('Customer modal not found');
                return;
            }
            modal.classList.add('active');

            const form = document.getElementById('customer-form');
            if (form) {
                form.reset();
            }

            const customerIdField = document.getElementById('customer-id');
            if (customerIdField) {
                customerIdField.value = '';
            }

            const title = document.querySelector('#add-customer-modal .modal-title');
            if (title) {
                title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
            }
        }

        function editCustomer(customerId) {
            const customer = AppState.customers.find(c => c.id === customerId);
            if (!customer) return;

            document.getElementById('customer-modal').classList.add('active');
            document.getElementById('customer-id').value = customer.id;
            document.getElementById('customer-name').value = customer.name;
            document.getElementById('customer-phone').value = customer.phone;
            document.getElementById('customer-email').value = customer.email || '';
            document.querySelector('#customer-modal .modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
        }

        function closeCustomerModal() {
            document.getElementById('customer-modal').classList.remove('active');
        }

        function saveCustomer() {
            const form = document.getElementById('customer-form');
            const formData = new FormData(form);

            const customerData = {
                name: formData.get('name').trim(),
                phone: formData.get('phone').trim(),
                email: formData.get('email').trim()
            };

            // Validation
            if (!customerData.name || !customerData.phone) {
                Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', 'error');
                return;
            }

            const customerId = document.getElementById('customer-id').value;

            if (customerId) {
                // Edit existing customer
                const customerIndex = AppState.customers.findIndex(c => c.id === customerId);
                if (customerIndex > -1) {
                    AppState.customers[customerIndex] = {
                        ...AppState.customers[customerIndex],
                        ...customerData
                    };
                    Toast.show('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            } else {
                // Add new customer
                const newCustomer = {
                    id: Utils.generateId(),
                    ...customerData,
                    points: 0,
                    totalSpent: 0,
                    visits: 0,
                    joinDate: new Date().toISOString(),
                    lastVisit: null
                };

                AppState.customers.push(newCustomer);
                Toast.show('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }

            closeCustomerModal();
            renderCustomers();
        }

        function deleteCustomer(customerId) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            const customerIndex = AppState.customers.findIndex(c => c.id === customerId);
            if (customerIndex > -1) {
                AppState.customers.splice(customerIndex, 1);
                renderCustomers();
                Toast.show('‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        // Inventory Functions
        function loadInventory() {
            if (AppState.inventory.length === 0) {
                // Initialize with sample inventory
                AppState.inventory = [
                    {
                        id: '1',
                        name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä',
                        category: 'ingredient',
                        unit: '‡πÅ‡∏û‡πá‡∏Ñ',
                        currentStock: 15,
                        minStock: 5,
                        maxStock: 50,
                        costPrice: 35,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà A',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: '‡∏´‡∏°‡∏π‡πÅ‡∏Æ‡∏°',
                        category: 'ingredient',
                        unit: '‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°',
                        currentStock: 3.5,
                        minStock: 1,
                        maxStock: 10,
                        costPrice: 180,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏î B',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '3',
                        name: '‡πÑ‡∏Å‡πà‡∏™‡πÑ‡∏•‡∏ã‡πå',
                        category: 'ingredient',
                        unit: '‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°',
                        currentStock: 2,
                        minStock: 1,
                        maxStock: 8,
                        costPrice: 150,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏î B',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '4',
                        name: '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î',
                        category: 'ingredient',
                        unit: '‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°',
                        currentStock: 1.2,
                        minStock: 0.5,
                        maxStock: 5,
                        costPrice: 40,
                        supplier: '‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î C',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '5',
                        name: '‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤',
                        category: 'beverage',
                        unit: '‡∏Ç‡∏ß‡∏î',
                        currentStock: 48,
                        minStock: 12,
                        maxStock: 100,
                        costPrice: 5,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡πâ‡∏≥‡πÅ‡∏£‡πà D',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '6',
                        name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏Å‡πä‡∏™',
                        category: 'beverage',
                        unit: '‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á',
                        currentStock: 24,
                        minStock: 6,
                        maxStock: 60,
                        costPrice: 8,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° E',
                        lastUpdated: new Date().toISOString()
                    }
                ];
            }
            renderInventory();
        }

        function renderInventory(searchTerm = '') {
            const container = document.getElementById('inventory-list');
            if (!container) return;

            const filteredItems = AppState.inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.category.toLowerCase().includes(searchTerm.toLowerCase())
            );

            container.innerHTML = filteredItems.map(item => {
                const stockLevel = getStockLevel(item);
                const stockClass = stockLevel === 'low' ? 'text-red-500' :
                                 stockLevel === 'medium' ? 'text-yellow-500' : 'text-green-500';

                return `
                    <div class="inventory-item">
                        <div class="inventory-header">
                            <div class="inventory-info">
                                <div class="inventory-name">${item.name}</div>
                                <div class="inventory-details">
                                    <span class="badge badge-secondary">${item.category}</span>
                                    <span class="text-gray-500">${item.supplier}</span>
                                </div>
                            </div>
                            <div class="inventory-actions">
                                <button class="btn btn-sm btn-secondary" onclick="editInventoryItem('${item.id}')">
                                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                            </div>
                        </div>
                        <div class="inventory-stats">
                            <div class="stat-group">
                                <div class="stat-item">
                                    <div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                                    <div class="stat-value ${stockClass}">${item.currentStock} ${item.unit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
                                    <div class="stat-value">${Utils.formatCurrency(item.costPrice)}</div>
                                </div>
                            </div>
                            <div class="inventory-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill ${stockLevel}" style="width: ${(item.currentStock / item.maxStock) * 100}%"></div>
                                </div>
                                <div class="progress-labels">
                                    <span>‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: ${item.minStock}</span>
                                    <span>‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${item.maxStock}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show low stock alerts
            const lowStockItems = AppState.inventory.filter(item => getStockLevel(item) === 'low');
            if (lowStockItems.length > 0) {
                const alertContainer = document.getElementById('stock-alerts');
                if (alertContainer) {
                    alertContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î:</strong>
                            ${lowStockItems.map(item => `${item.name} (${item.currentStock} ${item.unit})`).join(', ')}
                        </div>
                    `;
                }
            }
        }

        function getStockLevel(item) {
            const ratio = item.currentStock / item.minStock;
            if (ratio <= 1) return 'low';
            if (ratio <= 2) return 'medium';
            return 'high';
        }

        function showAddInventoryModal() {
            document.getElementById('inventory-modal').classList.add('active');
            document.getElementById('inventory-form').reset();
            document.getElementById('inventory-id').value = '';
            document.querySelector('#inventory-modal .modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
        }

        function editInventoryItem(itemId) {
            const item = AppState.inventory.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('inventory-modal').classList.add('active');
            document.getElementById('inventory-id').value = item.id;
            document.getElementById('inventory-name').value = item.name;
            document.getElementById('inventory-category').value = item.category;
            document.getElementById('inventory-unit').value = item.unit;
            document.getElementById('inventory-current-stock').value = item.currentStock;
            document.getElementById('inventory-min-stock').value = item.minStock;
            document.getElementById('inventory-max-stock').value = item.maxStock;
            document.getElementById('inventory-cost-price').value = item.costPrice;
            document.getElementById('inventory-supplier').value = item.supplier;
            document.querySelector('#inventory-modal .modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
        }

        function closeInventoryModal() {
            document.getElementById('inventory-modal').classList.remove('active');
        }

        function saveInventoryItem() {
            const form = document.getElementById('inventory-form');
            const formData = new FormData(form);

            const itemData = {
                name: formData.get('name').trim(),
                category: formData.get('category').trim(),
                unit: formData.get('unit').trim(),
                currentStock: parseFloat(formData.get('currentStock')) || 0,
                minStock: parseFloat(formData.get('minStock')) || 0,
                maxStock: parseFloat(formData.get('maxStock')) || 0,
                costPrice: parseFloat(formData.get('costPrice')) || 0,
                supplier: formData.get('supplier').trim(),
                lastUpdated: new Date().toISOString()
            };

            // Validation
            if (!itemData.name || !itemData.unit) {
                Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢', 'error');
                return;
            }

            const itemId = document.getElementById('inventory-id').value;

            if (itemId) {
                // Edit existing item
                const itemIndex = AppState.inventory.findIndex(i => i.id === itemId);
                if (itemIndex > -1) {
                    AppState.inventory[itemIndex] = {
                        ...AppState.inventory[itemIndex],
                        ...itemData
                    };
                    Toast.show('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            } else {
                // Add new item
                const newItem = {
                    id: Utils.generateId(),
                    ...itemData
                };

                AppState.inventory.push(newItem);
                Toast.show('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }

            closeInventoryModal();
            renderInventory();
        }
        async function loadDashboard() {
            if (!window.db || !window.db.isReady) {
                console.log('‚è≥ Database not ready yet, retrying...');
                setTimeout(loadDashboard, 1000);
                return;
            }

            try {
                // Get dashboard data from local database
                const dashboardData = await window.db.getDashboardData();

                // Update UI elements
                document.getElementById('today-sales').textContent = Utils.formatCurrency(dashboardData.todaySales);
                document.getElementById('today-orders').textContent = dashboardData.salesCount.toString();
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('th-TH');

                // Update low stock alerts
                if (dashboardData.lowStockCount > 0) {
                    showToast(`‚ö†Ô∏è ‡∏°‡∏µ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ${dashboardData.lowStockCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
                }

                // Load sales chart with real data
                loadSalesChart();

                console.log('‚úÖ Dashboard loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading dashboard:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function loadSalesChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (AppState.dashboardChart) {
                AppState.dashboardChart.destroy();
            }

            // Generate sample data for last 7 days
            const labels = [];
            const data = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' }));

                // Sample data - replace with real data
                data.push(Math.floor(Math.random() * 5000) + 1000);
            }

            AppState.dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: data,
                        borderColor: '#0c8ce9',
                        backgroundColor: 'rgba(12, 140, 233, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utils.formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // POS Functions
        function loadMenu() {
            if (AppState.menuItems.length === 0) {
                // Initialize with sample menu items
                AppState.menuItems = [
                    { id: '1', name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏´‡∏°‡∏π', price: 35, cost: 20, category: 'sandwich', image: 'ü•™', description: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏´‡∏°‡∏π‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ú‡∏±‡∏Å' },
                    { id: '2', name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà', price: 40, cost: 22, category: 'sandwich', image: 'ü•™', description: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏ó‡∏≠‡∏£‡∏¥‡∏¢‡∏≤‡∏Å‡∏¥' },
                    { id: '3', name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Ç‡πà', price: 25, cost: 12, category: 'sandwich', image: 'ü•™', description: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ú‡∏±‡∏Å‡∏™‡∏î' },
                    { id: '4', name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤', price: 45, cost: 25, category: 'sandwich', image: 'ü•™', description: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤‡∏ú‡∏™‡∏°‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™' },
                    { id: '5', name: '‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤', price: 10, cost: 5, category: 'drink', image: 'üíß', description: '‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°‡∏Ç‡∏ß‡∏î 600ml' },
                    { id: '6', name: '‡πÇ‡∏Ñ‡πâ‡∏Å', price: 15, cost: 8, category: 'drink', image: 'ü•§', description: '‡πÇ‡∏Ñ‡πâ‡∏Å‡πÄ‡∏¢‡πá‡∏ô‡∏Ç‡∏ß‡∏î 325ml' },
                    { id: '7', name: '‡∏Å‡∏≤‡πÅ‡∏ü', price: 20, cost: 8, category: 'drink', image: '‚òï', description: '‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏≥‡∏£‡πâ‡∏≠‡∏ô' },
                    { id: '8', name: '‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô', price: 18, cost: 7, category: 'drink', image: 'üßä', description: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏¢‡πá‡∏ô‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô' }
                ];
            }

            renderMenu();
        }

        function renderMenu(searchTerm = '') {
            const container = document.getElementById('menu-container');
            const filteredItems = AppState.menuItems.filter(item =>
                item.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            container.innerHTML = filteredItems.map(item => `
                <div class="menu-item" onclick="addToCart('${item.id}')">
                    <div class="menu-item-image">${item.image}</div>
                    <div class="menu-item-name">${item.name}</div>
                    <div class="menu-item-price">${Utils.formatCurrency(item.price)}</div>
                    <div class="text-xs text-gray-500 mt-1">${item.description || ''}</div>
                </div>
            `).join('');
        }

        function addToCart(itemId) {
            const item = AppState.menuItems.find(item => item.id === itemId);
            if (!item) return;

            const existingItem = AppState.cart.find(cartItem => cartItem.id === itemId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                AppState.cart.push({ ...item, quantity: 1 });
            }

            updateCart();
            Toast.show(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${item.name} ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        }

        function removeFromCart(itemId) {
            const itemIndex = AppState.cart.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                const item = AppState.cart[itemIndex];
                if (item.quantity > 1) {
                    item.quantity -= 1;
                } else {
                    AppState.cart.splice(itemIndex, 1);
                }
                updateCart();
            }
        }

        function updateCart() {
            const container = document.getElementById('cart-items');
            const totalElement = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (AppState.cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
                totalElement.textContent = Utils.formatCurrency(0);
                checkoutBtn.disabled = true;
                return;
            }

            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * (AppState.settings.taxRate / 100);
            const total = subtotal + tax;

            container.innerHTML = AppState.cart.map(item => `
                <div class="flex items-center justify-between py-2 border-b border-gray-100">
                    <div class="flex-1">
                        <div class="font-medium">${item.name}</div>
                        <div class="text-sm text-gray-500">${Utils.formatCurrency(item.price)} √ó ${item.quantity}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm btn-secondary" onclick="removeFromCart('${item.id}')">-</button>
                        <span class="font-medium">${Utils.formatCurrency(item.price * item.quantity)}</span>
                    </div>
                </div>
            `).join('');

            // Add tax info if applicable
            if (AppState.settings.taxRate > 0) {
                container.innerHTML += `
                    <div class="pt-2 mt-2 border-t border-gray-200">
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                            <span>${Utils.formatCurrency(subtotal)}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>‡∏†‡∏≤‡∏©‡∏µ (${AppState.settings.taxRate}%):</span>
                            <span>${Utils.formatCurrency(tax)}</span>
                        </div>
                    </div>
                `;
            }

            totalElement.textContent = Utils.formatCurrency(total);
            checkoutBtn.disabled = false;
        }

        function processPayment() {
            if (AppState.cart.length === 0) return;

            // Show payment modal instead of immediate processing
            showPaymentModal();
        }

        function showPaymentModal() {
            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * (AppState.settings.taxRate / 100);
            const total = subtotal + tax;

            document.getElementById('payment-total').textContent = Utils.formatCurrency(total);
            document.getElementById('payment-modal').classList.add('active');

            // Reset payment form
            selectPaymentMethod('cash');
            document.getElementById('cash-received').value = '';
            document.getElementById('change-amount').textContent = Utils.formatCurrency(0);
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.remove('active');
        }

        function selectPaymentMethod(method) {
            // Update UI
            document.querySelectorAll('.payment-method').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');

            // Show/hide payment sections
            document.querySelectorAll('.payment-section').forEach(section => {
                section.classList.remove('active');
            });

            if (method === 'cash') {
                document.getElementById('cash-payment').classList.add('active');
            }

            AppState.currentPaymentMethod = method;
        }

        function calculateChange() {
            const total = parseFloat(document.getElementById('payment-total').textContent.replace(/[^0-9.-]+/g, ''));
            const received = parseFloat(document.getElementById('cash-received').value) || 0;
            const change = Math.max(0, received - total);

            document.getElementById('change-amount').textContent = Utils.formatCurrency(change);
        }

        function toggleDiscount() {
            const checkbox = document.getElementById('apply-discount');
            const section = document.getElementById('discount-section');

            if (checkbox.checked) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
                applyDiscount(); // Reset discount
            }
        }

        function applyDiscount() {
            const checkbox = document.getElementById('apply-discount');
            if (!checkbox.checked) return;

            const discountAmount = parseFloat(document.getElementById('discount-amount').value) || 0;
            const discountType = document.getElementById('discount-type').value;
            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            let discount = 0;
            if (discountType === 'percent') {
                discount = subtotal * (discountAmount / 100);
            } else {
                discount = discountAmount;
            }

            const tax = (subtotal - discount) * (AppState.settings.taxRate / 100);
            const total = Math.max(0, subtotal - discount + tax);

            document.getElementById('payment-total').textContent = Utils.formatCurrency(total);
            calculateChange();
        }

        function confirmPayment() {
            const total = parseFloat(document.getElementById('payment-total').textContent.replace(/[^0-9.-]+/g, ''));
            const paymentMethod = AppState.currentPaymentMethod || 'cash';

            // Validate payment
            if (paymentMethod === 'cash') {
                const received = parseFloat(document.getElementById('cash-received').value) || 0;
                if (received < total) {
                    Toast.show('‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error');
                    return;
                }
            }

            const sale = {
                id: Utils.generateId(),
                items: [...AppState.cart],
                subtotal: AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                tax: total - AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                discount: 0, // Calculate from form if needed
                total: total,
                paymentMethod: paymentMethod,
                customerId: AppState.currentCustomer?.id || null,
                date: new Date().toISOString(),
                cashReceived: paymentMethod === 'cash' ? parseFloat(document.getElementById('cash-received').value) || 0 : total,
                change: paymentMethod === 'cash' ? Math.max(0, (parseFloat(document.getElementById('cash-received').value) || 0) - total) : 0
            };

            // Add loyalty points if customer is selected
            if (AppState.currentCustomer && AppState.settings.loyaltyPoints.enabled) {
                const pointsEarned = Math.floor(total * AppState.settings.loyaltyPoints.rate);
                AppState.currentCustomer.points = (AppState.currentCustomer.points || 0) + pointsEarned;

                if (pointsEarned > 0) {
                    Toast.show(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${pointsEarned} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, 'success');
                }
            }

            AppState.sales.push(sale);
            AppState.cart = [];
            AppState.currentCustomer = null;

            updateCart();
            closePaymentModal();

            Toast.show(`‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${Utils.formatCurrency(total)}`, 'success');

            // Print receipt (simulated)
            printReceipt(sale);

            // Auto switch to dashboard after payment
            setTimeout(() => {
                switchScreen('dashboard-screen');
            }, 2000);
        }

        function printReceipt(sale) {
            console.log('=== ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ===');
            console.log(`‡∏£‡πâ‡∏≤‡∏ô: ${AppState.settings.shopName}`);
            console.log(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${Utils.formatDate(new Date(sale.date))}`);
            console.log(`‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: ${sale.id}`);
            console.log('========================');

            sale.items.forEach(item => {
                console.log(`${item.name} x${item.quantity} = ${Utils.formatCurrency(item.price * item.quantity)}`);
            });

            console.log('========================');
            console.log(`‡∏£‡∏ß‡∏°: ${Utils.formatCurrency(sale.subtotal)}`);
            if (sale.tax > 0) {
                console.log(`‡∏†‡∏≤‡∏©‡∏µ: ${Utils.formatCurrency(sale.tax)}`);
            }
            console.log(`‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ${Utils.formatCurrency(sale.total)}`);
            console.log(`‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${getPaymentMethodLabel(sale.paymentMethod)}`);
            if (sale.paymentMethod === 'cash') {
                console.log(`‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: ${Utils.formatCurrency(sale.cashReceived)}`);
                console.log(`‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${Utils.formatCurrency(sale.change)}`);
            }
            console.log('========================');
            console.log('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£');
        }

        function getPaymentMethodLabel(method) {
            const labels = {
                cash: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
                card: '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï/‡πÄ‡∏î‡∏ö‡∏¥‡∏ï',
                transfer: '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
                qr: 'QR Code'
            };
            return labels[method] || method;
        }

        // Dashboard Functions
        function updateDashboard() {
            // Calculate today's sales
            const today = new Date().toDateString();
            const todaySales = AppState.sales.filter(sale =>
                new Date(sale.date).toDateString() === today
            );

            const todayRevenue = todaySales.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            const todayTransactions = todaySales.length;
            const todayProfit = todaySales.reduce((sum, sale) => {
                const saleProfit = (sale.items || []).reduce((itemSum, item) => {
                    const menuItem = AppState.menuItems.find(mi => mi.id === item.id);
                    const profit = menuItem ? (menuItem.price - (menuItem.cost || 0)) * item.quantity : 0;
                    return itemSum + profit;
                }, 0);
                return sum + saleProfit;
            }, 0);

            // Update dashboard cards
            const revenueElement = document.getElementById('today-revenue');
            const transactionsElement = document.getElementById('today-transactions');
            const profitElement = document.getElementById('today-profit');
            const avgSaleElement = document.getElementById('avg-sale');

            if (revenueElement) revenueElement.textContent = Utils.formatCurrency(todayRevenue);
            if (transactionsElement) transactionsElement.textContent = todayTransactions;
            if (profitElement) profitElement.textContent = Utils.formatCurrency(todayProfit);
            if (avgSaleElement) {
                const avgSale = todayTransactions > 0 ? todayRevenue / todayTransactions : 0;
                avgSaleElement.textContent = Utils.formatCurrency(avgSale);
            }

            // Check for low stock alerts
            const lowStockItems = AppState.inventory.filter(item => getStockLevel(item) === 'low');
            const alertContainer = document.getElementById('dashboard-alerts');
            if (alertContainer) {
                if (lowStockItems.length > 0) {
                    alertContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ${lowStockItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</strong>
                            ${lowStockItems.slice(0, 3).map(item => item.name).join(', ')}
                            ${lowStockItems.length > 3 ? ` ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${lowStockItems.length - 3} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : ''}
                        </div>
                    `;
                } else {
                    alertContainer.innerHTML = '';
                }
            }

            // Load recent sales
            loadRecentSales();
        }

        function loadRecentSales() {
            const recentSales = AppState.sales
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            const container = document.getElementById('recent-sales');
            if (!container) return;

            if (recentSales.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>';
                return;
            }

            container.innerHTML = recentSales.map(sale => {
                const itemCount = (sale.items || []).reduce((sum, item) => sum + item.quantity, 0);
                const total = sale.total || sale.amount || 0;

                return `
                    <div class="sale-item">
                        <div class="sale-info">
                            <div class="sale-id">#${sale.id.substr(-6)}</div>
                            <div class="sale-details">
                                ${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${getPaymentMethodLabel(sale.paymentMethod || 'cash')}
                            </div>
                            <div class="sale-time">${Utils.formatTime(new Date(sale.date))}</div>
                        </div>
                        <div class="sale-amount">${Utils.formatCurrency(total)}</div>
                    </div>
                `;
            }).join('');
        }

        // Reports Functions
        function updateReports() {
            updateSalesChart();
            updateTopProductsChart();
            updateProfitAnalysis();
            updateCustomerAnalytics();
        }

        function updateSalesChart() {
            const canvas = document.getElementById('sales-chart');
            if (!canvas) return;

            // Get last 7 days data
            const last7Days = [];
            const salesData = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toDateString();

                const daysSales = AppState.sales
                    .filter(sale => new Date(sale.date).toDateString() === dateString)
                    .reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);

                last7Days.push(date.toLocaleDateString('th-TH', { weekday: 'short' }));
                salesData.push(daysSales);
            }

            if (AppState.salesChart) {
                AppState.salesChart.destroy();
            }

            const ctx = canvas.getContext('2d');
            AppState.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: salesData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utils.formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTopProductsChart() {
            const canvas = document.getElementById('products-chart');
            if (!canvas) return;

            // Calculate product sales
            const productSales = {};
            AppState.sales.forEach(sale => {
                (sale.items || []).forEach(item => {
                    if (productSales[item.name]) {
                        productSales[item.name] += item.quantity;
                    } else {
                        productSales[item.name] = item.quantity;
                    }
                });
            });

            const sortedProducts = Object.entries(productSales)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            if (sortedProducts.length === 0) return;

            if (AppState.productsChart) {
                AppState.productsChart.destroy();
            }

            const ctx = canvas.getContext('2d');
            AppState.productsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedProducts.map(([name]) => name),
                    datasets: [{
                        data: sortedProducts.map(([, quantity]) => quantity),
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function updateProfitAnalysis() {
            const container = document.getElementById('profit-analysis');
            if (!container) return;

            // Calculate profit for last 30 days
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const recentSales = AppState.sales.filter(sale => new Date(sale.date) >= thirtyDaysAgo);

            let totalRevenue = 0;
            let totalCost = 0;
            let totalProfit = 0;

            recentSales.forEach(sale => {
                const saleRevenue = sale.total || sale.amount || 0;
                totalRevenue += saleRevenue;

                const saleCost = (sale.items || []).reduce((sum, item) => {
                    const menuItem = AppState.menuItems.find(mi => mi.id === item.id);
                    const itemCost = menuItem ? (menuItem.cost || 0) * item.quantity : 0;
                    return sum + itemCost;
                }, 0);
                totalCost += saleCost;
            });

            totalProfit = totalRevenue - totalCost;
            const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;

            container.innerHTML = `
                <div class="profit-stats">
                    <div class="profit-card">
                        <div class="profit-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (30 ‡∏ß‡∏±‡∏ô)</div>
                        <div class="profit-value positive">${Utils.formatCurrency(totalRevenue)}</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div>
                        <div class="profit-value negative">${Utils.formatCurrency(totalCost)}</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                        <div class="profit-value ${totalProfit >= 0 ? 'positive' : 'negative'}">
                            ${Utils.formatCurrency(totalProfit)}
                        </div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</div>
                        <div class="profit-value ${profitMargin >= 0 ? 'positive' : 'negative'}">
                            ${profitMargin.toFixed(1)}%
                        </div>
                    </div>
                </div>
            `;
        }

        function updateCustomerAnalytics() {
            const container = document.getElementById('customer-analytics');
            if (!container) return;

            const totalCustomers = AppState.customers.length;
            const activeCustomers = AppState.customers.filter(c =>
                new Date(c.lastVisit || 0) >= new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
            ).length;

            const avgSpending = totalCustomers > 0 ?
                AppState.customers.reduce((sum, c) => sum + (c.totalSpent || 0), 0) / totalCustomers : 0;

            const totalLoyaltyPoints = AppState.customers.reduce((sum, c) => sum + (c.points || 0), 0);

            // Top customers by spending
            const topCustomers = AppState.customers
                .sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0))
                .slice(0, 5);

            container.innerHTML = `
                <div class="customer-stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalCustomers}</div>
                        <div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${activeCustomers}</div>
                        <div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (30 ‡∏ß‡∏±‡∏ô)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Utils.formatCurrency(avgSpending)}</div>
                        <div class="stat-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalLoyaltyPoints}</div>
                        <div class="stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°</div>
                    </div>
                </div>

                <div class="top-customers">
                    <h4 class="mb-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≥</h4>
                    ${topCustomers.map((customer, index) => `
                        <div class="top-customer-item">
                            <div class="customer-rank">${index + 1}</div>
                            <div class="customer-info">
                                <div class="customer-name">${customer.name}</div>
                                <div class="customer-stats">
                                    ${Utils.formatCurrency(customer.totalSpent || 0)} ‚Ä¢ ${customer.visits || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                                </div>
                            </div>
                            <div class="customer-points">${customer.points || 0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Inventory Functions
        function loadInventory() {
            if (AppState.inventory.length === 0) {
                // Initialize with sample inventory
                AppState.inventory = [
                    { id: '1', name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', stock: 50, unit: '‡πÅ‡∏ú‡πà‡∏ô', price: 2 },
                    { id: '2', name: '‡∏´‡∏°‡∏π‡∏´‡∏±‡πà‡∏ô', stock: 20, unit: '‡∏Å‡∏Å.', price: 180 },
                    { id: '3', name: '‡πÑ‡∏Å‡πà‡∏´‡∏±‡πà‡∏ô', stock: 15, unit: '‡∏Å‡∏Å.', price: 120 },
                    { id: '4', name: '‡πÑ‡∏Ç‡πà', stock: 30, unit: '‡∏ü‡∏≠‡∏á', price: 4 },
                    { id: '5', name: '‡∏ó‡∏π‡∏ô‡πà‡∏≤', stock: 10, unit: '‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á', price: 25 }
                ];
            }

            renderInventory();
        }

        function renderInventory(searchTerm = '') {
            const container = document.getElementById('inventory-container');
            const filteredItems = AppState.inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            container.innerHTML = filteredItems.map(item => `
                <div class="card">
                    <div class="card-body">
                        <h4 class="font-semibold mb-2">${item.name}</h4>
                        <div class="text-sm text-gray-500 mb-2">
                            <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.stock} ${item.unit}</div>
                            <div>‡∏£‡∏≤‡∏Ñ‡∏≤: ${Utils.formatCurrency(item.price)}/${item.unit}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-secondary flex-1" onclick="adjustStock('${item.id}', -1)">
                                ‡∏•‡∏î
                            </button>
                            <button class="btn btn-sm btn-primary flex-1" onclick="adjustStock('${item.id}', 1)">
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function adjustStock(itemId, change) {
            const item = AppState.inventory.find(item => item.id === itemId);
            if (item) {
                item.stock = Math.max(0, item.stock + change);
                renderInventory();
                Toast.show(`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Ñ ${item.name} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            }
        }

        // Ingredients Management Functions
        async function loadIngredients() {
            try {
                if (!window.db || !window.db.isReady) {
                    console.log('‚è≥ Database not ready for ingredients, retrying...');
                    setTimeout(loadIngredients, 1000);
                    return;
                }

                const ingredients = await window.db.getInventoryItems();
                const container = document.getElementById('ingredients-container');

                if (!container) return;

                container.innerHTML = ingredients.map(ingredient => `
                    <div class="card" data-ingredient-id="${ingredient.id}">
                        <div class="card-body">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-lg font-semibold">${ingredient.name}</h4>
                                    <p class="text-sm text-gray-500 mb-2">${ingredient.supplier || ''}</p>
                                    <div class="flex gap-4 text-sm mb-2">
                                        <span class="text-blue-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${ingredient.quantity} ${ingredient.unit}</span>
                                        <span class="text-green-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${Utils.formatCurrency(ingredient.cost_per_unit)}/${ingredient.unit}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        ${ingredient.quantity <= ingredient.minimum_stock ? '<span class="badge badge-error">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏ï‡πà‡∏≥</span>' : ''}
                                        ${ingredient.quantity === 0 ? '<span class="badge badge-error">‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</span>' : ''}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-secondary" onclick="editIngredient('${ingredient.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button class="btn btn-sm btn-primary" onclick="restockIngredient('${ingredient.id}')">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Error loading ingredients:', error);
            }
        }

        async function showAddIngredientModal() {
            // Similar to menu item modal but for ingredients
            const modalHTML = `
                <div id="add-ingredient-modal" class="modal active">
                    <div class="modal-backdrop" onclick="closeAddIngredientModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
                            <button class="modal-close" onclick="closeAddIngredientModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <form id="add-ingredient-form">
                                <div class="form-group">
                                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                                    <input type="text" class="form-input" id="ingredient-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏Ç‡∏≤‡∏ß" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                                    <input type="text" class="form-input" id="ingredient-unit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ú‡πà‡∏ô, ‡∏Å‡∏£‡∏±‡∏°" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" class="form-input" id="ingredient-cost" placeholder="2.00" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                    <input type="number" class="form-input" id="ingredient-quantity" placeholder="100" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
                                    <input type="number" class="form-input" id="ingredient-min-stock" placeholder="10" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                                    <input type="text" class="form-input" id="ingredient-supplier" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddIngredientModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="button" class="btn btn-primary" onclick="saveIngredient()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeAddIngredientModal() {
            const modal = document.getElementById('add-ingredient-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveIngredient() {
            try {
                const ingredient = {
                    name: document.getElementById('ingredient-name').value,
                    unit: document.getElementById('ingredient-unit').value,
                    cost_per_unit: parseFloat(document.getElementById('ingredient-cost').value),
                    quantity: parseInt(document.getElementById('ingredient-quantity').value),
                    minimum_stock: parseInt(document.getElementById('ingredient-min-stock').value),
                    supplier: document.getElementById('ingredient-supplier').value,
                    category: 'general'
                };

                await window.db.create('ingredients', ingredient);
                showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeAddIngredientModal();
                await loadIngredients();

            } catch (error) {
                console.error('‚ùå Error saving ingredient:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function filterIngredients() {
            const searchTerm = document.getElementById('ingredient-search').value.toLowerCase();
            const statusFilter = document.getElementById('ingredient-status-filter').value;
            const ingredientCards = document.querySelectorAll('#ingredients-container .card');

            ingredientCards.forEach(card => {
                const ingredientName = card.querySelector('h4').textContent.toLowerCase();
                const hasLowStockBadge = card.querySelector('.badge-error');

                const matchesSearch = ingredientName.includes(searchTerm);
                let matchesStatus = true;

                if (statusFilter === 'low_stock') {
                    matchesStatus = hasLowStockBadge !== null;
                } else if (statusFilter === 'out_of_stock') {
                    matchesStatus = hasLowStockBadge && hasLowStockBadge.textContent.includes('‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Ñ');
                } else if (statusFilter === 'in_stock') {
                    matchesStatus = hasLowStockBadge === null;
                }

                card.style.display = matchesSearch && matchesStatus ? 'block' : 'none';
            });
        }

        // Reports Functions
        function loadReports() {
            loadSalesReport();
            loadTopProducts();
        }

        function loadSalesReport() {
            const ctx = document.getElementById('salesReportChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (AppState.salesReportChart) {
                AppState.salesReportChart.destroy();
            }

            // Sample monthly data
            const monthlyData = [
                { month: '‡∏°.‡∏Ñ.', sales: 45000 },
                { month: '‡∏Å.‡∏û.', sales: 52000 },
                { month: '‡∏°‡∏µ.‡∏Ñ.', sales: 48000 },
                { month: '‡πÄ‡∏°.‡∏¢.', sales: 61000 },
                { month: '‡∏û.‡∏Ñ.', sales: 58000 },
                { month: '‡∏°‡∏¥.‡∏¢.', sales: 67000 }
            ];

            AppState.salesReportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(d => d.month),
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: monthlyData.map(d => d.sales),
                        backgroundColor: '#0c8ce9',
                        borderColor: '#0159a2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utils.formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadTopProducts() {
            const container = document.getElementById('top-products-list');
            const topProducts = [
                { name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏´‡∏°‡∏π', sales: 156, revenue: 5460 },
                { name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà', sales: 134, revenue: 5360 },
                { name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤', sales: 89, revenue: 4005 },
                { name: '‡∏Å‡∏≤‡πÅ‡∏ü', sales: 203, revenue: 4060 },
                { name: '‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô', sales: 167, revenue: 3006 }
            ];

            container.innerHTML = topProducts.map((product, index) => `
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-semibold">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium">${product.name}</div>
                            <div class="text-sm text-gray-500">${product.sales} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-success">${Utils.formatCurrency(product.revenue)}</div>
                    </div>
                </div>
            `).join('');
        }

        function showManageCategoriesModal() {
            // Create and show a modal for managing menu categories
            const modalHTML = `
                <div id="manage-categories-modal" class="modal active">
                    <div class="modal-backdrop" onclick="closeManageCategoriesModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π</h3>
                            <button class="modal-close" onclick="closeManageCategoriesModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</label>
                                <div class="flex gap-2">
                                    <input type="text" class="form-input" id="new-category-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">
                                    <button class="btn btn-primary" onclick="addCategory()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</label>
                                <div id="categories-list" class="space-y-2">
                                    <div class="p-2 border rounded flex justify-between items-center">
                                        <span>‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä</span>
                                        <button class="btn btn-sm btn-error" onclick="removeCategory('‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä')">‡∏•‡∏ö</button>
                                    </div>
                                    <div class="p-2 border rounded flex justify-between items-center">
                                        <span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</span>
                                        <button class="btn btn-sm btn-error" onclick="removeCategory('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°')">‡∏•‡∏ö</button>
                                    </div>
                                    <div class="p-2 border rounded flex justify-between items-center">
                                        <span>‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</span>
                                        <button class="btn btn-sm btn-error" onclick="removeCategory('‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô')">‡∏•‡∏ö</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeManageCategoriesModal()">‡∏õ‡∏¥‡∏î</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeManageCategoriesModal() {
            const modal = document.getElementById('manage-categories-modal');
            if (modal) {
                modal.remove();
            }
        }

        function addCategory() {
            const categoryName = document.getElementById('new-category-name').value.trim();
            if (!categoryName) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
                return;
            }

            // Add to categories list (this is a simple implementation)
            const categoriesList = document.getElementById('categories-list');
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'p-2 border rounded flex justify-between items-center';
            categoryDiv.innerHTML = `
                <span>${categoryName}</span>
                <button class="btn btn-sm btn-error" onclick="removeCategory('${categoryName}')">‡∏•‡∏ö</button>
            `;
            categoriesList.appendChild(categoryDiv);

            document.getElementById('new-category-name').value = '';
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ${categoryName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        }

        function removeCategory(categoryName) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${categoryName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                // Find and remove the category element
                const categoriesList = document.getElementById('categories-list');
                const categoryElements = categoriesList.children;

                for (let i = 0; i < categoryElements.length; i++) {
                    const span = categoryElements[i].querySelector('span');
                    if (span && span.textContent === categoryName) {
                        categoryElements[i].remove();
                        break;
                    }
                }

                showToast(`‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ${categoryName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
            }
        }

        // Modal Functions
        function showExpenseModal() {
            document.getElementById('expense-modal').classList.add('active');
        }

        function closeExpenseModal() {
            document.getElementById('expense-modal').classList.remove('active');
            document.getElementById('expense-form').reset();
        }

        function showSettings() {
            document.getElementById('settings-modal').classList.add('active');

            // Load current settings
            document.getElementById('shop-name').value = AppState.settings.shopName;
            document.getElementById('shop-phone').value = AppState.settings.shopPhone;
            document.getElementById('shop-address').value = AppState.settings.shopAddress;
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            AppState.settings.shopName = document.getElementById('shop-name').value;
            AppState.settings.shopPhone = document.getElementById('shop-phone').value;
            AppState.settings.shopAddress = document.getElementById('shop-address').value;

            closeSettings();
            Toast.show('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function updateLoyaltySettings() {
            try {
                const loyaltyEnabled = document.getElementById('loyalty-enabled')?.checked || false;
                const loyaltyRate = parseFloat(document.getElementById('loyalty-rate')?.value) || 0.01;

                AppState.settings.loyaltyPoints.enabled = loyaltyEnabled;
                AppState.settings.loyaltyPoints.rate = loyaltyRate / 100; // Convert percentage to decimal

                Toast.show('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error('Error updating loyalty settings:', error);
                Toast.show('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function updateSalesReport() {
            try {
                const period = document.getElementById('sales-period')?.value || 'monthly';
                console.log('Updating sales report for period:', period);

                // Refresh the sales report chart with new period
                loadSalesReport();

                Toast.show('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'info');
            } catch (error) {
                console.error('Error updating sales report:', error);
                Toast.show('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize app
            loadDashboard();

            // Menu search
            const menuSearch = document.getElementById('menu-search');
            if (menuSearch) {
                menuSearch.addEventListener('input', Utils.debounce((e) => {
                    renderMenu(e.target.value);
                }, 300));
            }

            // Inventory search
            const inventorySearch = document.getElementById('inventory-search');
            if (inventorySearch) {
                inventorySearch.addEventListener('input', Utils.debounce((e) => {
                    renderInventory(e.target.value);
                }, 300));
            }

            // Expense form
            const expenseForm = document.getElementById('expense-form');
            if (expenseForm) {
                expenseForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const expense = {
                        id: Utils.generateId(),
                        item: document.getElementById('expense-item').value,
                        amount: parseFloat(document.getElementById('expense-amount').value),
                        category: document.getElementById('expense-category').value,
                        notes: document.getElementById('expense-notes').value,
                        date: new Date().toISOString()
                    };

                    AppState.expenses.push(expense);
                    closeExpenseModal();
                    Toast.show(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ${Utils.formatCurrency(expense.amount)} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                });
            }

            // Close modals on backdrop click
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                });
            });

            // Handle back button for SPA navigation
            window.addEventListener('popstate', function() {
                // Handle browser back button if needed
            });

            // Prevent zoom on double tap for iOS
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = new Date().getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // Handle keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // ESC to close modals
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });

            // Comprehensive Button Event Listeners
            // Form Submit Buttons
            const expenseFormSubmit = document.querySelector('#expense-form button[type="submit"]');
            if (expenseFormSubmit) {
                expenseFormSubmit.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('expense-form');
                    if (form) {
                        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                });
            }

            const customerFormSubmit = document.querySelector('#add-customer-form button[type="submit"]');
            if (customerFormSubmit) {
                customerFormSubmit.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('add-customer-form');
                    if (form) {
                        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                });
            }

            const inventoryFormSubmit = document.querySelector('#add-inventory-form button[type="submit"]');
            if (inventoryFormSubmit) {
                inventoryFormSubmit.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('add-inventory-form');
                    if (form) {
                        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                });
            }

            // Navigation Button Event Listeners
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (!item.onclick) {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const screen = this.getAttribute('data-screen');
                        if (screen) {
                            switchScreen(screen + '-screen');
                        }
                    });
                }
            });

            // Add click effects to all buttons
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(button => {
                // Add loading state functionality
                button.addEventListener('click', function() {
                    // Add visual feedback for button clicks
                    if (!this.disabled) {
                        this.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            this.style.transform = '';
                        }, 100);
                    }
                });

                // Add keyboard support for Enter and Space
                button.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });

                // Add touch support for mobile
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.98)';
                }, { passive: true });

                button.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 100);
                }, { passive: true });
            });

            // Modal backdrop click handlers (for dynamically created modals)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop')) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                }
            });

            // Add event delegation for dynamically created buttons
            document.addEventListener('click', function(e) {
                const button = e.target.closest('button');
                if (button) {
                    // Handle dynamically created buttons that might not have onclick
                    const buttonText = button.textContent.trim();
                    const buttonClass = button.className;

                    // Handle specific button patterns
                    if (buttonText === '‡πÄ‡∏û‡∏¥‡πà‡∏°' && buttonClass.includes('btn-primary')) {
                        // This might be an "Add Category" button
                        if (button.closest('#manage-categories-modal')) {
                            addCategory();
                        }
                    }

                    // Handle menu item add buttons in POS
                    if (buttonText === '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°' && buttonClass.includes('btn-primary')) {
                        const menuItem = button.closest('.menu-item');
                        if (menuItem) {
                            const itemId = menuItem.getAttribute('data-item-id');
                            if (itemId) {
                                addToCart(itemId);
                            }
                        }
                    }

                    // Handle cart quantity buttons
                    if ((buttonText === '+' || buttonText === '-') && buttonClass.includes('btn-outline')) {
                        const cartItem = button.closest('.cart-item');
                        if (cartItem) {
                            // Extract item ID and quantity change from onclick attribute
                            const onclickAttr = button.getAttribute('onclick');
                            if (onclickAttr) {
                                try {
                                    eval(onclickAttr);
                                } catch (error) {
                                    console.error('Error executing cart button action:', error);
                                }
                            }
                        }
                    }

                    // Handle remove from cart buttons
                    if (buttonText === 'üóë' && buttonClass.includes('btn-error')) {
                        const cartItem = button.closest('.cart-item');
                        if (cartItem) {
                            const onclickAttr = button.getAttribute('onclick');
                            if (onclickAttr) {
                                try {
                                    eval(onclickAttr);
                                } catch (error) {
                                    console.error('Error executing remove button action:', error);
                                }
                            }
                        }
                    }
                }
            });

            // Add form validation helpers
            const allForms = document.querySelectorAll('form');
            allForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const requiredFields = form.querySelectorAll('[required]');
                    let isValid = true;

                    requiredFields.forEach(field => {
                        if (!field.value.trim()) {
                            field.style.borderColor = 'var(--error)';
                            isValid = false;
                        } else {
                            field.style.borderColor = '';
                        }
                    });

                    if (!isValid) {
                        e.preventDefault();
                        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                    }
                });
            });

            // Handle all form submissions properly
            // Add customer form
            const addCustomerForm = document.getElementById('add-customer-form');
            if (addCustomerForm) {
                addCustomerForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);

                    const customer = {
                        id: Utils.generateId(),
                        name: formData.get('name') || document.getElementById('customer-name').value,
                        phone: formData.get('phone') || document.getElementById('customer-phone').value,
                        email: formData.get('email') || document.getElementById('customer-email').value || '',
                        address: formData.get('address') || document.getElementById('customer-address').value || '',
                        created_at: new Date().toISOString(),
                        totalSpent: 0,
                        visits: 0,
                        lastVisit: new Date().toISOString()
                    };

                    AppState.customers.push(customer);
                    closeAddCustomerModal();
                    loadCustomers();
                    showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                });
            }

            // Add inventory form
            const addInventoryForm = document.getElementById('add-inventory-form');
            if (addInventoryForm) {
                addInventoryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    // Handle inventory form submission
                    const formData = new FormData(this);
                    console.log('Inventory form submitted:', Object.fromEntries(formData));
                    closeAddInventoryModal();
                    showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                });
            }

            // Settings form
            const settingsForm = document.querySelector('#settings-modal form');
            if (settingsForm) {
                settingsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveSettings();
                });
            }

            // Menu item form
            document.addEventListener('submit', function(e) {
                if (e.target.id === 'add-menu-item-form') {
                    e.preventDefault();
                    saveMenuItem();
                }

                if (e.target.id === 'edit-menu-item-form') {
                    e.preventDefault();
                    saveEditedMenuItem();
                }
            });

            // Add input field enhancement
            const allInputs = document.querySelectorAll('input, textarea, select');
            allInputs.forEach(input => {
                // Clear error styling on input
                input.addEventListener('input', function() {
                    this.style.borderColor = '';
                });

                // Add focus styling
                input.addEventListener('focus', function() {
                    this.style.borderColor = 'var(--primary)';
                });

                input.addEventListener('blur', function() {
                    if (!this.style.borderColor || this.style.borderColor === 'var(--primary)') {
                        this.style.borderColor = '';
                    }
                });
            });

            // Handle number inputs for mobile
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('input', function() {
                    // Ensure positive numbers where appropriate
                    if (this.min === '0' && parseFloat(this.value) < 0) {
                        this.value = '0';
                    }
                });
            });

            console.log('ü•™ POS System initialized successfully!');
        });

        // Menu Management Functions
        async function showAddMenuItemModal() {
            // Create and show modal for adding menu items
            const modalHTML = `
                <div id="add-menu-item-modal" class="modal active">
                    <div class="modal-backdrop" onclick="closeAddMenuItemModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</h3>
                            <button class="modal-close" onclick="closeAddMenuItemModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <form id="add-menu-item-form">
                                <div class="form-group">
                                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
                                    <input type="text" class="form-input" id="menu-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Æ‡∏°‡∏ä‡∏µ‡∏™" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" class="form-input" id="menu-price" placeholder="45.00" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" class="form-input" id="menu-cost" placeholder="12.00" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                    <select class="form-select" id="menu-category" required>
                                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                                        <option value="cat_sandwich">ü•™ ‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä</option>
                                        <option value="cat_beverage">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                        <option value="cat_side">üçü ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</option>
                                        <option value="cat_dessert">üç∞ ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                                    <textarea class="form-input" id="menu-description" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                                    <input type="number" class="form-input" id="menu-prep-time" placeholder="5" min="1" value="5">
                                </div>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" id="menu-featured">
                                        <span>‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddMenuItemModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="button" class="btn btn-primary" onclick="saveMenuItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeAddMenuItemModal() {
            const modal = document.getElementById('add-menu-item-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveMenuItem() {
            try {
                const form = document.getElementById('add-menu-item-form');
                const formData = new FormData(form);

                const menuItem = {
                    name: document.getElementById('menu-name').value,
                    price: parseFloat(document.getElementById('menu-price').value),
                    cost: parseFloat(document.getElementById('menu-cost').value),
                    category: document.getElementById('menu-category').value,
                    description: document.getElementById('menu-description').value,
                    prep_time: parseInt(document.getElementById('menu-prep-time').value) || 5,
                    is_featured: document.getElementById('menu-featured').checked,
                    is_available: true
                };

                await window.db.create('menu_items', menuItem);
                showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeAddMenuItemModal();
                await loadMenuItems();

            } catch (error) {
                console.error('‚ùå Error saving menu item:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function loadMenuItems() {
            try {
                const menuItems = await window.db.getMenuItems();
                const container = document.getElementById('menu-items-container');

                if (!container) return;

                container.innerHTML = menuItems.map(item => `
                    <div class="card" data-menu-id="${item.id}">
                        <div class="card-body">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-lg font-semibold">${item.name}</h4>
                                    <p class="text-sm text-gray-500 mb-2">${item.description || ''}</p>
                                    <div class="flex gap-4 text-sm">
                                        <span class="text-green-600">‡∏£‡∏≤‡∏Ñ‡∏≤: ${Utils.formatCurrency(item.price)}</span>
                                        <span class="text-red-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${Utils.formatCurrency(item.cost)}</span>
                                        <span class="text-blue-600">‡∏Å‡∏≥‡πÑ‡∏£: ${Utils.formatCurrency(item.price - item.cost)}</span>
                                    </div>
                                    ${item.is_featured ? '<span class="badge badge-warning">‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>' : ''}
                                    ${!item.is_available ? '<span class="badge badge-error">‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</span>' : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-secondary" onclick="editMenuItem('${item.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button class="btn btn-sm ${item.is_available ? 'btn-warning' : 'btn-success'}"
                                        onclick="toggleMenuAvailability('${item.id}', ${!item.is_available})">
                                        ${item.is_available ? '‡∏ã‡πà‡∏≠‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Error loading menu items:', error);
            }
        }

        async function editMenuItem(itemId) {
            try {
                const item = await window.db.findById('menu_items', itemId);
                if (!item) return;

                const modalHTML = `
                    <div id="edit-menu-item-modal" class="modal active">
                        <div class="modal-backdrop" onclick="closeEditMenuItemModal()"></div>
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π</h3>
                                <button class="modal-close" onclick="closeEditMenuItemModal()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-menu-item-form">
                                    <input type="hidden" id="edit-item-id" value="${item.id}">
                                    <div class="form-group">
                                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
                                        <input type="text" class="form-input" id="edit-menu-name" value="${item.name}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                                        <input type="number" class="form-input" id="edit-menu-price" value="${item.price}" min="0" step="0.01" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                        <select class="form-input" id="edit-menu-category" required>
                                            <option value="‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä" ${item.category === '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä' ? 'selected' : ''}>‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä</option>
                                            <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°" ${item.category === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°' ? 'selected' : ''}>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                            <option value="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô" ${item.category === '‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô' ? 'selected' : ''}>‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ${item.category === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? 'selected' : ''}>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                                        <textarea class="form-input" id="edit-menu-description" rows="3" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">${item.description || ''}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                                        <input type="url" class="form-input" id="edit-menu-image" value="${item.image || ''}" placeholder="https://example.com/image.jpg">
                                    </div>
                                    <div class="form-group">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" id="edit-menu-available" ${item.is_available ? 'checked' : ''}>
                                            <label for="edit-menu-available">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeEditMenuItemModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button type="button" class="btn btn-primary" onclick="saveEditedMenuItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                <button type="button" class="btn btn-error" onclick="deleteMenuItem('${item.id}')">‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                console.error('‚ùå Error loading menu item for edit:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function closeEditMenuItemModal() {
            const modal = document.getElementById('edit-menu-item-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveEditedMenuItem() {
            try {
                const id = document.getElementById('edit-item-id').value;
                const menuItem = {
                    name: document.getElementById('edit-menu-name').value,
                    price: parseFloat(document.getElementById('edit-menu-price').value),
                    category: document.getElementById('edit-menu-category').value,
                    description: document.getElementById('edit-menu-description').value,
                    image: document.getElementById('edit-menu-image').value,
                    is_available: document.getElementById('edit-menu-available').checked
                };

                await window.db.update('menu_items', id, menuItem);
                showToast('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeEditMenuItemModal();
                await loadMenuItems();

            } catch (error) {
                console.error('‚ùå Error updating menu item:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function deleteMenuItem(itemId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ')) {
                try {
                    await window.db.delete('menu_items', itemId);
                    showToast('‚úÖ ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    closeEditMenuItemModal();
                    await loadMenuItems();
                } catch (error) {
                    console.error('‚ùå Error deleting menu item:', error);
                    showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }

        async function toggleMenuAvailability(itemId, isAvailable) {
            try {
                await window.db.update('menu_items', itemId, { is_available: isAvailable });
                showToast(`‚úÖ ${isAvailable ? '‡πÅ‡∏™‡∏î‡∏á' : '‡∏ã‡πà‡∏≠‡∏ô'}‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                await loadMenuItems();
            } catch (error) {
                console.error('‚ùå Error toggling menu availability:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function filterMenuItems() {
            const searchTerm = document.getElementById('menu-search').value.toLowerCase();
            const categoryFilter = document.getElementById('menu-category-filter').value;
            const menuCards = document.querySelectorAll('#menu-items-container .card');

            menuCards.forEach(card => {
                const menuId = card.dataset.menuId;
                const menuName = card.querySelector('h4').textContent.toLowerCase();
                const menuCategory = card.dataset.category || '';

                const matchesSearch = menuName.includes(searchTerm);
                const matchesCategory = !categoryFilter || menuCategory === categoryFilter;

                card.style.display = matchesSearch && matchesCategory ? 'block' : 'none';
            });
        }

        // Data export/import functions
        async function exportData() {
            try {
                const data = await window.db.exportData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sandwich-pos-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                console.error('‚ùå Error exporting data:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                await window.db.importData(data);
                showToast('‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                location.reload(); // Refresh to show imported data
            } catch (error) {
                console.error('‚ùå Error importing data:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Service Worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
