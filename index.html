<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0c8ce9">
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ - POS System for Sandwich Shop">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sandwich POS">

    <title>ü•™ ‡∏£‡πâ‡∏≤‡∏ô Sandwich ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏° - POS System</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•™</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•™</text></svg>">

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js" defer></script>

    <!-- Local JavaScript files -->
    <script src="js/config.js" defer></script>
    <script src="js/database.js" defer></script>

    <style>
        /* CSS Custom Properties */
        :root {
            /* Colors */
            --primary: #0c8ce9;
            --primary-dark: #0159a2;
            --primary-light: #bae1fc;
            --secondary: #f97316;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;

            /* Additional Color Variants */
            --primary-50: #eff6ff;
            --success-50: #f0fdf4;
            --warning-50: #fffbeb;
            --error-50: #fef2f2;
            --blue-50: #eff6ff;
            --green-50: #f0fdf4;
            --yellow-50: #fffbeb;
            --red-50: #fef2f2;
            --purple-50: #faf5ff;
            --indigo-50: #eef2ff;

            /* Neutral Colors */
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;

            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;

            /* Spacing */
            --spacing-1: 0.25rem;
            --spacing-2: 0.5rem;
            --spacing-3: 0.75rem;
            --spacing-4: 1rem;
            --spacing-5: 1.25rem;
            --spacing-6: 1.5rem;
            --spacing-8: 2rem;
            --spacing-12: 3rem;

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

            /* Z-index */
            --z-modal: 1000;
            --z-dropdown: 100;
            --z-header: 10;
        }

        /* Reset and Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--gray-50);
            color: var(--gray-900);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Mobile-First Responsive Grid */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-4);
        }

        .grid {
            display: grid;
            gap: var(--spacing-4);
        }

        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }

        @media (min-width: 640px) {
            .sm\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .sm\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        @media (min-width: 768px) {
            .md\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }

        /* Flexbox Utilities */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: var(--spacing-2); }
        .gap-4 { gap: var(--spacing-4); }

        /* Layout Components */
        .app-header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: var(--spacing-4);
            position: sticky;
            top: 0;
            z-index: var(--z-header);
            box-shadow: var(--shadow-sm);
        }

        .app-content {
            padding: var(--spacing-4) 0 80px 0;
            min-height: calc(100vh - 140px);
        }

        .app-nav {
            background: var(--white);
            border-top: 1px solid var(--gray-200);
            padding: var(--spacing-2) var(--spacing-4);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: var(--z-header);
            box-shadow: 0 -1px 3px 0 rgb(0 0 0 / 0.1);
        }

        /* Button Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            padding: var(--spacing-3) var(--spacing-4);
            font-size: var(--font-size-sm);
            font-weight: 500;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            min-height: 44px; /* Touch target */
            -webkit-user-select: none;
            user-select: none;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-sm {
            padding: var(--spacing-2) var(--spacing-3);
            font-size: var(--font-size-xs);
            min-height: 36px;
        }

        .btn-lg {
            padding: var(--spacing-4) var(--spacing-6);
            font-size: var(--font-size-lg);
            min-height: 52px;
        }

        /* Card Component */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: var(--spacing-4) var(--spacing-6);
            border-bottom: 1px solid var(--gray-200);
        }

        .card-body {
            padding: var(--spacing-6);
        }

        .card-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-2);
        }

        /* Alert Component */
        .alert {
            padding: var(--spacing-4);
            border-radius: var(--radius);
            border: 1px solid transparent;
        }

        .alert-success {
            background-color: #f0f9ff;
            border-color: #22c55e;
            color: #16a34a;
        }

        .alert-warning {
            background-color: #fef3c7;
            border-color: #f59e0b;
            color: #d97706;
        }

        .alert-error {
            background-color: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: var(--spacing-2);
            overflow-x: auto;
            padding-bottom: var(--spacing-2);
            -webkit-overflow-scrolling: touch;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-1);
            padding: var(--spacing-2);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 60px;
            text-align: center;
            color: var(--gray-500);
            text-decoration: none;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        .nav-icon {
            font-size: var(--font-size-xl);
        }

        .nav-label {
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: var(--spacing-4);
        }

        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--spacing-2);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: var(--font-size-base);
            transition: border-color 0.15s ease;
            min-height: 44px; /* Touch target */
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(12 140 233 / 0.1);
        }

        .form-select {
            width: 100%;
            padding: var(--spacing-3) var(--spacing-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: var(--font-size-base);
            background: var(--white);
            cursor: pointer;
            min-height: 44px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: var(--z-modal);
            padding: var(--spacing-4);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .modal-header {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            cursor: pointer;
            padding: var(--spacing-2);
            border-radius: var(--radius);
            color: var(--gray-500);
            min-height: 44px;
            min-width: 44px;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .modal-body {
            padding: var(--spacing-6);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: var(--spacing-4);
            right: var(--spacing-4);
            z-index: var(--z-modal);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
            pointer-events: none;
        }

        .toast {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-4);
            max-width: 300px;
            pointer-events: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--error);
        }

        .toast-warning {
            border-left: 4px solid var(--warning);
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .block { display: block; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .text-sm { font-size: var(--font-size-sm); }
        .text-lg { font-size: var(--font-size-lg); }
        .text-xl { font-size: var(--font-size-xl); }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-700 { color: var(--gray-700); }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .mb-2 { margin-bottom: var(--spacing-2); }
        .mb-4 { margin-bottom: var(--spacing-4); }
        .mt-4 { margin-top: var(--spacing-4); }
        .p-4 { padding: var(--spacing-4); }
        .px-4 { padding-left: var(--spacing-4); padding-right: var(--spacing-4); }
        .py-4 { padding-top: var(--spacing-4); padding-bottom: var(--spacing-4); }

        /* Responsive Utilities */
        @media (max-width: 640px) {
            .container {
                padding: 0 var(--spacing-3);
            }

            .app-header {
                padding: var(--spacing-3);
            }

            .card-body {
                padding: var(--spacing-4);
            }

            .modal-content {
                margin: var(--spacing-2);
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --gray-50: #1e293b;
                --gray-100: #334155;
                --gray-200: #475569;
                --gray-900: #f8fafc;
                --white: #0f172a;
            }
        }

        /* Loading States */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Screen Management */
        .screen {
            display: none;
            min-height: calc(100vh - 140px);
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Menu Grid for POS */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--spacing-3);
        }

        .menu-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .menu-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .menu-item-image {
            width: 60px;
            height: 60px;
            border-radius: var(--radius);
            background: var(--gray-100);
            margin: 0 auto var(--spacing-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-2xl);
        }

        .menu-item-name {
            font-weight: 500;
            margin-bottom: var(--spacing-1);
        }

        .menu-item-price {
            color: var(--primary);
            font-weight: 600;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: var(--spacing-4) 0;
        }

        @media (max-width: 640px) {
            .chart-container {
                height: 250px;
            }
        }

        /* Customer Card */
        .customer-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .customer-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .customer-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .customer-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: var(--font-size-lg);
        }

        /* Payment Method Selection */
        .payment-method {
            border: 2px solid var(--gray-200);
        }

        .payment-method.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }

        .payment-section {
            display: none;
        }

        .payment-section.active {
            display: block;
        }

        /* Low Stock Alert */
        .low-stock {
            border-left: 4px solid var(--error);
            background: var(--error-50);
        }

        /* Stats Cards */
        .stat-card {
            text-align: center;
            padding: var(--spacing-4);
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }

        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin-bottom: var(--spacing-1);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--spacing-1) var(--spacing-2);
            font-size: var(--font-size-xs);
            font-weight: 500;
            border-radius: var(--radius);
        }

        .badge-success {
            background: var(--success-50);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-50);
            color: var(--warning);
        }

        .badge-error {
            background: var(--error-50);
            color: var(--error);
        }

        /* Space utilities */
        .space-y-2 > * + * { margin-top: var(--spacing-2); }
        .space-y-3 > * + * { margin-top: var(--spacing-3); }
        .space-y-4 > * + * { margin-top: var(--spacing-4); }

        /* Max height utilities */
        .max-h-60 { max-height: 15rem; }
        .overflow-y-auto { overflow-y: auto; }
    </style>
</head>
<body>
    <!-- App Header -->
    <header class="app-header">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="text-2xl">ü•™</div>
                <div>
                    <h1 class="font-semibold text-lg">‡∏£‡πâ‡∏≤‡∏ô Sandwich ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏°</h1>
                    <p class="text-sm text-gray-500">POS System</p>
                </div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="showSettings()">
                ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="app-content">
        <div class="container">
            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="screen active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Today's Sales -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title text-primary">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                            <p class="text-3xl font-bold text-success" id="today-sales">‡∏ø0</p>
                            <p class="text-sm text-gray-500">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="last-update">--:--</span></p>
                        </div>
                    </div>

                    <!-- Today's Orders -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title text-primary">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                            <p class="text-3xl font-bold text-primary" id="today-orders">0</p>
                            <p class="text-sm text-gray-500">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h3 class="card-title">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                            <button class="btn btn-success" onclick="showSalesModal()">
                                üßæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                            </button>
                            <button class="btn btn-primary" onclick="switchScreen('pos-screen')">
                                üõí POS
                            </button>
                            <button class="btn btn-info" onclick="showSalesHistoryModal()">
                                üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                            </button>
                            <button class="btn btn-warning" onclick="showPeakHoursModal()">
                                ‚è∞ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏≤
                            </button>
                            <button class="btn btn-secondary" onclick="switchScreen('inventory-screen')">
                                ÔøΩ ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ
                            </button>
                            <button class="btn btn-secondary" onclick="showExpenseModal()">
                                üí∏ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                            </button>
                        </div>

                        <!-- Sales Quick Stats -->
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div>
                                    <div class="text-lg font-bold text-success" id="today-sales-count">-</div>
                                    <div class="text-xs text-gray-600">‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-primary" id="today-revenue">-</div>
                                    <div class="text-xs text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-warning" id="avg-order-value">-</div>
                                    <div class="text-xs text-gray-600">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-info" id="peak-hour-today">-</div>
                                    <div class="text-xs text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales Chart -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- POS Screen -->
            <div id="pos-screen" class="screen">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Menu Items -->
                    <div class="lg:col-span-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‡πÄ‡∏°‡∏ô‡∏π</h3>
                                <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." id="menu-search">
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <button class="btn btn-primary btn-lg w-full" onclick="showCustomSandwichBuilder()">
                                        ü•™ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÄ‡∏≠‡∏á
                                    </button>
                                </div>
                                <div class="menu-grid" id="menu-container">
                                    <!-- Menu items will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Cart -->
                    <div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                            </div>
                            <div class="card-body">
                                <div id="cart-items" class="mb-4">
                                    <p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                                </div>
                                <div class="border-t pt-4">
                                    <div class="flex justify-between items-center mb-4">
                                        <span class="font-semibold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                        <span class="text-xl font-bold text-primary" id="cart-total">‡∏ø0</span>
                                    </div>
                                    <button class="btn btn-success btn-lg w-full" onclick="processPayment()" disabled id="checkout-btn">
                                        üí∞ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Screen -->
            <div id="inventory-screen" class="screen">
                <!-- Low Stock Alerts -->
                <div class="mb-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</h3>
                            <button class="btn btn-secondary btn-sm" onclick="refreshStockAlerts()">
                                üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="stock-alerts-container">
                                <!-- Stock alerts will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Analytics -->
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="text-2xl font-bold text-primary" id="total-ingredients-count">-</div>
                                <div class="text-sm text-gray-600">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="text-2xl font-bold text-warning" id="low-stock-count">-</div>
                                <div class="text-sm text-gray-600">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏ï‡πà‡∏≥/‡∏´‡∏°‡∏î</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="text-2xl font-bold text-success" id="inventory-value">-</div>
                                <div class="text-sm text-gray-600">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Menu Management -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="exportData()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
                                <label class="btn btn-secondary btn-sm cursor-pointer">
                                    üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                                    <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                                </label>
                                <button class="btn btn-primary btn-sm" onclick="showAddMenuItemModal()">
                                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <div class="flex gap-2 mb-3">
                                    <select class="form-select flex-1" id="menu-category-filter" onchange="filterMenuItems()">
                                        <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                                        <option value="sandwich">ü•™ ‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä</option>
                                        <option value="beverage">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                        <option value="side">üçü ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</option>
                                        <option value="dessert">üç∞ ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                                        <option value="combo">üçΩÔ∏è ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</option>
                                    </select>
                                    <button class="btn btn-secondary btn-sm" onclick="showManageCategoriesModal()">
                                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                                    </button>
                                </div>
                                <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." id="menu-search" oninput="filterMenuItems()">
                            </div>
                            <div class="grid grid-cols-1 gap-3" id="menu-items-container">
                                <!-- Menu items will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Ingredient Management -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddIngredientModal()">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <div class="flex gap-2 mb-3">
                                    <select class="form-select flex-1" id="ingredient-status-filter" onchange="filterIngredients()">
                                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                        <option value="low_stock">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏ï‡πà‡∏≥</option>
                                        <option value="out_of_stock">‡∏´‡∏°‡∏î</option>
                                        <option value="in_stock">‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</option>
                                    </select>
                                </div>
                                <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö..." id="ingredient-search" oninput="filterIngredients()">
                            </div>
                            <div class="grid grid-cols-1 gap-3" id="ingredients-container">
                                <!-- Ingredients will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Dashboard Screen -->
            <div id="reports-screen" class="screen">
                <!-- Analytics Header -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
                        <div class="flex gap-2">
                            <select class="form-select" id="analytics-period" onchange="updateAnalyticsPeriod()">
                                <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                                <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                                <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                                <option value="quarter">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ</option>
                                <option value="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="refreshAllAnalytics()">
                                üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
                            </button>
                        </div>
                    </div>

                    <!-- Key Performance Indicators -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-2xl font-bold" id="kpi-total-sales">0</div>
                                    <div class="text-blue-100 text-sm">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
                                </div>
                                <div class="text-3xl opacity-80">üõí</div>
                            </div>
                            <div class="mt-2 text-xs text-blue-100" id="kpi-sales-change">-</div>
                        </div>

                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-2xl font-bold" id="kpi-total-revenue">‡∏ø0</div>
                                    <div class="text-green-100 text-sm">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
                                </div>
                                <div class="text-3xl opacity-80">üí∞</div>
                            </div>
                            <div class="mt-2 text-xs text-green-100" id="kpi-revenue-change">-</div>
                        </div>

                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-2xl font-bold" id="kpi-avg-order">‡∏ø0</div>
                                    <div class="text-purple-100 text-sm">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                                </div>
                                <div class="text-3xl opacity-80">üìà</div>
                            </div>
                            <div class="mt-2 text-xs text-purple-100" id="kpi-avg-change">-</div>
                        </div>

                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-2xl font-bold" id="kpi-profit-margin">0%</div>
                                    <div class="text-orange-100 text-sm">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</div>
                                </div>
                                <div class="text-3xl opacity-80">üìä</div>
                            </div>
                            <div class="mt-2 text-xs text-orange-100" id="kpi-margin-change">-</div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Sales Trend Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-outline chart-type-btn active" data-type="line" onclick="changeSalesChartType('line')">
                                    üìà ‡πÄ‡∏™‡πâ‡∏ô
                                </button>
                                <button class="btn btn-sm btn-outline chart-type-btn" data-type="bar" onclick="changeSalesChartType('bar')">
                                    üìä ‡πÅ‡∏ó‡πà‡∏á
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="salesTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Products Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üèÜ ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ TOP 10</h3>
                            <select class="form-select" id="top-products-metric" onchange="updateTopProductsChart()">
                                <option value="quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</option>
                                <option value="revenue">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</option>
                                <option value="profit">‡∏Å‡∏≥‡πÑ‡∏£</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Profit Analysis Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí∞ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≥‡πÑ‡∏£</h3>
                            <select class="form-select" id="profit-analysis-type" onchange="updateProfitAnalysisChart()">
                                <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                                <option value="menu">‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π</option>
                                <option value="category">‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="profitAnalysisChart"></canvas>
                            </div>
                            <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-lg font-bold text-success" id="profit-total-revenue">‡∏ø0</div>
                                    <div class="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-error" id="profit-total-cost">‡∏ø0</div>
                                    <div class="text-xs text-gray-500">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-primary" id="profit-net-profit">‡∏ø0</div>
                                    <div class="text-xs text-gray-500">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Peak Hours Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
                            <button class="btn btn-sm btn-outline" onclick="showPeakHoursModal()">
                                üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="peakHoursChart"></canvas>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
                                    <span class="font-bold" id="peak-hour-display">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏™‡∏∏‡∏î:</span>
                                    <span class="font-bold" id="slow-hour-display">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Analytics -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üë• ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="text-center p-3 bg-blue-50 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600" id="total-customers">0</div>
                                    <div class="text-sm text-gray-600">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                </div>
                                <div class="text-center p-3 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600" id="returning-customers">0</div>
                                    <div class="text-sm text-gray-600">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥</div>
                                </div>
                            </div>

                            <div class="space-y-3" id="top-customers-list">
                                <!-- Top customers will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí≥ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="paymentMethodsChart"></canvas>
                            </div>
                            <div class="mt-4 space-y-2" id="payment-methods-stats">
                                <!-- Payment method stats will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Insights Panel -->
                <div class="mt-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
                            <button class="btn btn-sm btn-primary" onclick="generateBusinessRecommendations()">
                                üîÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="business-recommendations" class="space-y-3">
                                <!-- Business recommendations will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Management Screen -->
            <div id="customers-screen" class="screen">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Customer List -->
                    <div class="lg:col-span-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                                <button class="btn btn-primary btn-sm" onclick="showAddCustomerModal()">
                                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." id="customer-search">
                                </div>
                                <div id="customers-list" class="space-y-3">
                                    <!-- Customers will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Stats -->
                    <div>
                        <div class="card mb-6">
                            <div class="card-header">
                                <h3 class="card-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                            </div>
                            <div class="card-body">
                                <div class="space-y-4">
                                    <div class="flex justify-between">
                                        <span>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                                        <span class="font-semibold text-primary" id="new-customers-today">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</span>
                                        <span class="font-semibold text-success" id="returning-today">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                        <span class="font-semibold text-secondary" id="total-points-issued">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Loyalty Program -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" class="form-input" id="points-rate" value="1" min="0" step="0.1">
                                        <span class="text-sm text-gray-500">% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm w-full" onclick="updateLoyaltySettings()">
                                    ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost Analysis Screen -->
        <div id="cost-analysis-screen" class="screen">
            <div class="screen-header">
                <h1 class="screen-title">
                    <span class="icon">üí∞</span>
                    ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô
                </h1>
                <p class="screen-subtitle">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡πÑ‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏¢</p>
            </div>

            <div class="screen-content">
                <div class="space-y-6">
                    <!-- Summary Cards - Mobile Optimized -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="card">
                            <div class="card-body text-center p-4">
                                <div class="text-2xl font-bold text-success" id="today-revenue">‡∏ø0</div>
                                <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center p-4">
                                <div class="text-2xl font-bold text-error" id="today-costs">‡∏ø0</div>
                                <div class="text-sm text-gray-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center p-4">
                                <div class="text-2xl font-bold text-primary" id="today-profit">‡∏ø0</div>
                                <div class="text-sm text-gray-600">‡∏Å‡∏≥‡πÑ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center p-4">
                                <div class="text-2xl font-bold text-warning" id="profit-margin-today">0%</div>
                                <div class="text-sm text-gray-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Analysis Buttons -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2 gap-3">
                                <button class="btn btn-primary" onclick="showDailyAnalysis()">
                                    <div class="text-center">
                                        <div>üìÖ</div>
                                        <div class="text-sm">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                                    </div>
                                </button>
                                <button class="btn btn-secondary" onclick="showWeeklyAnalysis()">
                                    <div class="text-center">
                                        <div>üìä</div>
                                        <div class="text-sm">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
                                    </div>
                                </button>
                                <button class="btn btn-warning" onclick="showBestSellingItems()">
                                    <div class="text-center">
                                        <div>üèÜ</div>
                                        <div class="text-sm">‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</div>
                                    </div>
                                </button>
                                <button class="btn btn-success" onclick="showProfitableItems()">
                                    <div class="text-center">
                                        <div>üí∞</div>
                                        <div class="text-sm">‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏π‡∏á</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Menu Performance Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üçΩÔ∏è ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏°‡∏ô‡∏π</h3>
                            <button class="btn btn-sm btn-primary" onclick="refreshMenuAnalysis()">üîÑ</button>
                        </div>
                        <div class="card-body">
                            <div id="menu-analysis-container" class="space-y-3">
                                <!-- Menu analysis cards will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Business Insights -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h3>
                        </div>
                        <div class="card-body">
                            <div id="business-insights" class="space-y-3">
                                <!-- AI-powered insights will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Expense Tracker -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí∏ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                            <button class="btn btn-sm btn-primary" onclick="addExpense()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                        <div class="card-body">
                            <div id="expenses-today" class="space-y-3">
                                <!-- Today's expenses will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Data Entry Shortcuts -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‚ö° ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡πá‡∏ß</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2 gap-3">
                                <button class="btn btn-success" onclick="quickSaleEntry()">
                                    <div class="text-center">
                                        <div>üí∞</div>
                                        <div class="text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
                                    </div>
                                </button>
                                <button class="btn btn-error" onclick="quickExpenseEntry()">
                                    <div class="text-center">
                                        <div>üí∏</div>
                                        <div class="text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div>
                                    </div>
                                </button>
                                <button class="btn btn-warning" onclick="stockCheck()">
                                    <div class="text-center">
                                        <div>üì¶</div>
                                        <div class="text-sm">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</div>
                                    </div>
                                </button>
                                <button class="btn btn-primary" onclick="generateReport()">
                                    <div class="text-center">
                                        <div>üìã</div>
                                        <div class="text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="app-nav">
        <div class="nav">
            <a href="#" class="nav-item active" onclick="switchScreen('dashboard-screen')" data-screen="dashboard">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
            </a>
            <a href="#" class="nav-item" onclick="switchScreen('pos-screen')" data-screen="pos">
                <div class="nav-icon">üõí</div>
                <div class="nav-label">‡∏Ç‡∏≤‡∏¢</div>
            </a>
            <a href="#" class="nav-item" onclick="switchScreen('inventory-screen')" data-screen="inventory">
                <div class="nav-icon">üì¶</div>
                <div class="nav-label">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</div>
            </a>
            <a href="#" class="nav-item" onclick="switchScreen('reports-screen')" data-screen="reports">
                <div class="nav-icon">üìã</div>
                <div class="nav-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            </a>
            <a href="#" class="nav-item" onclick="switchScreen('customers-screen')" data-screen="customers">
                <div class="nav-icon">üë•</div>
                <div class="nav-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            </a>
            <a href="#" class="nav-item" onclick="switchScreen('cost-analysis-screen')" data-screen="cost-analysis">
                <div class="nav-icon">üí∞</div>
                <div class="nav-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
            </a>
        </div>
    </nav>

    <!-- Modals -->

    <!-- Expense Modal -->
    <div id="expense-modal" class="modal">
        <div class="modal-backdrop" onclick="closeExpenseModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>
                <button class="modal-close" onclick="closeExpenseModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="expense-form">
                    <div class="form-group">
                        <label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <input type="text" class="form-input" id="expense-item" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö, ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" class="form-input" id="expense-amount" placeholder="0" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <select class="form-select" id="expense-category" required>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                            <option value="ingredients">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
                            <option value="utilities">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option>
                            <option value="marketing">‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
                            <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea class="form-input" id="expense-notes" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary flex-1" onclick="closeExpenseModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-backdrop" onclick="closeSettings()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
                    <input type="text" class="form-input" id="shop-name" value="‡∏£‡πâ‡∏≤‡∏ô Sandwich ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏°">
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                    <input type="tel" class="form-input" id="shop-phone" placeholder="08X-XXX-XXXX">
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <textarea class="form-input" id="shop-address" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ (%)</label>
                    <input type="number" class="form-input" id="tax-rate" value="7" min="0" max="20" step="0.1">
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="time" class="form-input" id="open-time" value="06:00">
                        <input type="time" class="form-input" id="close-time" value="20:00">
                    </div>
                </div>
                <div class="flex gap-4">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closeSettings()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary flex-1" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="modal">
        <div class="modal-backdrop" onclick="closeAddCustomerModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                <button class="modal-close" onclick="closeAddCustomerModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="customer-form">
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" class="form-input" id="customer-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                        <input type="tel" class="form-input" id="customer-phone" placeholder="08X-XXX-XXXX">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" class="form-input" id="customer-email" placeholder="customer@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                        <input type="date" class="form-input" id="customer-birthday">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea class="form-input" id="customer-notes" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary flex-1" onclick="closeAddCustomerModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Enhanced Sales Recording Modal -->
    <div id="sales-modal" class="modal">
        <div class="modal-backdrop" onclick="closeSalesModal()"></div>
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">üßæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                <button class="modal-close" onclick="closeSalesModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Customer Section -->
                <div class="form-group">
                    <label class="form-label">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <div class="flex gap-2">
                        <input type="text" class="form-input flex-1" id="selected-customer-display" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ" readonly onclick="showCustomerSelectModal()">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="showCustomerSelectModal()">
                            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        </button>
                    </div>
                </div>

                <!-- Quick Menu Selection -->
                <div class="form-group">
                    <label class="form-label">ü•™ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3" id="quick-menu-selection">
                        <!-- Quick menu buttons will be loaded here -->
                    </div>
                </div>

                <!-- Order Items -->
                <div class="form-group">
                    <label class="form-label">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</label>
                    <div id="order-items" class="space-y-2 mb-3">
                        <!-- Order items will be shown here -->
                    </div>
                    <div class="flex gap-2">
                        <select class="form-select flex-1" id="menu-select">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π...</option>
                        </select>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addOrderItem()">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
                        </button>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                        <span class="text-lg font-bold text-primary" id="order-subtotal">‡∏ø0</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
                        <div class="flex items-center gap-2">
                            <input type="number" class="form-input w-20 text-right" id="discount-amount" placeholder="0" min="0" oninput="updateOrderTotal()">
                            <span>‡∏ø</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-lg font-bold border-t pt-2">
                        <span>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span>
                        <span class="text-success" id="order-total">‡∏ø0</span>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="form-group">
                    <label class="form-label">üí≥ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <button type="button" class="btn btn-outline payment-method active" data-method="cash" onclick="selectPaymentMethod('cash')">
                            üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                        </button>
                        <button type="button" class="btn btn-outline payment-method" data-method="card" onclick="selectPaymentMethod('card')">
                            üí≥ ‡∏ö‡∏±‡∏ï‡∏£
                        </button>
                        <button type="button" class="btn btn-outline payment-method" data-method="qr" onclick="selectPaymentMethod('qr')">
                            üì± QR Code
                        </button>
                        <button type="button" class="btn btn-outline payment-method" data-method="transfer" onclick="selectPaymentMethod('transfer')">
                            üè¶ ‡πÇ‡∏≠‡∏ô
                        </button>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea class="form-input" id="sale-notes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢..."></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closeSalesModal()">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="button" class="btn btn-warning flex-1" onclick="saveDraftSale()">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á
                    </button>
                    <button type="button" class="btn btn-success flex-1" onclick="completeSale()">
                        ‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales History Modal -->
    <div id="sales-history-modal" class="modal">
        <div class="modal-backdrop" onclick="closeSalesHistoryModal()"></div>
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                <button class="modal-close" onclick="closeSalesHistoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Filter Controls -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="form-group">
                        <label class="form-label">üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <select class="form-select" id="history-date-range" onchange="filterSalesHistory()">
                            <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                            <option value="yesterday">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</option>
                            <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                            <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                            <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                        <select class="form-select" id="history-customer-filter" onchange="filterSalesHistory()">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üí≥ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</label>
                        <select class="form-select" id="history-payment-filter" onchange="filterSalesHistory()">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                            <option value="card">‡∏ö‡∏±‡∏ï‡∏£</option>
                            <option value="qr">QR Code</option>
                            <option value="transfer">‡πÇ‡∏≠‡∏ô</option>
                        </select>
                    </div>
                </div>

                <!-- Sales Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="bg-blue-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600" id="history-total-sales">0</div>
                        <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600" id="history-total-revenue">‡∏ø0</div>
                        <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-600" id="history-avg-order">‡∏ø0</div>
                        <div class="text-sm text-gray-600">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-purple-600" id="history-unique-customers">0</div>
                        <div class="text-sm text-gray-600">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥</div>
                    </div>
                </div>

                <!-- Sales List -->
                <div class="max-h-96 overflow-y-auto">
                    <div id="sales-history-list" class="space-y-2">
                        <!-- Sales history will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Peak Hours Analysis Modal -->
    <div id="peak-hours-modal" class="modal">
        <div class="modal-backdrop" onclick="closePeakHoursModal()"></div>
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">‚è∞ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
                <button class="modal-close" onclick="closePeakHoursModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Time Period Selection -->
                <div class="form-group mb-4">
                    <label class="form-label">üìä ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <button type="button" class="btn btn-outline period-btn active" data-period="week" onclick="selectAnalysisPeriod('week')">
                            ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ
                        </button>
                        <button type="button" class="btn btn-outline period-btn" data-period="month" onclick="selectAnalysisPeriod('month')">
                            ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                        </button>
                        <button type="button" class="btn btn-outline period-btn" data-period="quarter" onclick="selectAnalysisPeriod('quarter')">
                            ‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ
                        </button>
                        <button type="button" class="btn btn-outline period-btn" data-period="year" onclick="selectAnalysisPeriod('year')">
                            ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
                        </button>
                    </div>
                </div>

                <!-- Peak Hours Chart -->
                <div class="mb-6">
                    <canvas id="peak-hours-chart" style="max-height: 300px;"></canvas>
                </div>

                <!-- Peak Hours Insights -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">ÔøΩ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h4>
                        </div>
                        <div class="card-body">
                            <div id="peak-hours-list" class="space-y-2">
                                <!-- Peak hours will be shown here -->
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h4>
                        </div>
                        <div class="card-body">
                            <div id="peak-hours-recommendations" class="space-y-2 text-sm">
                                <!-- Recommendations will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Selection Modal -->
    <div id="customer-select-modal" class="modal">
        <div class="modal-backdrop" onclick="closeCustomerSelectModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                <button class="modal-close" onclick="closeCustomerSelectModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <input type="search" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." id="customer-select-search" oninput="filterCustomerSelect()">
                </div>
                <div id="customer-select-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Customer list will be loaded here -->
                </div>
                <div class="mt-4">
                    <button class="btn btn-secondary w-full" onclick="selectWalkInCustomer()">
                        üö∂‚Äç‚ôÇÔ∏è ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Inventory Modal -->
    <div id="add-inventory-modal" class="modal">
        <div class="modal-backdrop" onclick="closeAddInventoryModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                <button class="modal-close" onclick="closeAddInventoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="inventory-form">
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" class="form-input" id="item-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                            <input type="number" class="form-input" id="item-stock" placeholder="0" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <select class="form-select" id="item-unit" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>
                                <option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
                                <option value="‡πÅ‡∏ú‡πà‡∏ô">‡πÅ‡∏ú‡πà‡∏ô</option>
                                <option value="‡∏Å‡∏Å.">‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</option>
                                <option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏°</option>
                                <option value="‡∏•‡∏¥‡∏ï‡∏£">‡∏•‡∏¥‡∏ï‡∏£</option>
                                <option value="‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á">‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á</option>
                                <option value="‡∏´‡πà‡∏≠">‡∏´‡πà‡∏≠</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-input" id="item-cost" placeholder="0" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-input" id="item-price" placeholder="0" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
                            <input type="number" class="form-input" id="item-min-stock" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                            <select class="form-select" id="item-supplier">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea class="form-input" id="item-notes" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary flex-1" onclick="closeAddInventoryModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-backdrop" onclick="closePaymentModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <button class="modal-close" onclick="closePaymentModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="mb-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-primary mb-2" id="payment-total">‡∏ø0</div>
                        <div class="text-gray-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <div class="flex gap-2">
                        <input type="text" class="form-input flex-1" id="payment-customer" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" readonly>
                        <button class="btn btn-secondary btn-sm" onclick="showCustomerSelectModal()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="btn btn-secondary payment-method active" data-method="cash" onclick="selectPaymentMethod('cash')">
                            üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                        </button>
                        <button class="btn btn-secondary payment-method" data-method="card" onclick="selectPaymentMethod('card')">
                            üí≥ ‡∏ö‡∏±‡∏ï‡∏£
                        </button>
                        <button class="btn btn-secondary payment-method" data-method="transfer" onclick="selectPaymentMethod('transfer')">
                            üì± ‡πÇ‡∏≠‡∏ô
                        </button>
                        <button class="btn btn-secondary payment-method" data-method="qr" onclick="selectPaymentMethod('qr')">
                            üî≤ QR Code
                        </button>
                    </div>
                </div>

                <div id="cash-payment" class="payment-section">
                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤</label>
                        <input type="number" class="form-input" id="cash-received" placeholder="0" min="0" step="0.01" onchange="calculateChange()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</label>
                        <div class="text-xl font-bold text-success" id="change-amount">‡∏ø0</div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="apply-discount" onchange="toggleDiscount()">
                        <label for="apply-discount" class="form-label mb-0">‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                    </div>
                    <div id="discount-section" class="hidden mt-2">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" class="form-input" id="discount-amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" min="0" step="0.01" onchange="applyDiscount()">
                            <select class="form-select" id="discount-type" onchange="applyDiscount()">
                                <option value="amount">‡∏ö‡∏≤‡∏ó</option>
                                <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closePaymentModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-success flex-1" onclick="confirmPayment()">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- JavaScript -->
    <!-- Data Export and Reports Modal -->
    <div id="reports-modal" class="modal">
        <div class="modal-backdrop" onclick="closeReportsModal()"></div>
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                <button class="modal-close" onclick="closeReportsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Report Type Selection -->
                <div class="form-group mb-4">
                    <label class="form-label">üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="report-option" onclick="selectReportType('sales')">
                            <div class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300">
                                <span class="text-2xl">üõí</span>
                                <div>
                                    <div class="font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
                                    <div class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
                                </div>
                            </div>
                        </div>

                        <div class="report-option" onclick="selectReportType('profit')">
                            <div class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-green-50 hover:border-green-300">
                                <span class="text-2xl">üí∞</span>
                                <div>
                                    <div class="font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</div>
                                    <div class="text-sm text-gray-500">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≥‡πÑ‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
                                </div>
                            </div>
                        </div>

                        <div class="report-option" onclick="selectReportType('inventory')">
                            <div class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-yellow-50 hover:border-yellow-300">
                                <span class="text-2xl">üì¶</span>
                                <div>
                                    <div class="font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</div>
                                    <div class="text-sm text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                                </div>
                            </div>
                        </div>

                        <div class="report-option" onclick="selectReportType('customer')">
                            <div class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-300">
                                <span class="text-2xl">üë•</span>
                                <div>
                                    <div class="font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                                    <div class="text-sm text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</div>
                                </div>
                            </div>
                        </div>

                        <div class="report-option" onclick="selectReportType('expenses')">
                            <div class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-red-50 hover:border-red-300">
                                <span class="text-2xl">üí∏</span>
                                <div>
                                    <div class="font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div>
                                    <div class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                </div>
                            </div>
                        </div>

                        <div class="report-option" onclick="selectReportType('comprehensive')">
                            <div class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 hover:border-indigo-300">
                                <span class="text-2xl">üìà</span>
                                <div>
                                    <div class="font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</div>
                                    <div class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selected Report Type Display -->
                <div id="selected-report-display" class="hidden mb-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center gap-2">
                            <span id="selected-report-icon" class="text-xl"></span>
                            <span id="selected-report-name" class="font-medium"></span>
                        </div>
                    </div>
                </div>

                <!-- Date Range Selection -->
                <div class="form-group mb-4">
                    <label class="form-label">üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                        <button type="button" class="btn btn-outline period-select-btn active" data-period="today" onclick="selectDatePeriod('today')">
                            ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        </button>
                        <button type="button" class="btn btn-outline period-select-btn" data-period="week" onclick="selectDatePeriod('week')">
                            ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ
                        </button>
                        <button type="button" class="btn btn-outline period-select-btn" data-period="month" onclick="selectDatePeriod('month')">
                            ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                        </button>
                        <button type="button" class="btn btn-outline period-select-btn" data-period="custom" onclick="selectDatePeriod('custom')">
                            ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
                        </button>
                    </div>

                    <div id="custom-date-range" class="hidden">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                <input type="date" class="form-input" id="report-start-date">
                            </div>
                            <div class="form-group">
                                <label class="form-label text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                <input type="date" class="form-input" id="report-end-date">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Format Selection -->
                <div class="form-group mb-4">
                    <label class="form-label">üìÑ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <button type="button" class="btn btn-outline format-btn active" data-format="pdf" onclick="selectExportFormat('pdf')">
                            üìÑ PDF
                        </button>
                        <button type="button" class="btn btn-outline format-btn" data-format="csv" onclick="selectExportFormat('csv')">
                            üìä CSV
                        </button>
                        <button type="button" class="btn btn-outline format-btn" data-format="excel" onclick="selectExportFormat('excel')">
                            üìà Excel
                        </button>
                    </div>
                </div>

                <!-- Additional Options -->
                <div class="form-group mb-4">
                    <label class="form-label">‚öôÔ∏è ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="include-charts" checked>
                            <span class="text-sm">‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="include-summary">
                            <span class="text-sm">‡∏£‡∏ß‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="include-recommendations">
                            <span class="text-sm">‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</span>
                        </label>
                    </div>
                </div>

                <!-- Report Preview -->
                <div id="report-preview" class="hidden mb-4">
                    <div class="form-group">
                        <label class="form-label">üëÅÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                        <div id="report-preview-content" class="bg-gray-50 border rounded-lg p-4 max-h-60 overflow-y-auto">
                            <!-- Preview content will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closeReportsModal()">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="button" class="btn btn-info flex-1" onclick="previewReport()" id="preview-btn" disabled>
                        üëÅÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                    </button>
                    <button type="button" class="btn btn-success flex-1" onclick="generateAndDownloadReport()" id="download-btn" disabled>
                        üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Schedule Modal -->
    <div id="report-schedule-modal" class="modal">
        <div class="modal-backdrop" onclick="closeReportScheduleModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h3>
                <button class="modal-close" onclick="closeReportScheduleModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Schedule Settings -->
                <div class="form-group">
                    <label class="form-label">üîÑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</label>
                    <select class="form-select" id="schedule-frequency">
                        <option value="daily">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</option>
                        <option value="weekly" selected>‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                        <option value="monthly">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="quarterly">‡∏ó‡∏∏‡∏Å‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
                    <input type="email" class="form-input" id="schedule-email" placeholder="example@email.com">
                    <div class="text-xs text-gray-500 mt-1">‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                </div>

                <div class="form-group">
                    <label class="form-label">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á</label>
                    <input type="time" class="form-input" id="schedule-time" value="09:00">
                </div>

                <div class="form-group">
                    <label class="form-label">üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="sales" checked>
                            <span class="text-sm">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="profit">
                            <span class="text-sm">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="inventory">
                            <span class="text-sm">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button type="button" class="btn btn-secondary flex-1" onclick="closeReportScheduleModal()">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="button" class="btn btn-primary flex-1" onclick="saveReportSchedule()">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // ====================================
        // DATABASE FALLBACK SYSTEM
        // ====================================

        // Initialize database fallback if external scripts fail
        if (!window.db) {
            console.warn('External database.js not found, initializing fallback database system');

            window.db = {
                isReady: false,
                data: {
                    menu: [],
                    ingredients: [],
                    sales: [],
                    customers: [],
                    transactions: []
                },

                async init() {
                    try {
                        // Try to use IndexedDB
                        if ('indexedDB' in window) {
                            const request = indexedDB.open('SandwichShopDB', 1);

                            request.onerror = () => {
                                console.warn('IndexedDB not available, using localStorage');
                                this.loadFromLocalStorage();
                                this.isReady = true;
                            };

                            request.onsuccess = (event) => {
                                this.db = event.target.result;
                                this.loadFromLocalStorage(); // Load existing data
                                this.isReady = true;
                            };

                            request.onupgradeneeded = (event) => {
                                const db = event.target.result;
                                const stores = ['menu', 'ingredients', 'sales', 'customers', 'transactions'];
                                stores.forEach(storeName => {
                                    if (!db.objectStoreNames.contains(storeName)) {
                                        const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                                    }
                                });
                            };
                        } else {
                            // Fallback to localStorage
                            this.loadFromLocalStorage();
                            this.isReady = true;
                        }
                    } catch (error) {
                        console.error('Database initialization failed:', error);
                        this.loadFromLocalStorage();
                        this.isReady = true;
                    }
                },

                loadFromLocalStorage() {
                    try {
                        Object.keys(this.data).forEach(key => {
                            const stored = localStorage.getItem(`db_${key}`);
                            if (stored) {
                                this.data[key] = JSON.parse(stored);
                            }
                        });
                    } catch (error) {
                        console.error('Error loading from localStorage:', error);
                    }
                },

                saveToLocalStorage() {
                    try {
                        Object.keys(this.data).forEach(key => {
                            localStorage.setItem(`db_${key}`, JSON.stringify(this.data[key]));
                        });
                    } catch (error) {
                        console.error('Error saving to localStorage:', error);
                    }
                },

                async getAll(tableName) {
                    return this.data[tableName] || [];
                },

                async add(tableName, item) {
                    if (!this.data[tableName]) this.data[tableName] = [];
                    item.id = item.id || generateId();
                    item.createdAt = item.createdAt || new Date().toISOString();
                    this.data[tableName].push(item);
                    this.saveToLocalStorage();
                    return item;
                },

                async update(tableName, id, updates) {
                    if (!this.data[tableName]) return null;
                    const index = this.data[tableName].findIndex(item => item.id == id);
                    if (index !== -1) {
                        this.data[tableName][index] = { ...this.data[tableName][index], ...updates, updatedAt: new Date().toISOString() };
                        this.saveToLocalStorage();
                        return this.data[tableName][index];
                    }
                    return null;
                },

                async delete(tableName, id) {
                    if (!this.data[tableName]) return false;
                    const index = this.data[tableName].findIndex(item => item.id == id);
                    if (index !== -1) {
                        this.data[tableName].splice(index, 1);
                        this.saveToLocalStorage();
                        return true;
                    }
                    return false;
                }
            };
        }

        // ====================================
        // UTILITY FUNCTIONS
        // ====================================

        // Format currency function
        function formatCurrency(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '‡∏ø0';
            }
            return '‡∏ø' + Number(amount).toLocaleString();
        }

        // Create placeholder image
        function createPlaceholderImage(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');

            // Fill background
            ctx.fillStyle = '#f3f4f6';
            ctx.fillRect(0, 0, 100, 100);

            // Add text
            ctx.fillStyle = '#6b7280';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text.substring(0, 10), 50, 55);

            return canvas.toDataURL();
        }

        // Show toast notification
        function showToast(message, type = 'info', duration = 3000) {
            Toast.show(message, type, duration);
        }

        // Format date function
        function formatDate(date) {
            if (!date) return '';
            return new Date(date).toLocaleDateString('th-TH');
        }

        // Format time function
        function formatTime(date) {
            if (!date) return '';
            return new Date(date).toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Validate email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Deep clone object
        function deepClone(obj) {
            if (obj === null || typeof obj !== 'object') return obj;
            if (obj instanceof Date) return new Date(obj);
            if (obj instanceof Array) return obj.map(item => deepClone(item));
            if (typeof obj === 'object') {
                const cloned = {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        cloned[key] = deepClone(obj[key]);
                    }
                }
                return cloned;
            }
        }

        // Application State
        const AppState = {
            currentScreen: 'dashboard-screen',
            cart: [],
            currentCustomer: null,
            menuItems: [],
            inventory: [],
            sales: [],
            expenses: [],
            customers: [],
            employees: [],
            suppliers: [],
            promotions: [],
            notifications: [],
            settings: {
                shopName: '‡∏£‡πâ‡∏≤‡∏ô Sandwich ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏°',
                shopPhone: '',
                shopAddress: '',
                taxRate: 7,
                currency: 'THB',
                businessHours: {
                    open: '06:00',
                    close: '20:00'
                },
                loyaltyPoints: {
                    enabled: true,
                    rate: 0.01 // 1% cashback
                }
            },
            // Chart references
            dashboardChart: null,
            salesChart: null,
            productsChart: null,
            salesReportChart: null,
            profitChart: null,
            costBreakdownChart: null
        };

        // Utility Functions
        const Utils = {
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('th-TH', {
                    style: 'currency',
                    currency: 'THB',
                    minimumFractionDigits: 0
                }).format(amount);
            },

            formatDate: (date) => {
                return new Intl.DateTimeFormat('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            },

            generateId: () => {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },

            createPlaceholderImage: (text = 'No Image', width = 100, height = 100) => {
                const svg = `
                    <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                        <rect width="100%" height="100%" fill="#e5e7eb"/>
                        <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" font-family="sans-serif" font-size="12" fill="#6b7280">
                            ${text.length > 15 ? text.substring(0, 15) + '...' : text}
                        </text>
                    </svg>
                `;
                return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
            },

            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Toast Notification System
        const Toast = {
            show: (message, type = 'success', duration = 3000) => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;

                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };

                toast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${icons[type] || icons.info}</span>
                        <span>${message}</span>
                    </div>
                `;

                container.appendChild(toast);

                // Trigger animation
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                // Auto remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            container.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            }
        };

        // Screen Navigation
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Show target screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                AppState.currentScreen = screenId;
            }

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const navItem = document.querySelector(`[data-screen="${screenId.replace('-screen', '')}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            // Load screen data
            switch(screenId) {
                case 'dashboard-screen':
                    loadDashboard();
                    break;
                case 'pos-screen':
                    loadPOSMenu();
                    break;
                case 'inventory-screen':
                    loadMenuItems();
                    loadIngredients();
                    refreshStockAlerts();
                    break;
                case 'reports-screen':
                    loadReports();
                    break;
                case 'cost-analysis-screen':
                    loadCostAnalysis();
                    break;
            }
        }

        // Make switchScreen globally available
        window.switchScreen = switchScreen;

        // Alias function for mobile navigation
        function showScreen(screenId) {
            // Convert short screen names to full screen IDs
            const screenMap = {
                'menu': 'dashboard-screen',
                'sales': 'pos-screen',
                'inventory': 'inventory-screen',
                'cost-analysis': 'cost-analysis-screen',
                'analytics': 'reports-screen'
            };

            const fullScreenId = screenMap[screenId] || screenId;
            switchScreen(fullScreenId);
        }

        // POS Functions
        async function loadPOSMenu() {
            try {
                if (!window.db || !window.db.isReady) {
                    console.log('‚è≥ Database not ready for POS menu, retrying...');
                    setTimeout(loadPOSMenu, 1000);
                    return;
                }

                const menuItems = await window.db.getAll('menu') || [];
                const container = document.getElementById('menu-container');

                if (!container) return;

                container.innerHTML = menuItems.map(item => `
                    <div class="menu-item" data-item-id="${item.id}">
                        <div class="menu-item-image">
                            <img src="${item.image || createPlaceholderImage(item.name)}"
                                 alt="${item.name}" loading="lazy" onerror="this.src='${createPlaceholderImage('No Image')}'">
                        </div>
                        <div class="menu-item-info">
                            <h4>${item.name}</h4>
                            <p class="price">${formatCurrency(item.price)}</p>
                            <button class="btn btn-primary btn-sm" onclick="addToCart('${item.id}')">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                    </div>
                `).join('');

                // Setup search functionality
                const searchInput = document.getElementById('menu-search');
                if (searchInput) {
                    searchInput.addEventListener('input', filterPOSMenu);
                }

            } catch (error) {
                console.error('‚ùå Error loading POS menu:', error);
            }
        }

        function filterPOSMenu() {
            const searchTerm = document.getElementById('menu-search').value.toLowerCase();
            const menuItems = document.querySelectorAll('#menu-container .menu-item');

            menuItems.forEach(item => {
                const itemName = item.querySelector('h4').textContent.toLowerCase();
                item.style.display = itemName.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function addToCart(itemId) {
            try {
                const menuItems = await window.db.getAll('menu') || [];
                const menuItem = menuItems.find(item => item.id == itemId);
                if (!menuItem) return;

                // Check if item already exists in cart
                const existingItem = AppState.cart.find(item => item.id === itemId);

                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    AppState.cart.push({
                        id: itemId,
                        name: menuItem.name,
                        price: menuItem.price,
                        quantity: 1
                    });
                }

                updateCartDisplay();
                showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${menuItem.name} ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');

            } catch (error) {
                console.error('‚ùå Error adding to cart:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function updateCartDisplay() {
            const cartContainer = document.getElementById('cart-items');
            const totalElement = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (!cartContainer || !totalElement || !checkoutBtn) return;

            if (AppState.cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
                totalElement.textContent = Utils.formatCurrency(0);
                checkoutBtn.disabled = true;
                return;
            }

            cartContainer.innerHTML = AppState.cart.map(item => `
                <div class="cart-item flex justify-between items-center p-2 border-b">
                    <div class="flex-1">
                        <h5 class="font-medium">${item.name}</h5>
                        <p class="text-sm text-gray-500">${Utils.formatCurrency(item.price)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm btn-outline" onclick="updateCartItemQuantity('${item.id}', -1)">-</button>
                        <span class="px-2">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline" onclick="updateCartItemQuantity('${item.id}', 1)">+</button>
                        <button class="btn btn-sm btn-error" onclick="removeFromCart('${item.id}')">üóë</button>
                    </div>
                </div>
            `).join('');

            const total = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalElement.textContent = Utils.formatCurrency(total);
            checkoutBtn.disabled = false;
        }

        function updateCartItemQuantity(itemId, change) {
            const item = AppState.cart.find(item => item.id === itemId);
            if (!item) return;

            item.quantity += change;

            if (item.quantity <= 0) {
                removeFromCart(itemId);
            } else {
                updateCartDisplay();
            }
        }

        function removeFromCart(itemId) {
            AppState.cart = AppState.cart.filter(item => item.id !== itemId);
            updateCartDisplay();
        }

        async function editIngredient(ingredientId) {
            try {
                const ingredients = await window.db.getAll('ingredients') || [];
                const ingredient = ingredients.find(item => item.id == ingredientId);
                if (!ingredient) return;

                const modalHTML = `
                    <div id="edit-ingredient-modal" class="modal active">
                        <div class="modal-backdrop" onclick="closeEditIngredientModal()"></div>
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                                <button class="modal-close" onclick="closeEditIngredientModal()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-ingredient-form">
                                    <input type="hidden" id="edit-ingredient-id" value="${ingredient.id}">
                                    <div class="form-group">
                                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                                        <input type="text" class="form-input" id="edit-ingredient-name" value="${ingredient.name}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                                        <input type="text" class="form-input" id="edit-ingredient-unit" value="${ingredient.unit}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                                        <input type="number" class="form-input" id="edit-ingredient-cost" value="${ingredient.cost_per_unit}" min="0" step="0.01" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                        <input type="number" class="form-input" id="edit-ingredient-quantity" value="${ingredient.quantity}" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
                                        <input type="number" class="form-input" id="edit-ingredient-min-stock" value="${ingredient.minimum_stock}" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                                        <input type="text" class="form-input" id="edit-ingredient-supplier" value="${ingredient.supplier || ''}">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeEditIngredientModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button type="button" class="btn btn-primary" onclick="saveEditedIngredient()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                console.error('‚ùå Error loading ingredient for edit:', error);
            }
        }

        function closeEditIngredientModal() {
            const modal = document.getElementById('edit-ingredient-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveEditedIngredient() {
            try {
                const id = document.getElementById('edit-ingredient-id').value;
                const ingredient = {
                    name: document.getElementById('edit-ingredient-name').value,
                    unit: document.getElementById('edit-ingredient-unit').value,
                    cost_per_unit: parseFloat(document.getElementById('edit-ingredient-cost').value),
                    quantity: parseInt(document.getElementById('edit-ingredient-quantity').value),
                    minimum_stock: parseInt(document.getElementById('edit-ingredient-min-stock').value),
                    supplier: document.getElementById('edit-ingredient-supplier').value
                };

                await window.db.update('ingredients', id, ingredient);
                showToast('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeEditIngredientModal();
                await loadIngredients();

            } catch (error) {
                console.error('‚ùå Error updating ingredient:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function restockIngredient(ingredientId) {
            try {
                const ingredients = await window.db.getAll('ingredients') || [];
                const ingredient = ingredients.find(item => item.id == ingredientId);
                if (!ingredient) return;

                const modalHTML = `
                    <div id="restock-modal" class="modal active">
                        <div class="modal-backdrop" onclick="closeRestockModal()"></div>
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ: ${ingredient.name}</h3>
                                <button class="modal-close" onclick="closeRestockModal()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <form id="restock-form">
                                    <input type="hidden" id="restock-ingredient-id" value="${ingredient.id}">
                                    <div class="form-group">
                                        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                        <input type="number" class="form-input" value="${ingredient.quantity}" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°</label>
                                        <input type="number" class="form-input" id="restock-amount" placeholder="0" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                                        <input type="text" class="form-input" id="restock-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°, ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Ñ">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeRestockModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button type="button" class="btn btn-primary" onclick="confirmRestock()">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                console.error('‚ùå Error loading ingredient for restock:', error);
            }
        }

        function closeRestockModal() {
            const modal = document.getElementById('restock-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function confirmRestock() {
            try {
                const ingredientId = document.getElementById('restock-ingredient-id').value;
                const additionalAmount = parseInt(document.getElementById('restock-amount').value);
                const note = document.getElementById('restock-note').value;

                if (!additionalAmount || additionalAmount <= 0) {
                    showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }

                const ingredient = await window.db.findById('ingredients', ingredientId);
                const newQuantity = ingredient.quantity + additionalAmount;

                await window.db.update('ingredients', ingredientId, {
                    quantity: newQuantity
                });

                // Record transaction
                await window.db.add('transactions', {
                    type: 'restock',
                    item_id: ingredientId,
                    item_name: ingredient.name,
                    quantity: additionalAmount,
                    note: note,
                    created_at: new Date().toISOString()
                });

                showToast(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ ${ingredient.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
                closeRestockModal();
                await loadIngredients();

            } catch (error) {
                console.error('‚ùå Error restocking ingredient:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Customer Functions
        function loadCustomers() {
            if (AppState.customers.length === 0) {
                // Initialize with sample customers
                AppState.customers = [
                    {
                        id: '1',
                        name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
                        phone: '081-234-5678',
                        email: 'somchai@email.com',
                        points: 150,
                        totalSpent: 1250,
                        visits: 25,
                        joinDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                        lastVisit: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
                    },
                    {
                        id: '2',
                        name: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                        phone: '082-345-6789',
                        email: 'somying@email.com',
                        points: 89,
                        totalSpent: 890,
                        visits: 18,
                        joinDate: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString(),
                        lastVisit: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
                    }
                ];
            }
            renderCustomers();
        }

        function renderCustomers(searchTerm = '') {
            const container = document.getElementById('customer-list');
            if (!container) return;

            const filteredCustomers = AppState.customers.filter(customer =>
                customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                customer.phone.includes(searchTerm)
            );

            container.innerHTML = filteredCustomers.map(customer => `
                <div class="customer-card" onclick="selectCustomer('${customer.id}')">
                    <div class="customer-header">
                        <div class="customer-info">
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-contact">${customer.phone}</div>
                            ${customer.email ? `<div class="customer-contact">${customer.email}</div>` : ''}
                        </div>
                        <div class="customer-stats">
                            <div class="stat-item">
                                <div class="stat-value">${customer.points}</div>
                                <div class="stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                            </div>
                        </div>
                    </div>
                    <div class="customer-footer">
                        <div class="customer-badges">
                            <div class="badge badge-primary">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏° ${customer.visits} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                            <div class="badge badge-secondary">${Utils.formatCurrency(customer.totalSpent)}</div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editCustomer('${customer.id}')">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function selectCustomer(customerId) {
            const customer = AppState.customers.find(c => c.id === customerId);
            if (!customer) return;

            AppState.currentCustomer = customer;

            // Update UI to show selected customer
            const customerDisplay = document.getElementById('selected-customer');
            if (customerDisplay) {
                customerDisplay.innerHTML = `
                    <div class="selected-customer-info">
                        <span class="customer-name">${customer.name}</span>
                        <span class="customer-points">${customer.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                        <button class="btn btn-sm btn-secondary" onclick="clearCustomer()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                `;
                customerDisplay.style.display = 'block';
            }

            Toast.show(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${customer.name}`, 'success');

            // Auto switch back to POS if on customer screen
            if (AppState.currentScreen === 'customer-screen') {
                switchScreen('pos-screen');
            }
        }

        function clearCustomer() {
            AppState.currentCustomer = null;
            const customerDisplay = document.getElementById('selected-customer');
            if (customerDisplay) {
                customerDisplay.style.display = 'none';
            }
            Toast.show('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'info');
        }

        function showAddCustomerModal() {
            const modal = document.getElementById('add-customer-modal');
            if (!modal) {
                console.error('Customer modal not found');
                return;
            }
            modal.classList.add('active');

            const form = document.getElementById('customer-form');
            if (form) {
                form.reset();
            }

            const customerIdField = document.getElementById('customer-id');
            if (customerIdField) {
                customerIdField.value = '';
            }

            const title = document.querySelector('#add-customer-modal .modal-title');
            if (title) {
                title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
            }
        }

        function editCustomer(customerId) {
            const customer = AppState.customers.find(c => c.id === customerId);
            if (!customer) return;

            document.getElementById('customer-modal').classList.add('active');
            document.getElementById('customer-id').value = customer.id;
            document.getElementById('customer-name').value = customer.name;
            document.getElementById('customer-phone').value = customer.phone;
            document.getElementById('customer-email').value = customer.email || '';
            document.querySelector('#customer-modal .modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
        }

        function closeCustomerModal() {
            document.getElementById('customer-modal').classList.remove('active');
        }

        function saveCustomer() {
            const form = document.getElementById('customer-form');
            const formData = new FormData(form);

            const customerData = {
                name: formData.get('name').trim(),
                phone: formData.get('phone').trim(),
                email: formData.get('email').trim()
            };

            // Validation
            if (!customerData.name || !customerData.phone) {
                Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', 'error');
                return;
            }

            const customerId = document.getElementById('customer-id').value;

            if (customerId) {
                // Edit existing customer
                const customerIndex = AppState.customers.findIndex(c => c.id === customerId);
                if (customerIndex > -1) {
                    AppState.customers[customerIndex] = {
                        ...AppState.customers[customerIndex],
                        ...customerData
                    };
                    Toast.show('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            } else {
                // Add new customer
                const newCustomer = {
                    id: Utils.generateId(),
                    ...customerData,
                    points: 0,
                    totalSpent: 0,
                    visits: 0,
                    joinDate: new Date().toISOString(),
                    lastVisit: null
                };

                AppState.customers.push(newCustomer);
                Toast.show('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }

            closeCustomerModal();
            renderCustomers();
        }

        function deleteCustomer(customerId) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            const customerIndex = AppState.customers.findIndex(c => c.id === customerId);
            if (customerIndex > -1) {
                AppState.customers.splice(customerIndex, 1);
                renderCustomers();
                Toast.show('‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        // Inventory Functions
        function loadInventory() {
            if (AppState.inventory.length === 0) {
                // Initialize with sample inventory
                AppState.inventory = [
                    {
                        id: '1',
                        name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä',
                        category: 'ingredient',
                        unit: '‡πÅ‡∏û‡πá‡∏Ñ',
                        currentStock: 15,
                        minStock: 5,
                        maxStock: 50,
                        costPrice: 35,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà A',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: '‡∏´‡∏°‡∏π‡πÅ‡∏Æ‡∏°',
                        category: 'ingredient',
                        unit: '‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°',
                        currentStock: 3.5,
                        minStock: 1,
                        maxStock: 10,
                        costPrice: 180,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏î B',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '3',
                        name: '‡πÑ‡∏Å‡πà‡∏™‡πÑ‡∏•‡∏ã‡πå',
                        category: 'ingredient',
                        unit: '‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°',
                        currentStock: 2,
                        minStock: 1,
                        maxStock: 8,
                        costPrice: 150,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏î B',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '4',
                        name: '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î',
                        category: 'ingredient',
                        unit: '‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°',
                        currentStock: 1.2,
                        minStock: 0.5,
                        maxStock: 5,
                        costPrice: 40,
                        supplier: '‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î C',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '5',
                        name: '‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤',
                        category: 'beverage',
                        unit: '‡∏Ç‡∏ß‡∏î',
                        currentStock: 48,
                        minStock: 12,
                        maxStock: 100,
                        costPrice: 5,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡πâ‡∏≥‡πÅ‡∏£‡πà D',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        id: '6',
                        name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏Å‡πä‡∏™',
                        category: 'beverage',
                        unit: '‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á',
                        currentStock: 24,
                        minStock: 6,
                        maxStock: 60,
                        costPrice: 8,
                        supplier: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° E',
                        lastUpdated: new Date().toISOString()
                    }
                ];
            }
            renderInventory();
        }

        function renderInventory(searchTerm = '') {
            const container = document.getElementById('inventory-list');
            if (!container) return;

            const filteredItems = AppState.inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.category.toLowerCase().includes(searchTerm.toLowerCase())
            );

            container.innerHTML = filteredItems.map(item => {
                const stockLevel = getStockLevel(item);
                const stockClass = stockLevel === 'low' ? 'text-red-500' :
                                 stockLevel === 'medium' ? 'text-yellow-500' : 'text-green-500';

                return `
                    <div class="inventory-item">
                        <div class="inventory-header">
                            <div class="inventory-info">
                                <div class="inventory-name">${item.name}</div>
                                <div class="inventory-details">
                                    <span class="badge badge-secondary">${item.category}</span>
                                    <span class="text-gray-500">${item.supplier}</span>
                                </div>
                            </div>
                            <div class="inventory-actions">
                                <button class="btn btn-sm btn-secondary" onclick="editInventoryItem('${item.id}')">
                                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                            </div>
                        </div>
                        <div class="inventory-stats">
                            <div class="stat-group">
                                <div class="stat-item">
                                    <div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                                    <div class="stat-value ${stockClass}">${item.currentStock} ${item.unit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
                                    <div class="stat-value">${Utils.formatCurrency(item.costPrice)}</div>
                                </div>
                            </div>
                            <div class="inventory-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill ${stockLevel}" style="width: ${(item.currentStock / item.maxStock) * 100}%"></div>
                                </div>
                                <div class="progress-labels">
                                    <span>‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: ${item.minStock}</span>
                                    <span>‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${item.maxStock}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show low stock alerts
            const lowStockItems = AppState.inventory.filter(item => getStockLevel(item) === 'low');
            if (lowStockItems.length > 0) {
                const alertContainer = document.getElementById('stock-alerts');
                if (alertContainer) {
                    alertContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î:</strong>
                            ${lowStockItems.map(item => `${item.name} (${item.currentStock} ${item.unit})`).join(', ')}
                        </div>
                    `;
                }
            }
        }

        function getStockLevel(item) {
            const ratio = item.currentStock / item.minStock;
            if (ratio <= 1) return 'low';
            if (ratio <= 2) return 'medium';
            return 'high';
        }

        function showAddInventoryModal() {
            document.getElementById('inventory-modal').classList.add('active');
            document.getElementById('inventory-form').reset();
            document.getElementById('inventory-id').value = '';
            document.querySelector('#inventory-modal .modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
        }

        function editInventoryItem(itemId) {
            const item = AppState.inventory.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('inventory-modal').classList.add('active');
            document.getElementById('inventory-id').value = item.id;
            document.getElementById('inventory-name').value = item.name;
            document.getElementById('inventory-category').value = item.category;
            document.getElementById('inventory-unit').value = item.unit;
            document.getElementById('inventory-current-stock').value = item.currentStock;
            document.getElementById('inventory-min-stock').value = item.minStock;
            document.getElementById('inventory-max-stock').value = item.maxStock;
            document.getElementById('inventory-cost-price').value = item.costPrice;
            document.getElementById('inventory-supplier').value = item.supplier;
            document.querySelector('#inventory-modal .modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
        }

        function closeInventoryModal() {
            document.getElementById('inventory-modal').classList.remove('active');
        }

        function saveInventoryItem() {
            const form = document.getElementById('inventory-form');
            const formData = new FormData(form);

            const itemData = {
                name: formData.get('name').trim(),
                category: formData.get('category').trim(),
                unit: formData.get('unit').trim(),
                currentStock: parseFloat(formData.get('currentStock')) || 0,
                minStock: parseFloat(formData.get('minStock')) || 0,
                maxStock: parseFloat(formData.get('maxStock')) || 0,
                costPrice: parseFloat(formData.get('costPrice')) || 0,
                supplier: formData.get('supplier').trim(),
                lastUpdated: new Date().toISOString()
            };

            // Validation
            if (!itemData.name || !itemData.unit) {
                Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢', 'error');
                return;
            }

            const itemId = document.getElementById('inventory-id').value;

            if (itemId) {
                // Edit existing item
                const itemIndex = AppState.inventory.findIndex(i => i.id === itemId);
                if (itemIndex > -1) {
                    AppState.inventory[itemIndex] = {
                        ...AppState.inventory[itemIndex],
                        ...itemData
                    };
                    Toast.show('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            } else {
                // Add new item
                const newItem = {
                    id: Utils.generateId(),
                    ...itemData
                };

                AppState.inventory.push(newItem);
                Toast.show('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }

            closeInventoryModal();
            renderInventory();
        }
        async function loadDashboard() {
            if (!window.db || !window.db.isReady) {
                console.log('‚è≥ Database not ready yet, retrying...');
                setTimeout(loadDashboard, 1000);
                return;
            }

            try {
                // Get dashboard data from local database
                const dashboardData = await window.db.getDashboardData();

                // Update UI elements
                document.getElementById('today-sales').textContent = Utils.formatCurrency(dashboardData.todaySales);
                document.getElementById('today-orders').textContent = dashboardData.salesCount.toString();
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('th-TH');

                // Update low stock alerts
                if (dashboardData.lowStockCount > 0) {
                    showToast(`‚ö†Ô∏è ‡∏°‡∏µ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ${dashboardData.lowStockCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
                }

                // Load sales chart with real data
                loadSalesChart();

                // Load additional dashboard components
                await loadTodaysStats();

                console.log('‚úÖ Dashboard loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading dashboard:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function loadTodaysStats() {
            try {
                const sales = await window.db.getAll('sales') || [];
                const today = new Date().toDateString();
                const todaySales = sales.filter(sale =>
                    new Date(sale.completedAt).toDateString() === today
                );

                // Calculate stats
                const salesCount = todaySales.length;
                const revenue = todaySales.reduce((sum, sale) => sum + sale.total, 0);
                const avgOrderValue = salesCount > 0 ? revenue / salesCount : 0;

                // Find peak hour
                const hourlyStats = {};
                todaySales.forEach(sale => {
                    const hour = new Date(sale.completedAt).getHours();
                    hourlyStats[hour] = (hourlyStats[hour] || 0) + 1;
                });

                const peakHour = Object.keys(hourlyStats).reduce((peak, hour) =>
                    hourlyStats[hour] > (hourlyStats[peak] || 0) ? hour : peak, '');

                // Update UI
                document.getElementById('today-sales-count').textContent = salesCount;
                document.getElementById('today-revenue').textContent = Utils.formatCurrency(revenue);
                document.getElementById('avg-order-value').textContent = Utils.formatCurrency(avgOrderValue);
                document.getElementById('peak-hour-today').textContent = peakHour ? `${peakHour}:00` : '-';

            } catch (error) {
                console.error('‚ùå Error loading today\'s stats:', error);
            }
        }

        function loadSalesChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (AppState.dashboardChart) {
                AppState.dashboardChart.destroy();
            }

            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded, skipping chart creation');
                return;
            }

            // Generate sample data for last 7 days
            const labels = [];
            const data = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' }));

                // Sample data - replace with real data
                data.push(Math.floor(Math.random() * 5000) + 1000);
            }

            try {
                AppState.dashboardChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                            data: data,
                            borderColor: '#0c8ce9',
                            backgroundColor: 'rgba(12, 140, 233, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating dashboard chart:', error);
                // Show fallback content or hide chart container
                if (ctx && ctx.canvas) {
                    ctx.canvas.style.display = 'none';
                }
            }
        }

        // POS Functions
        function loadMenu() {
            if (AppState.menuItems.length === 0) {
                // Initialize with sample menu items
                AppState.menuItems = [
                    { id: '1', name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏´‡∏°‡∏π', price: 35, cost: 20, category: 'sandwich', image: 'ü•™', description: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏´‡∏°‡∏π‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ú‡∏±‡∏Å' },
                    { id: '2', name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà', price: 40, cost: 22, category: 'sandwich', image: 'ü•™', description: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏ó‡∏≠‡∏£‡∏¥‡∏¢‡∏≤‡∏Å‡∏¥' },
                    { id: '3', name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Ç‡πà', price: 25, cost: 12, category: 'sandwich', image: 'ü•™', description: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ú‡∏±‡∏Å‡∏™‡∏î' },
                    { id: '4', name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤', price: 45, cost: 25, category: 'sandwich', image: 'ü•™', description: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤‡∏ú‡∏™‡∏°‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™' },
                    { id: '5', name: '‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤', price: 10, cost: 5, category: 'drink', image: 'üíß', description: '‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°‡∏Ç‡∏ß‡∏î 600ml' },
                    { id: '6', name: '‡πÇ‡∏Ñ‡πâ‡∏Å', price: 15, cost: 8, category: 'drink', image: 'ü•§', description: '‡πÇ‡∏Ñ‡πâ‡∏Å‡πÄ‡∏¢‡πá‡∏ô‡∏Ç‡∏ß‡∏î 325ml' },
                    { id: '7', name: '‡∏Å‡∏≤‡πÅ‡∏ü', price: 20, cost: 8, category: 'drink', image: '‚òï', description: '‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏≥‡∏£‡πâ‡∏≠‡∏ô' },
                    { id: '8', name: '‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô', price: 18, cost: 7, category: 'drink', image: 'üßä', description: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏¢‡πá‡∏ô‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô' }
                ];
            }

            renderMenu();
        }

        function renderMenu(searchTerm = '') {
            const container = document.getElementById('menu-container');
            const filteredItems = AppState.menuItems.filter(item =>
                item.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            container.innerHTML = filteredItems.map(item => `
                <div class="menu-item" onclick="addToCart('${item.id}')">
                    <div class="menu-item-image">${item.image}</div>
                    <div class="menu-item-name">${item.name}</div>
                    <div class="menu-item-price">${Utils.formatCurrency(item.price)}</div>
                    <div class="text-xs text-gray-500 mt-1">${item.description || ''}</div>
                </div>
            `).join('');
        }

        function addToCart(itemId) {
            const item = AppState.menuItems.find(item => item.id === itemId);
            if (!item) return;

            const existingItem = AppState.cart.find(cartItem => cartItem.id === itemId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                AppState.cart.push({ ...item, quantity: 1 });
            }

            updateCart();
            Toast.show(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${item.name} ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        }

        function removeFromCart(itemId) {
            const itemIndex = AppState.cart.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                const item = AppState.cart[itemIndex];
                if (item.quantity > 1) {
                    item.quantity -= 1;
                } else {
                    AppState.cart.splice(itemIndex, 1);
                }
                updateCart();
            }
        }

        function updateCart() {
            const container = document.getElementById('cart-items');
            const totalElement = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (AppState.cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
                totalElement.textContent = Utils.formatCurrency(0);
                checkoutBtn.disabled = true;
                return;
            }

            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * (AppState.settings.taxRate / 100);
            const total = subtotal + tax;

            container.innerHTML = AppState.cart.map(item => `
                <div class="flex items-center justify-between py-2 border-b border-gray-100">
                    <div class="flex-1">
                        <div class="font-medium">${item.name}</div>
                        <div class="text-sm text-gray-500">${Utils.formatCurrency(item.price)} √ó ${item.quantity}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm btn-secondary" onclick="removeFromCart('${item.id}')">-</button>
                        <span class="font-medium">${Utils.formatCurrency(item.price * item.quantity)}</span>
                    </div>
                </div>
            `).join('');

            // Add tax info if applicable
            if (AppState.settings.taxRate > 0) {
                container.innerHTML += `
                    <div class="pt-2 mt-2 border-t border-gray-200">
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                            <span>${Utils.formatCurrency(subtotal)}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>‡∏†‡∏≤‡∏©‡∏µ (${AppState.settings.taxRate}%):</span>
                            <span>${Utils.formatCurrency(tax)}</span>
                        </div>
                    </div>
                `;
            }

            totalElement.textContent = Utils.formatCurrency(total);
            checkoutBtn.disabled = false;
        }

        function processPayment() {
            if (AppState.cart.length === 0) return;

            // Show payment modal instead of immediate processing
            showPaymentModal();
        }

        function showPaymentModal() {
            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * (AppState.settings.taxRate / 100);
            const total = subtotal + tax;

            document.getElementById('payment-total').textContent = Utils.formatCurrency(total);
            document.getElementById('payment-modal').classList.add('active');

            // Reset payment form
            selectPaymentMethod('cash');
            document.getElementById('cash-received').value = '';
            document.getElementById('change-amount').textContent = Utils.formatCurrency(0);
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.remove('active');
        }

        function selectPaymentMethod(method) {
            // Update UI
            document.querySelectorAll('.payment-method').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');

            // Show/hide payment sections
            document.querySelectorAll('.payment-section').forEach(section => {
                section.classList.remove('active');
            });

            if (method === 'cash') {
                document.getElementById('cash-payment').classList.add('active');
            }

            AppState.currentPaymentMethod = method;
        }

        function calculateChange() {
            const total = parseFloat(document.getElementById('payment-total').textContent.replace(/[^0-9.-]+/g, ''));
            const received = parseFloat(document.getElementById('cash-received').value) || 0;
            const change = Math.max(0, received - total);

            document.getElementById('change-amount').textContent = Utils.formatCurrency(change);
        }

        function toggleDiscount() {
            const checkbox = document.getElementById('apply-discount');
            const section = document.getElementById('discount-section');

            if (checkbox.checked) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
                applyDiscount(); // Reset discount
            }
        }

        function applyDiscount() {
            const checkbox = document.getElementById('apply-discount');
            if (!checkbox.checked) return;

            const discountAmount = parseFloat(document.getElementById('discount-amount').value) || 0;
            const discountType = document.getElementById('discount-type').value;
            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            let discount = 0;
            if (discountType === 'percent') {
                discount = subtotal * (discountAmount / 100);
            } else {
                discount = discountAmount;
            }

            const tax = (subtotal - discount) * (AppState.settings.taxRate / 100);
            const total = Math.max(0, subtotal - discount + tax);

            document.getElementById('payment-total').textContent = Utils.formatCurrency(total);
            calculateChange();
        }

        async function confirmPayment() {
            const total = parseFloat(document.getElementById('payment-total').textContent.replace(/[^0-9.-]+/g, ''));
            const paymentMethod = AppState.currentPaymentMethod || 'cash';

            // Validate payment
            if (paymentMethod === 'cash') {
                const received = parseFloat(document.getElementById('cash-received').value) || 0;
                if (received < total) {
                    Toast.show('‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error');
                    return;
                }
            }

            const sale = {
                id: Utils.generateId(),
                items: [...AppState.cart],
                subtotal: AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                tax: total - AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                discount: 0, // Calculate from form if needed
                total: total,
                paymentMethod: paymentMethod,
                customerId: AppState.currentCustomer?.id || null,
                date: new Date().toISOString(),
                cashReceived: paymentMethod === 'cash' ? parseFloat(document.getElementById('cash-received').value) || 0 : total,
                change: paymentMethod === 'cash' ? Math.max(0, (parseFloat(document.getElementById('cash-received').value) || 0) - total) : 0
            };

            // Add loyalty points if customer is selected
            if (AppState.currentCustomer && AppState.settings.loyaltyPoints.enabled) {
                const pointsEarned = Math.floor(total * AppState.settings.loyaltyPoints.rate);
                AppState.currentCustomer.points = (AppState.currentCustomer.points || 0) + pointsEarned;

                if (pointsEarned > 0) {
                    Toast.show(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${pointsEarned} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, 'success');
                }
            }

            AppState.sales.push(sale);

            // Process inventory deduction for each item
            await processInventoryDeduction(AppState.cart);

            AppState.cart = [];
            AppState.currentCustomer = null;

            updateCart();
            closePaymentModal();

            Toast.show(`‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${Utils.formatCurrency(total)}`, 'success');

            // Print receipt (simulated)
            printReceipt(sale);

            // Auto switch to dashboard after payment
            setTimeout(() => {
                switchScreen('dashboard-screen');
            }, 2000);
        }

        // Inventory Management Functions
        async function processInventoryDeduction(cartItems) {
            try {
                for (const cartItem of cartItems) {
                    if (cartItem.isCustom) {
                        // Handle custom sandwiches with ingredient breakdown
                        await deductCustomSandwichIngredients(cartItem);
                    } else {
                        // Handle regular menu items with recipes
                        await deductMenuItemIngredients(cartItem);
                    }
                }

                // Check for low stock alerts after deduction
                await checkLowStockAlerts();

            } catch (error) {
                console.error('‚ùå Error processing inventory deduction:', error);
                Toast.show('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡πÑ‡∏î‡πâ', 'warning');
            }
        }

        async function deductCustomSandwichIngredients(cartItem) {
            if (!cartItem.ingredients) return;

            for (const ingredient of cartItem.ingredients) {
                try {
                    const currentIngredient = await window.db.findById('ingredients', ingredient.id);
                    if (currentIngredient) {
                        const newQuantity = Math.max(0, currentIngredient.quantity - (ingredient.quantity * cartItem.quantity));
                        await window.db.update('ingredients', ingredient.id, {
                            quantity: newQuantity
                        });

                        // Log usage
                        await logIngredientUsage(ingredient.id, ingredient.quantity * cartItem.quantity, 'sale');
                    }
                } catch (error) {
                    console.error(`Error deducting ingredient ${ingredient.id}:`, error);
                }
            }
        }

        async function deductMenuItemIngredients(cartItem) {
            try {
                // Get recipe for this menu item from database
                const recipes = await window.db.query('recipes', 'menu_item_id', cartItem.id);

                for (const recipe of recipes) {
                    const ingredient = await window.db.findById('ingredients', recipe.ingredient_id);
                    if (ingredient) {
                        const totalUsage = recipe.quantity * cartItem.quantity;
                        const newQuantity = Math.max(0, ingredient.quantity - totalUsage);

                        await window.db.update('ingredients', recipe.ingredient_id, {
                            quantity: newQuantity
                        });

                        // Log usage
                        await logIngredientUsage(recipe.ingredient_id, totalUsage, 'sale');
                    }
                }
            } catch (error) {
                console.error(`Error deducting ingredients for menu item ${cartItem.id}:`, error);
            }
        }

        async function logIngredientUsage(ingredientId, quantity, type) {
            try {
                const usageLog = {
                    id: Utils.generateId(),
                    ingredient_id: ingredientId,
                    quantity: quantity,
                    type: type, // 'sale', 'waste', 'adjustment'
                    date: new Date().toISOString(),
                    notes: `‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢`
                };

                await window.db.create('ingredient_usage', usageLog);
            } catch (error) {
                console.error('Error logging ingredient usage:', error);
            }
        }

        async function checkLowStockAlerts() {
            try {
                const ingredients = await window.db.getAll('ingredients');
                const lowStockItems = ingredients.filter(item =>
                    item.quantity <= item.minimum_stock
                );

                if (lowStockItems.length > 0) {
                    const outOfStock = lowStockItems.filter(item => item.quantity === 0);
                    const lowStock = lowStockItems.filter(item => item.quantity > 0);

                    if (outOfStock.length > 0) {
                        Toast.show(`üö® ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏°‡∏î: ${outOfStock.map(i => i.name).join(', ')}`, 'error', 8000);
                    }

                    if (lowStock.length > 0) {
                        Toast.show(`‚ö†Ô∏è ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î: ${lowStock.map(i => i.name).join(', ')}`, 'warning', 6000);
                    }
                }
            } catch (error) {
                console.error('Error checking low stock:', error);
            }
        }

        function printReceipt(sale) {
            console.log('=== ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ===');
            console.log(`‡∏£‡πâ‡∏≤‡∏ô: ${AppState.settings.shopName}`);
            console.log(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${Utils.formatDate(new Date(sale.date))}`);
            console.log(`‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: ${sale.id}`);
            console.log('========================');

            sale.items.forEach(item => {
                console.log(`${item.name} x${item.quantity} = ${Utils.formatCurrency(item.price * item.quantity)}`);
            });

            console.log('========================');
            console.log(`‡∏£‡∏ß‡∏°: ${Utils.formatCurrency(sale.subtotal)}`);
            if (sale.tax > 0) {
                console.log(`‡∏†‡∏≤‡∏©‡∏µ: ${Utils.formatCurrency(sale.tax)}`);
            }
            console.log(`‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ${Utils.formatCurrency(sale.total)}`);
            console.log(`‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${getPaymentMethodLabel(sale.paymentMethod)}`);
            if (sale.paymentMethod === 'cash') {
                console.log(`‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: ${Utils.formatCurrency(sale.cashReceived)}`);
                console.log(`‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${Utils.formatCurrency(sale.change)}`);
            }
            console.log('========================');
            console.log('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£');
        }

        function getPaymentMethodLabel(method) {
            const labels = {
                cash: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
                card: '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï/‡πÄ‡∏î‡∏ö‡∏¥‡∏ï',
                transfer: '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
                qr: 'QR Code'
            };
            return labels[method] || method;
        }

        // Custom Sandwich Builder Functions
        let customSandwichBuilder = {
            selectedIngredients: [],
            totalCost: 0,
            totalPrice: 0
        };

        async function showCustomSandwichBuilder() {
            // Reset builder state
            customSandwichBuilder = {
                selectedIngredients: [],
                totalCost: 0,
                totalPrice: 0
            };

            try {
                const ingredients = await window.db.getAll('ingredients');
                const bread = ingredients.filter(i => i.category === '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á');
                const meats = ingredients.filter(i => i.category === '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå');
                const vegetables = ingredients.filter(i => i.category === '‡∏ú‡∏±‡∏Å');
                const dairy = ingredients.filter(i => i.category === '‡∏ô‡∏°');
                const condiments = ingredients.filter(i => i.category === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á');
                const other = ingredients.filter(i => !['‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå', '‡∏ú‡∏±‡∏Å', '‡∏ô‡∏°', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á'].includes(i.category));

                const modalHTML = `
                    <div id="custom-sandwich-modal" class="modal active">
                        <div class="modal-backdrop" onclick="closeCustomSandwichBuilder()"></div>
                        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h3 class="modal-title">ü•™ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÄ‡∏≠‡∏á</h3>
                                <button class="modal-close" onclick="closeCustomSandwichBuilder()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Ingredient Selection -->
                                    <div>
                                        <h4 class="text-lg font-semibold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h4>

                                        <!-- Bread Selection -->
                                        <div class="mb-6">
                                            <h5 class="font-medium text-primary mb-2">üçû ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1)</h5>
                                            <div class="grid grid-cols-1 gap-2">
                                                ${bread.map(ingredient => `
                                                    <label class="ingredient-option" data-category="bread" data-max="1">
                                                        <input type="radio" name="bread" value="${ingredient.id}"
                                                               data-cost="${ingredient.cost_per_unit}"
                                                               data-name="${ingredient.name}"
                                                               onchange="updateCustomSandwich()">
                                                        <div class="ingredient-card">
                                                            <div class="flex justify-between items-center">
                                                                <span>${ingredient.name}</span>
                                                                <span class="text-sm text-gray-500">+${Utils.formatCurrency(ingredient.cost_per_unit * 1.5)}</span>
                                                            </div>
                                                            <div class="text-xs text-gray-400">${ingredient.unit} | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${ingredient.quantity}</div>
                                                        </div>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <!-- Meat Selection -->
                                        <div class="mb-6">
                                            <h5 class="font-medium text-primary mb-2">ü•ì ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢)</h5>
                                            <div class="grid grid-cols-1 gap-2">
                                                ${meats.map(ingredient => `
                                                    <label class="ingredient-option">
                                                        <input type="checkbox" value="${ingredient.id}"
                                                               data-cost="${ingredient.cost_per_unit}"
                                                               data-name="${ingredient.name}"
                                                               onchange="updateCustomSandwich()">
                                                        <div class="ingredient-card">
                                                            <div class="flex justify-between items-center">
                                                                <span>${ingredient.name}</span>
                                                                <span class="text-sm text-gray-500">+${Utils.formatCurrency(ingredient.cost_per_unit * 1.5)}</span>
                                                            </div>
                                                            <div class="text-xs text-gray-400">${ingredient.unit} | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${ingredient.quantity}</div>
                                                            <div class="mt-2 flex items-center gap-2">
                                                                <label class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                                                                <input type="number" class="quantity-input" min="1" max="5" value="1"
                                                                       onchange="updateCustomSandwich()"
                                                                       data-ingredient="${ingredient.id}">
                                                            </div>
                                                        </div>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <!-- Vegetables Selection -->
                                        <div class="mb-6">
                                            <h5 class="font-medium text-primary mb-2">ü•¨ ‡∏ú‡∏±‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢)</h5>
                                            <div class="grid grid-cols-1 gap-2">
                                                ${vegetables.map(ingredient => `
                                                    <label class="ingredient-option">
                                                        <input type="checkbox" value="${ingredient.id}"
                                                               data-cost="${ingredient.cost_per_unit}"
                                                               data-name="${ingredient.name}"
                                                               onchange="updateCustomSandwich()">
                                                        <div class="ingredient-card">
                                                            <div class="flex justify-between items-center">
                                                                <span>${ingredient.name}</span>
                                                                <span class="text-sm text-gray-500">+${Utils.formatCurrency(ingredient.cost_per_unit * 1.5)}</span>
                                                            </div>
                                                            <div class="text-xs text-gray-400">${ingredient.unit} | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${ingredient.quantity}</div>
                                                            <div class="mt-2 flex items-center gap-2">
                                                                <label class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                                                                <input type="number" class="quantity-input" min="1" max="5" value="1"
                                                                       onchange="updateCustomSandwich()"
                                                                       data-ingredient="${ingredient.id}">
                                                            </div>
                                                        </div>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <!-- Dairy Selection -->
                                        <div class="mb-6">
                                            <h5 class="font-medium text-primary mb-2">üßÄ ‡∏ô‡∏°‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</h5>
                                            <div class="grid grid-cols-1 gap-2">
                                                ${dairy.map(ingredient => `
                                                    <label class="ingredient-option">
                                                        <input type="checkbox" value="${ingredient.id}"
                                                               data-cost="${ingredient.cost_per_unit}"
                                                               data-name="${ingredient.name}"
                                                               onchange="updateCustomSandwich()">
                                                        <div class="ingredient-card">
                                                            <div class="flex justify-between items-center">
                                                                <span>${ingredient.name}</span>
                                                                <span class="text-sm text-gray-500">+${Utils.formatCurrency(ingredient.cost_per_unit * 1.5)}</span>
                                                            </div>
                                                            <div class="text-xs text-gray-400">${ingredient.unit} | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${ingredient.quantity}</div>
                                                            <div class="mt-2 flex items-center gap-2">
                                                                <label class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                                                                <input type="number" class="quantity-input" min="1" max="5" value="1"
                                                                       onchange="updateCustomSandwich()"
                                                                       data-ingredient="${ingredient.id}">
                                                            </div>
                                                        </div>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <!-- Condiments Selection -->
                                        <div class="mb-6">
                                            <h5 class="font-medium text-primary mb-2">üßà ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢)</h5>
                                            <div class="grid grid-cols-1 gap-2">
                                                ${condiments.map(ingredient => `
                                                    <label class="ingredient-option">
                                                        <input type="checkbox" value="${ingredient.id}"
                                                               data-cost="${ingredient.cost_per_unit}"
                                                               data-name="${ingredient.name}"
                                                               onchange="updateCustomSandwich()">
                                                        <div class="ingredient-card">
                                                            <div class="flex justify-between items-center">
                                                                <span>${ingredient.name}</span>
                                                                <span class="text-sm text-gray-500">+${Utils.formatCurrency(ingredient.cost_per_unit * 1.5)}</span>
                                                            </div>
                                                            <div class="text-xs text-gray-400">${ingredient.unit} | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${ingredient.quantity}</div>
                                                            <div class="mt-2 flex items-center gap-2">
                                                                <label class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                                                                <input type="number" class="quantity-input" min="1" max="5" value="1"
                                                                       onchange="updateCustomSandwich()"
                                                                       data-ingredient="${ingredient.id}">
                                                            </div>
                                                        </div>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Order Summary -->
                                    <div>
                                        <div class="sticky top-0 bg-white">
                                            <h4 class="text-lg font-semibold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h4>

                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="font-medium mb-3">ü•™ ‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÄ‡∏â‡∏û‡∏≤‡∏∞</h5>
                                                    <div id="custom-sandwich-summary" class="mb-4">
                                                        <p class="text-gray-500 text-center py-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä</p>
                                                    </div>

                                                    <div class="border-t pt-4">
                                                        <div class="flex justify-between items-center mb-2">
                                                            <span class="text-sm text-gray-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô:</span>
                                                            <span class="text-sm" id="custom-cost">‡∏ø0</span>
                                                        </div>
                                                        <div class="flex justify-between items-center mb-4">
                                                            <span class="font-semibold">‡∏£‡∏≤‡∏Ñ‡∏≤:</span>
                                                            <span class="text-xl font-bold text-primary" id="custom-price">‡∏ø0</span>
                                                        </div>

                                                        <button class="btn btn-success btn-lg w-full"
                                                                onclick="addCustomSandwichToCart()"
                                                                id="add-custom-btn" disabled>
                                                            ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Add custom styling for ingredient cards
                if (!document.getElementById('custom-sandwich-styles')) {
                    const styles = `
                        <style id="custom-sandwich-styles">
                            .ingredient-option {
                                display: block;
                                cursor: pointer;
                            }

                            .ingredient-card {
                                border: 2px solid #e5e7eb;
                                border-radius: 8px;
                                padding: 12px;
                                transition: all 0.2s;
                                background: white;
                            }

                            .ingredient-option input:checked + .ingredient-card {
                                border-color: #3b82f6;
                                background-color: #eff6ff;
                            }

                            .ingredient-option input {
                                display: none;
                            }

                            .quantity-input {
                                width: 60px;
                                padding: 4px 8px;
                                border: 1px solid #d1d5db;
                                border-radius: 4px;
                                text-align: center;
                            }
                        </style>
                    `;
                    document.head.insertAdjacentHTML('beforeend', styles);
                }

            } catch (error) {
                console.error('‚ùå Error showing custom sandwich builder:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function closeCustomSandwichBuilder() {
            const modal = document.getElementById('custom-sandwich-modal');
            if (modal) {
                modal.remove();
            }
        }

        function updateCustomSandwich() {
            try {
                const selectedIngredients = [];
                let totalCost = 0;
                let totalPrice = 0;

                // Check bread selection (required)
                const breadRadio = document.querySelector('input[name="bread"]:checked');
                if (!breadRadio) {
                    document.getElementById('custom-sandwich-summary').innerHTML =
                        '<p class="text-red-500 text-center py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô</p>';
                    document.getElementById('add-custom-btn').disabled = true;
                    return;
                }

                // Add bread
                const breadCost = parseFloat(breadRadio.dataset.cost);
                selectedIngredients.push({
                    id: breadRadio.value,
                    name: breadRadio.dataset.name,
                    quantity: 1,
                    cost: breadCost,
                    price: breadCost * 1.5
                });
                totalCost += breadCost;
                totalPrice += breadCost * 1.5;

                // Check other ingredients
                const otherInputs = document.querySelectorAll('#custom-sandwich-modal input[type="checkbox"]:checked');
                otherInputs.forEach(input => {
                    const cost = parseFloat(input.dataset.cost);
                    const quantity = parseInt(document.querySelector(`input[data-ingredient="${input.value}"]`)?.value || 1);

                    selectedIngredients.push({
                        id: input.value,
                        name: input.dataset.name,
                        quantity: quantity,
                        cost: cost * quantity,
                        price: cost * quantity * 1.5
                    });

                    totalCost += cost * quantity;
                    totalPrice += cost * quantity * 1.5;
                });

                // Update summary
                const summaryHTML = selectedIngredients.map(ingredient => `
                    <div class="flex justify-between items-center text-sm mb-2">
                        <span>${ingredient.name} ${ingredient.quantity > 1 ? `x${ingredient.quantity}` : ''}</span>
                        <span>${Utils.formatCurrency(ingredient.price)}</span>
                    </div>
                `).join('');

                document.getElementById('custom-sandwich-summary').innerHTML = summaryHTML;
                document.getElementById('custom-cost').textContent = Utils.formatCurrency(totalCost);
                document.getElementById('custom-price').textContent = Utils.formatCurrency(totalPrice);

                // Update global state
                customSandwichBuilder.selectedIngredients = selectedIngredients;
                customSandwichBuilder.totalCost = totalCost;
                customSandwichBuilder.totalPrice = totalPrice;

                // Enable add button
                document.getElementById('add-custom-btn').disabled = selectedIngredients.length === 0;

            } catch (error) {
                console.error('‚ùå Error updating custom sandwich:', error);
            }
        }

        function addCustomSandwichToCart() {
            if (customSandwichBuilder.selectedIngredients.length === 0) return;

            const customSandwich = {
                id: 'custom_' + Utils.generateId(),
                name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÄ‡∏â‡∏û‡∏≤‡∏∞',
                price: customSandwichBuilder.totalPrice,
                cost: customSandwichBuilder.totalCost,
                category: 'custom',
                image: 'ü•™',
                description: customSandwichBuilder.selectedIngredients.map(i => i.name).join(', '),
                isCustom: true,
                ingredients: customSandwichBuilder.selectedIngredients,
                quantity: 1
            };

            // Check if same custom sandwich already exists in cart
            const existingIndex = AppState.cart.findIndex(item =>
                item.isCustom &&
                JSON.stringify(item.ingredients) === JSON.stringify(customSandwich.ingredients)
            );

            if (existingIndex > -1) {
                AppState.cart[existingIndex].quantity += 1;
            } else {
                AppState.cart.push(customSandwich);
            }

            updateCart();
            closeCustomSandwichBuilder();
            Toast.show('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        // Dashboard Functions
        function updateDashboard() {
            // Calculate today's sales
            const today = new Date().toDateString();
            const todaySales = AppState.sales.filter(sale =>
                new Date(sale.date).toDateString() === today
            );

            const todayRevenue = todaySales.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            const todayTransactions = todaySales.length;
            const todayProfit = todaySales.reduce((sum, sale) => {
                const saleProfit = (sale.items || []).reduce((itemSum, item) => {
                    const menuItem = AppState.menuItems.find(mi => mi.id === item.id);
                    const profit = menuItem ? (menuItem.price - (menuItem.cost || 0)) * item.quantity : 0;
                    return itemSum + profit;
                }, 0);
                return sum + saleProfit;
            }, 0);

            // Update dashboard cards
            const revenueElement = document.getElementById('today-revenue');
            const transactionsElement = document.getElementById('today-transactions');
            const profitElement = document.getElementById('today-profit');
            const avgSaleElement = document.getElementById('avg-sale');

            if (revenueElement) revenueElement.textContent = Utils.formatCurrency(todayRevenue);
            if (transactionsElement) transactionsElement.textContent = todayTransactions;
            if (profitElement) profitElement.textContent = Utils.formatCurrency(todayProfit);
            if (avgSaleElement) {
                const avgSale = todayTransactions > 0 ? todayRevenue / todayTransactions : 0;
                avgSaleElement.textContent = Utils.formatCurrency(avgSale);
            }

            // Check for low stock alerts
            const lowStockItems = AppState.inventory.filter(item => getStockLevel(item) === 'low');
            const alertContainer = document.getElementById('dashboard-alerts');
            if (alertContainer) {
                if (lowStockItems.length > 0) {
                    alertContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ${lowStockItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</strong>
                            ${lowStockItems.slice(0, 3).map(item => item.name).join(', ')}
                            ${lowStockItems.length > 3 ? ` ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${lowStockItems.length - 3} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : ''}
                        </div>
                    `;
                } else {
                    alertContainer.innerHTML = '';
                }
            }

            // Load recent sales
            loadRecentSales();
        }

        function loadRecentSales() {
            const recentSales = AppState.sales
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            const container = document.getElementById('recent-sales');
            if (!container) return;

            if (recentSales.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>';
                return;
            }

            container.innerHTML = recentSales.map(sale => {
                const itemCount = (sale.items || []).reduce((sum, item) => sum + item.quantity, 0);
                const total = sale.total || sale.amount || 0;

                return `
                    <div class="sale-item">
                        <div class="sale-info">
                            <div class="sale-id">#${sale.id.substr(-6)}</div>
                            <div class="sale-details">
                                ${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${getPaymentMethodLabel(sale.paymentMethod || 'cash')}
                            </div>
                            <div class="sale-time">${Utils.formatTime(new Date(sale.date))}</div>
                        </div>
                        <div class="sale-amount">${Utils.formatCurrency(total)}</div>
                    </div>
                `;
            }).join('');
        }

        // Reports Functions
        function updateReports() {
            updateSalesChart();
            updateTopProductsChart();
            updateProfitAnalysis();
            updateCustomerAnalytics();
        }

        function updateSalesChart() {
            const canvas = document.getElementById('sales-chart');
            if (!canvas) return;

            // Get last 7 days data
            const last7Days = [];
            const salesData = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toDateString();

                const daysSales = AppState.sales
                    .filter(sale => new Date(sale.date).toDateString() === dateString)
                    .reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);

                last7Days.push(date.toLocaleDateString('th-TH', { weekday: 'short' }));
                salesData.push(daysSales);
            }

            if (AppState.salesChart) {
                AppState.salesChart.destroy();
            }

            const ctx = canvas.getContext('2d');
            AppState.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: salesData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utils.formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTopProductsChart() {
            const canvas = document.getElementById('products-chart');
            if (!canvas) return;

            // Calculate product sales
            const productSales = {};
            AppState.sales.forEach(sale => {
                (sale.items || []).forEach(item => {
                    if (productSales[item.name]) {
                        productSales[item.name] += item.quantity;
                    } else {
                        productSales[item.name] = item.quantity;
                    }
                });
            });

            const sortedProducts = Object.entries(productSales)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            if (sortedProducts.length === 0) return;

            if (AppState.productsChart) {
                AppState.productsChart.destroy();
            }

            const ctx = canvas.getContext('2d');
            AppState.productsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedProducts.map(([name]) => name),
                    datasets: [{
                        data: sortedProducts.map(([, quantity]) => quantity),
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function updateProfitAnalysis() {
            const container = document.getElementById('profit-analysis');
            if (!container) return;

            // Calculate profit for last 30 days
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const recentSales = AppState.sales.filter(sale => new Date(sale.date) >= thirtyDaysAgo);

            let totalRevenue = 0;
            let totalCost = 0;
            let totalProfit = 0;

            recentSales.forEach(sale => {
                const saleRevenue = sale.total || sale.amount || 0;
                totalRevenue += saleRevenue;

                const saleCost = (sale.items || []).reduce((sum, item) => {
                    const menuItem = AppState.menuItems.find(mi => mi.id === item.id);
                    const itemCost = menuItem ? (menuItem.cost || 0) * item.quantity : 0;
                    return sum + itemCost;
                }, 0);
                totalCost += saleCost;
            });

            totalProfit = totalRevenue - totalCost;
            const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;

            container.innerHTML = `
                <div class="profit-stats">
                    <div class="profit-card">
                        <div class="profit-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (30 ‡∏ß‡∏±‡∏ô)</div>
                        <div class="profit-value positive">${Utils.formatCurrency(totalRevenue)}</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div>
                        <div class="profit-value negative">${Utils.formatCurrency(totalCost)}</div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                        <div class="profit-value ${totalProfit >= 0 ? 'positive' : 'negative'}">
                            ${Utils.formatCurrency(totalProfit)}
                        </div>
                    </div>
                    <div class="profit-card">
                        <div class="profit-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</div>
                        <div class="profit-value ${profitMargin >= 0 ? 'positive' : 'negative'}">
                            ${profitMargin.toFixed(1)}%
                        </div>
                    </div>
                </div>
            `;
        }

        function updateCustomerAnalytics() {
            const container = document.getElementById('customer-analytics');
            if (!container) return;

            const totalCustomers = AppState.customers.length;
            const activeCustomers = AppState.customers.filter(c =>
                new Date(c.lastVisit || 0) >= new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
            ).length;

            const avgSpending = totalCustomers > 0 ?
                AppState.customers.reduce((sum, c) => sum + (c.totalSpent || 0), 0) / totalCustomers : 0;

            const totalLoyaltyPoints = AppState.customers.reduce((sum, c) => sum + (c.points || 0), 0);

            // Top customers by spending
            const topCustomers = AppState.customers
                .sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0))
                .slice(0, 5);

            container.innerHTML = `
                <div class="customer-stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalCustomers}</div>
                        <div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${activeCustomers}</div>
                        <div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (30 ‡∏ß‡∏±‡∏ô)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Utils.formatCurrency(avgSpending)}</div>
                        <div class="stat-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalLoyaltyPoints}</div>
                        <div class="stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°</div>
                    </div>
                </div>

                <div class="top-customers">
                    <h4 class="mb-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≥</h4>
                    ${topCustomers.map((customer, index) => `
                        <div class="top-customer-item">
                            <div class="customer-rank">${index + 1}</div>
                            <div class="customer-info">
                                <div class="customer-name">${customer.name}</div>
                                <div class="customer-stats">
                                    ${Utils.formatCurrency(customer.totalSpent || 0)} ‚Ä¢ ${customer.visits || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                                </div>
                            </div>
                            <div class="customer-points">${customer.points || 0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Inventory Functions
        function loadInventory() {
            if (AppState.inventory.length === 0) {
                // Initialize with sample inventory
                AppState.inventory = [
                    { id: '1', name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', stock: 50, unit: '‡πÅ‡∏ú‡πà‡∏ô', price: 2 },
                    { id: '2', name: '‡∏´‡∏°‡∏π‡∏´‡∏±‡πà‡∏ô', stock: 20, unit: '‡∏Å‡∏Å.', price: 180 },
                    { id: '3', name: '‡πÑ‡∏Å‡πà‡∏´‡∏±‡πà‡∏ô', stock: 15, unit: '‡∏Å‡∏Å.', price: 120 },
                    { id: '4', name: '‡πÑ‡∏Ç‡πà', stock: 30, unit: '‡∏ü‡∏≠‡∏á', price: 4 },
                    { id: '5', name: '‡∏ó‡∏π‡∏ô‡πà‡∏≤', stock: 10, unit: '‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á', price: 25 }
                ];
            }

            renderInventory();
        }

        function renderInventory(searchTerm = '') {
            const container = document.getElementById('inventory-container');
            const filteredItems = AppState.inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            container.innerHTML = filteredItems.map(item => `
                <div class="card">
                    <div class="card-body">
                        <h4 class="font-semibold mb-2">${item.name}</h4>
                        <div class="text-sm text-gray-500 mb-2">
                            <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.stock} ${item.unit}</div>
                            <div>‡∏£‡∏≤‡∏Ñ‡∏≤: ${Utils.formatCurrency(item.price)}/${item.unit}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-secondary flex-1" onclick="adjustStock('${item.id}', -1)">
                                ‡∏•‡∏î
                            </button>
                            <button class="btn btn-sm btn-primary flex-1" onclick="adjustStock('${item.id}', 1)">
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function adjustStock(itemId, change) {
            const item = AppState.inventory.find(item => item.id === itemId);
            if (item) {
                item.stock = Math.max(0, item.stock + change);
                renderInventory();
                Toast.show(`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ï‡πá‡∏≠‡∏Ñ ${item.name} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            }
        }

        // Stock Alerts Functions
        async function refreshStockAlerts() {
            try {
                const ingredients = await window.db.getAll('ingredients');
                const outOfStock = ingredients.filter(item => item.quantity === 0);
                const lowStock = ingredients.filter(item => item.quantity > 0 && item.quantity <= item.minimum_stock);
                const normalStock = ingredients.filter(item => item.quantity > item.minimum_stock);

                const container = document.getElementById('stock-alerts-container');
                if (!container) return;

                let alertsHTML = '';

                if (outOfStock.length > 0) {
                    alertsHTML += `
                        <div class="alert alert-error mb-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <strong>üö® ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Ñ (${outOfStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</strong>
                                    <div class="text-sm mt-1">
                                        ${outOfStock.map(item => item.name).join(', ')}
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="showBulkRestockModal(${JSON.stringify(outOfStock.map(i => i.id))})">
                                    ‚ö° ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                                </button>
                            </div>
                        </div>
                    `;
                }

                if (lowStock.length > 0) {
                    alertsHTML += `
                        <div class="alert alert-warning mb-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <strong>‚ö†Ô∏è ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏ï‡πà‡∏≥ (${lowStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</strong>
                                    <div class="text-sm mt-1">
                                        ${lowStock.map(item => `${item.name} (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.quantity} ${item.unit})`).join(', ')}
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-warning" onclick="showBulkRestockModal(${JSON.stringify(lowStock.map(i => i.id))})">
                                    üì¶ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                                </button>
                            </div>
                        </div>
                    `;
                }

                if (outOfStock.length === 0 && lowStock.length === 0) {
                    alertsHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong>
                            <div class="text-sm mt-1">
                                ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${normalStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = alertsHTML;

                // Update analytics
                updateInventoryAnalytics(ingredients, outOfStock, lowStock, normalStock);

                // Update page title with alerts count
                const totalAlerts = outOfStock.length + lowStock.length;
                if (totalAlerts > 0) {
                    document.title = `(${totalAlerts}) Sandwich POS - ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ`;
                } else {
                    document.title = 'Sandwich POS - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä';
                }

            } catch (error) {
                console.error('‚ùå Error refreshing stock alerts:', error);
                document.getElementById('stock-alerts-container').innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡πÑ‡∏î‡πâ</strong>
                        <div class="text-sm mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                    </div>
                `;
            }
        }

        function updateInventoryAnalytics(allIngredients, outOfStock, lowStock, normalStock) {
            try {
                // Total ingredients count
                document.getElementById('total-ingredients-count').textContent = allIngredients.length;

                // Low stock + out of stock count
                const alertsCount = outOfStock.length + lowStock.length;
                document.getElementById('low-stock-count').textContent = alertsCount;

                // Calculate inventory value (quantity √ó cost per unit)
                const totalValue = allIngredients.reduce((sum, ingredient) => {
                    return sum + (ingredient.quantity * ingredient.cost_per_unit);
                }, 0);
                document.getElementById('inventory-value').textContent = Utils.formatCurrency(totalValue);

            } catch (error) {
                console.error('‚ùå Error updating inventory analytics:', error);
            }
        }

        async function showBulkRestockModal(ingredientIds) {
            try {
                const ingredients = await Promise.all(
                    ingredientIds.map(id => window.db.findById('ingredients', id))
                );

                const modalHTML = `
                    <div id="bulk-restock-modal" class="modal active">
                        <div class="modal-backdrop" onclick="closeBulkRestockModal()"></div>
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">üì¶ ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
                                <button class="modal-close" onclick="closeBulkRestockModal()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <form id="bulk-restock-form">
                                    ${ingredients.map(ingredient => `
                                        <div class="form-group">
                                            <label class="form-label">
                                                ${ingredient.name} (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${ingredient.quantity} ${ingredient.unit})
                                            </label>
                                            <div class="flex gap-2">
                                                <input type="number"
                                                       class="form-input flex-1"
                                                       id="restock-${ingredient.id}"
                                                       placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°"
                                                       min="1"
                                                       value="${Math.max(1, ingredient.minimum_stock * 2)}">
                                                <span class="btn btn-secondary btn-sm" style="min-width: 80px;">
                                                    ${ingredient.unit}
                                                </span>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: ${ingredient.minimum_stock} ${ingredient.unit}
                                            </div>
                                        </div>
                                    `).join('')}
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeBulkRestockModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button type="button" class="btn btn-primary" onclick="processBulkRestock(${JSON.stringify(ingredientIds)})">
                                    ‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                console.error('‚ùå Error showing bulk restock modal:', error);
                Toast.show('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function closeBulkRestockModal() {
            const modal = document.getElementById('bulk-restock-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function processBulkRestock(ingredientIds) {
            try {
                let successCount = 0;
                let errorCount = 0;

                for (const ingredientId of ingredientIds) {
                    const addQuantity = parseInt(document.getElementById(`restock-${ingredientId}`).value) || 0;

                    if (addQuantity > 0) {
                        const ingredient = await window.db.findById('ingredients', ingredientId);
                        if (ingredient) {
                            const newQuantity = ingredient.quantity + addQuantity;
                            await window.db.update('ingredients', ingredientId, {
                                quantity: newQuantity
                            });

                            // Log the restock
                            await logIngredientUsage(ingredientId, addQuantity, 'restock');
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    }
                }

                closeBulkRestockModal();

                if (successCount > 0) {
                    Toast.show(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                }
                if (errorCount > 0) {
                    Toast.show(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
                }

                // Refresh displays
                await refreshStockAlerts();
                await loadIngredients();

            } catch (error) {
                console.error('‚ùå Error processing bulk restock:', error);
                Toast.show('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Ingredients Management Functions
        async function loadIngredients() {
            try {
                if (!window.db || !window.db.isReady) {
                    console.log('‚è≥ Database not ready for ingredients, retrying...');
                    setTimeout(loadIngredients, 1000);
                    return;
                }

                const ingredients = await window.db.getInventoryItems();
                const container = document.getElementById('ingredients-container');

                if (!container) return;

                container.innerHTML = ingredients.map(ingredient => `
                    <div class="card" data-ingredient-id="${ingredient.id}">
                        <div class="card-body">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-lg font-semibold">${ingredient.name}</h4>
                                    <p class="text-sm text-gray-500 mb-2">${ingredient.supplier || ''}</p>
                                    <div class="flex gap-4 text-sm mb-2">
                                        <span class="text-blue-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${ingredient.quantity} ${ingredient.unit}</span>
                                        <span class="text-green-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${Utils.formatCurrency(ingredient.cost_per_unit)}/${ingredient.unit}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        ${ingredient.quantity <= ingredient.minimum_stock ? '<span class="badge badge-error">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏ï‡πà‡∏≥</span>' : ''}
                                        ${ingredient.quantity === 0 ? '<span class="badge badge-error">‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</span>' : ''}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-secondary" onclick="editIngredient('${ingredient.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button class="btn btn-sm btn-primary" onclick="restockIngredient('${ingredient.id}')">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Error loading ingredients:', error);
            }
        }

        async function showAddIngredientModal() {
            // Similar to menu item modal but for ingredients
            const modalHTML = `
                <div id="add-ingredient-modal" class="modal active">
                    <div class="modal-backdrop" onclick="closeAddIngredientModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
                            <button class="modal-close" onclick="closeAddIngredientModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <form id="add-ingredient-form">
                                <div class="form-group">
                                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                                    <input type="text" class="form-input" id="ingredient-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏Ç‡∏≤‡∏ß" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                                    <input type="text" class="form-input" id="ingredient-unit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ú‡πà‡∏ô, ‡∏Å‡∏£‡∏±‡∏°" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" class="form-input" id="ingredient-cost" placeholder="2.00" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                    <input type="number" class="form-input" id="ingredient-quantity" placeholder="100" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
                                    <input type="number" class="form-input" id="ingredient-min-stock" placeholder="10" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                                    <input type="text" class="form-input" id="ingredient-supplier" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddIngredientModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="button" class="btn btn-primary" onclick="saveIngredient()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeAddIngredientModal() {
            const modal = document.getElementById('add-ingredient-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveIngredient() {
            try {
                const ingredient = {
                    name: document.getElementById('ingredient-name').value,
                    unit: document.getElementById('ingredient-unit').value,
                    cost_per_unit: parseFloat(document.getElementById('ingredient-cost').value),
                    quantity: parseInt(document.getElementById('ingredient-quantity').value),
                    minimum_stock: parseInt(document.getElementById('ingredient-min-stock').value),
                    supplier: document.getElementById('ingredient-supplier').value,
                    category: 'general'
                };

                await window.db.create('ingredients', ingredient);
                showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeAddIngredientModal();
                await loadIngredients();

            } catch (error) {
                console.error('‚ùå Error saving ingredient:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function filterIngredients() {
            const searchTerm = document.getElementById('ingredient-search').value.toLowerCase();
            const statusFilter = document.getElementById('ingredient-status-filter').value;
            const ingredientCards = document.querySelectorAll('#ingredients-container .card');

            ingredientCards.forEach(card => {
                const ingredientName = card.querySelector('h4').textContent.toLowerCase();
                const hasLowStockBadge = card.querySelector('.badge-error');

                const matchesSearch = ingredientName.includes(searchTerm);
                let matchesStatus = true;

                if (statusFilter === 'low_stock') {
                    matchesStatus = hasLowStockBadge !== null;
                } else if (statusFilter === 'out_of_stock') {
                    matchesStatus = hasLowStockBadge && hasLowStockBadge.textContent.includes('‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Ñ');
                } else if (statusFilter === 'in_stock') {
                    matchesStatus = hasLowStockBadge === null;
                }

                card.style.display = matchesSearch && matchesStatus ? 'block' : 'none';
            });
        }

        // Reports Functions
        function loadReports() {
            loadSalesReport();
            loadTopProducts();
        }

        function loadSalesReport() {
            const ctx = document.getElementById('salesReportChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (AppState.salesReportChart) {
                AppState.salesReportChart.destroy();
            }

            // Sample monthly data
            const monthlyData = [
                { month: '‡∏°.‡∏Ñ.', sales: 45000 },
                { month: '‡∏Å.‡∏û.', sales: 52000 },
                { month: '‡∏°‡∏µ.‡∏Ñ.', sales: 48000 },
                { month: '‡πÄ‡∏°.‡∏¢.', sales: 61000 },
                { month: '‡∏û.‡∏Ñ.', sales: 58000 },
                { month: '‡∏°‡∏¥.‡∏¢.', sales: 67000 }
            ];

            AppState.salesReportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(d => d.month),
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: monthlyData.map(d => d.sales),
                        backgroundColor: '#0c8ce9',
                        borderColor: '#0159a2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utils.formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadTopProducts() {
            const container = document.getElementById('top-products-list');
            const topProducts = [
                { name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏´‡∏°‡∏π', sales: 156, revenue: 5460 },
                { name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà', sales: 134, revenue: 5360 },
                { name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤', sales: 89, revenue: 4005 },
                { name: '‡∏Å‡∏≤‡πÅ‡∏ü', sales: 203, revenue: 4060 },
                { name: '‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô', sales: 167, revenue: 3006 }
            ];

            container.innerHTML = topProducts.map((product, index) => `
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-semibold">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium">${product.name}</div>
                            <div class="text-sm text-gray-500">${product.sales} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-success">${Utils.formatCurrency(product.revenue)}</div>
                    </div>
                </div>
            `).join('');
        }

        function showManageCategoriesModal() {
            // Create and show a modal for managing menu categories
            const modalHTML = `
                <div id="manage-categories-modal" class="modal active">
                    <div class="modal-backdrop" onclick="closeManageCategoriesModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π</h3>
                            <button class="modal-close" onclick="closeManageCategoriesModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</label>
                                <div class="flex gap-2">
                                    <input type="text" class="form-input" id="new-category-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">
                                    <button class="btn btn-primary" onclick="addCategory()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</label>
                                <div id="categories-list" class="space-y-2">
                                    <div class="p-2 border rounded flex justify-between items-center">
                                        <span>‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä</span>
                                        <button class="btn btn-sm btn-error" onclick="removeCategory('‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä')">‡∏•‡∏ö</button>
                                    </div>
                                    <div class="p-2 border rounded flex justify-between items-center">
                                        <span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</span>
                                        <button class="btn btn-sm btn-error" onclick="removeCategory('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°')">‡∏•‡∏ö</button>
                                    </div>
                                    <div class="p-2 border rounded flex justify-between items-center">
                                        <span>‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</span>
                                        <button class="btn btn-sm btn-error" onclick="removeCategory('‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô')">‡∏•‡∏ö</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeManageCategoriesModal()">‡∏õ‡∏¥‡∏î</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeManageCategoriesModal() {
            const modal = document.getElementById('manage-categories-modal');
            if (modal) {
                modal.remove();
            }
        }

        function addCategory() {
            const categoryName = document.getElementById('new-category-name').value.trim();
            if (!categoryName) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
                return;
            }

            // Add to categories list (this is a simple implementation)
            const categoriesList = document.getElementById('categories-list');
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'p-2 border rounded flex justify-between items-center';
            categoryDiv.innerHTML = `
                <span>${categoryName}</span>
                <button class="btn btn-sm btn-error" onclick="removeCategory('${categoryName}')">‡∏•‡∏ö</button>
            `;
            categoriesList.appendChild(categoryDiv);

            document.getElementById('new-category-name').value = '';
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ${categoryName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        }

        function removeCategory(categoryName) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${categoryName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                // Find and remove the category element
                const categoriesList = document.getElementById('categories-list');
                const categoryElements = categoriesList.children;

                for (let i = 0; i < categoryElements.length; i++) {
                    const span = categoryElements[i].querySelector('span');
                    if (span && span.textContent === categoryName) {
                        categoryElements[i].remove();
                        break;
                    }
                }

                showToast(`‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ${categoryName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
            }
        }

        // Modal Functions
        function showExpenseModal() {
            document.getElementById('expense-modal').classList.add('active');
        }

        function closeExpenseModal() {
            document.getElementById('expense-modal').classList.remove('active');
            document.getElementById('expense-form').reset();
        }

        function showSettings() {
            document.getElementById('settings-modal').classList.add('active');

            // Load current settings
            document.getElementById('shop-name').value = AppState.settings.shopName;
            document.getElementById('shop-phone').value = AppState.settings.shopPhone;
            document.getElementById('shop-address').value = AppState.settings.shopAddress;
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            AppState.settings.shopName = document.getElementById('shop-name').value;
            AppState.settings.shopPhone = document.getElementById('shop-phone').value;
            AppState.settings.shopAddress = document.getElementById('shop-address').value;

            closeSettings();
            Toast.show('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function updateLoyaltySettings() {
            try {
                const loyaltyEnabled = document.getElementById('loyalty-enabled')?.checked || false;
                const loyaltyRate = parseFloat(document.getElementById('loyalty-rate')?.value) || 0.01;

                AppState.settings.loyaltyPoints.enabled = loyaltyEnabled;
                AppState.settings.loyaltyPoints.rate = loyaltyRate / 100; // Convert percentage to decimal

                Toast.show('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error('Error updating loyalty settings:', error);
                Toast.show('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function updateSalesReport() {
            try {
                const period = document.getElementById('sales-period')?.value || 'monthly';
                console.log('Updating sales report for period:', period);

                // Refresh the sales report chart with new period
                loadSalesReport();

                Toast.show('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'info');
            } catch (error) {
                console.error('Error updating sales report:', error);
                Toast.show('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Cost Analysis Functions
        async function loadCostAnalysis() {
            try {
                console.log('üîÑ Loading mobile-optimized cost analysis...');

                await updateTodaysSummary();
                await loadMenuAnalysis();
                await generateBusinessInsights();
                await loadTodaysExpenses();

                console.log('‚úÖ Cost analysis loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading cost analysis:', error);
                Toast.show('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function updateTodaysSummary() {
            try {
                const today = new Date().toDateString();
                const sales = await window.db.getAll('sales');
                const todaysSales = sales.filter(sale => new Date(sale.date).toDateString() === today);

                // Calculate today's metrics
                const todayRevenue = todaysSales.reduce((sum, sale) => sum + sale.total, 0);
                const todayCosts = await calculateTodaysCosts(todaysSales);
                const todayProfit = todayRevenue - todayCosts;
                const profitMargin = todayRevenue > 0 ? (todayProfit / todayRevenue) * 100 : 0;

                // Update UI
                document.getElementById('today-revenue').textContent = Utils.formatCurrency(todayRevenue);
                document.getElementById('today-costs').textContent = Utils.formatCurrency(todayCosts);
                document.getElementById('today-profit').textContent = Utils.formatCurrency(todayProfit);
                document.getElementById('profit-margin-today').textContent = `${profitMargin.toFixed(1)}%`;

            } catch (error) {
                console.error('‚ùå Error updating today\'s summary:', error);
            }
        }

        async function calculateTodaysCosts(todaysSales) {
            try {
                let totalCosts = 0;

                for (const sale of todaysSales) {
                    for (const item of sale.items) {
                        if (item.isCustom) {
                            // Custom sandwich - sum ingredient costs
                            totalCosts += item.ingredients.reduce((sum, ing) => sum + ing.cost, 0) * item.quantity;
                        } else {
                            // Regular menu item - use stored cost
                            totalCosts += item.cost * item.quantity;
                        }
                    }
                }

                return totalCosts;
            } catch (error) {
                console.error('‚ùå Error calculating costs:', error);
                return 0;
            }
        }

        async function loadMenuAnalysis() {
            try {
                const sales = await window.db.getAll('sales');
                const menuItems = await window.db.getAll('menu_items');

                // Analyze each menu item
                const menuAnalysis = await Promise.all(menuItems.map(async item => {
                    const itemSales = sales.flatMap(sale =>
                        sale.items.filter(saleItem => saleItem.id === item.id)
                    );

                    const totalSold = itemSales.reduce((sum, sale) => sum + sale.quantity, 0);
                    const revenue = itemSales.reduce((sum, sale) => sum + (sale.price * sale.quantity), 0);
                    const cost = totalSold * item.cost;
                    const profit = revenue - cost;
                    const profitMargin = revenue > 0 ? (profit / revenue) * 100 : 0;

                    return {
                        ...item,
                        totalSold,
                        revenue,
                        totalCost: cost,
                        profit,
                        profitMargin
                    };
                }));

                // Sort by profit descending
                menuAnalysis.sort((a, b) => b.profit - a.profit);

                // Display analysis
                const container = document.getElementById('menu-analysis-container');
                container.innerHTML = menuAnalysis.map(item => `
                    <div class="card ${item.profit < 0 ? 'border-error' : item.profitMargin > 50 ? 'border-success' : ''}">
                        <div class="card-body">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-semibold">${item.name}</h4>
                                    <div class="text-sm text-gray-600">‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ ${item.totalSold} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold ${item.profit >= 0 ? 'text-success' : 'text-error'}">
                                        ${Utils.formatCurrency(item.profit)}
                                    </div>
                                    <div class="text-sm text-gray-600">${item.profitMargin.toFixed(1)}% ‡∏Å‡∏≥‡πÑ‡∏£</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div class="text-center">
                                    <div class="font-medium text-primary">${Utils.formatCurrency(item.revenue)}</div>
                                    <div class="text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-medium text-error">${Utils.formatCurrency(item.totalCost)}</div>
                                    <div class="text-gray-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-medium ${item.profit >= 0 ? 'text-success' : 'text-error'}">
                                        ${Utils.formatCurrency(item.profit)}
                                    </div>
                                    <div class="text-gray-600">‡∏Å‡∏≥‡πÑ‡∏£</div>
                                </div>
                            </div>
                            ${item.profit < 0 ? '<div class="mt-2 text-sm text-error">‚ö†Ô∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</div>' : ''}
                            ${item.profitMargin > 70 ? '<div class="mt-2 text-sm text-success">üèÜ ‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏≥‡πÑ‡∏£‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</div>' : ''}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Error loading menu analysis:', error);
            }
        }

        async function generateBusinessInsights() {
            try {
                const insights = [];
                const sales = await window.db.getAll('sales');
                const ingredients = await window.db.getAll('ingredients');

                // Low stock alert
                const lowStockItems = ingredients.filter(item => item.quantity <= item.minimum_stock);
                if (lowStockItems.length > 0) {
                    insights.push({
                        type: 'warning',
                        icon: '‚ö†Ô∏è',
                        title: '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î',
                        message: `‡∏°‡∏µ ${lowStockItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ: ${lowStockItems.slice(0,3).map(i => i.name).join(', ')}`,
                        action: 'stockCheck()'
                    });
                }

                // Sales trend
                if (sales.length > 7) {
                    const recentSales = sales.slice(-7);
                    const olderSales = sales.slice(-14, -7);
                    const recentAvg = recentSales.reduce((sum, s) => sum + s.total, 0) / recentSales.length;
                    const olderAvg = olderSales.length > 0 ? olderSales.reduce((sum, s) => sum + s.total, 0) / olderSales.length : 0;

                    if (recentAvg > olderAvg * 1.1) {
                        insights.push({
                            type: 'success',
                            icon: 'üìà',
                            title: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô',
                            message: `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ${((recentAvg/olderAvg - 1) * 100).toFixed(1)}%`,
                            action: null
                        });
                    } else if (recentAvg < olderAvg * 0.9) {
                        insights.push({
                            type: 'error',
                            icon: 'üìâ',
                            title: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏•‡∏î‡∏•‡∏á',
                            message: `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏•‡∏î‡∏•‡∏á ${((1 - recentAvg/olderAvg) * 100).toFixed(1)}% ‡∏Ñ‡∏ß‡∏£‡∏´‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢`,
                            action: null
                        });
                    }
                }

                // Display insights
                const container = document.getElementById('business-insights');
                if (insights.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥‡∏î‡∏µ</strong>
                            <div class="text-sm mt-1">‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏î‡∏µ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = insights.map(insight => `
                        <div class="alert alert-${insight.type}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <strong>${insight.icon} ${insight.title}</strong>
                                    <div class="text-sm mt-1">${insight.message}</div>
                                </div>
                                ${insight.action ? `<button class="btn btn-sm btn-primary" onclick="${insight.action}">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>` : ''}
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('‚ùå Error generating insights:', error);
            }
        }

        async function loadTodaysExpenses() {
            try {
                const today = new Date().toDateString();
                const expenses = await window.db.getAll('expenses');
                const todaysExpenses = expenses.filter(exp =>
                    new Date(exp.date).toDateString() === today
                );

                const container = document.getElementById('expenses-today');

                if (todaysExpenses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            <div>üí∞</div>
                            <div class="text-sm">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
                        </div>
                    `;
                } else {
                    const totalExpenses = todaysExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                    container.innerHTML = `
                        <div class="mb-3">
                            <div class="text-lg font-bold text-error">${Utils.formatCurrency(totalExpenses)}</div>
                            <div class="text-sm text-gray-600">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                        </div>
                        ${todaysExpenses.map(expense => `
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <div>
                                    <div class="font-medium">${expense.description}</div>
                                    <div class="text-sm text-gray-500">${expense.category}</div>
                                </div>
                                <div class="text-error font-medium">${Utils.formatCurrency(expense.amount)}</div>
                            </div>
                        `).join('')}
                    `;
                }

            } catch (error) {
                console.error('‚ùå Error loading today\'s expenses:', error);
            }
        }

        // Quick Analysis Functions
        function showDailyAnalysis() {
            showAnalysisModal('daily', 'üìÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
        }

        function showWeeklyAnalysis() {
            showAnalysisModal('weekly', 'üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ', '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î');
        }

        function showBestSellingItems() {
            showTopItemsModal('best-selling', 'üèÜ ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ', '‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î');
        }

        function showProfitableItems() {
            showTopItemsModal('profitable', 'üí∞ ‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏π‡∏á', '‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î');
        }

        // Data Entry Functions
        function quickSaleEntry() {
            showQuickEntryModal('sale');
        }

        function quickExpenseEntry() {
            showQuickEntryModal('expense');
        }

        function stockCheck() {
            // Navigate to inventory screen and highlight low stock
            switchScreen('inventory-screen');
            setTimeout(() => {
                document.getElementById('ingredient-status-filter').value = 'low_stock';
                filterIngredients();
            }, 500);
        }

        function addExpense() {
            showAddExpenseModal();
        }

        function refreshMenuAnalysis() {
            loadMenuAnalysis();
            Toast.show('üîÑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function generateReport() {
            showReportOptionsModal();
        }

        // Modal Functions
        async function showAnalysisModal(period, title, subtitle) {
            // Implementation for detailed analysis modals
            Toast.show(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${title}...`, 'info');
        }

        async function showTopItemsModal(type, title, subtitle) {
            // Implementation for top items analysis
            Toast.show(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå${title}...`, 'info');
        }

        async function showQuickEntryModal(type) {
            // Implementation for quick data entry
            const isExpense = type === 'expense';
            const modalHTML = `
                <div id="quick-entry-modal" class="modal active">
                    <div class="modal-backdrop" onclick="closeQuickEntryModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${isExpense ? 'üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢' : 'üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢'}</h3>
                            <button class="modal-close" onclick="closeQuickEntryModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <form id="quick-entry-form">
                                <div class="form-group">
                                    <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" class="form-input" id="entry-amount" placeholder="0.00" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                    <input type="text" class="form-input" id="entry-description" placeholder="${isExpense ? '‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö, ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô, ‡∏Ø‡∏•‡∏Ø' : '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°, ‡∏Ø‡∏•‡∏Ø'}" required>
                                </div>
                                ${isExpense ? `
                                <div class="form-group">
                                    <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                    <select class="form-select" id="entry-category">
                                        <option value="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</option>
                                        <option value="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</option>
                                        <option value="‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</option>
                                        <option value="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</option>
                                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                    </select>
                                </div>` : ''}
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeQuickEntryModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="button" class="btn btn-primary" onclick="saveQuickEntry('${type}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeQuickEntryModal() {
            const modal = document.getElementById('quick-entry-modal');
            if (modal) modal.remove();
        }

        async function saveQuickEntry(type) {
            try {
                const amount = parseFloat(document.getElementById('entry-amount').value);
                const description = document.getElementById('entry-description').value;

                if (!amount || !description) {
                    Toast.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                    return;
                }

                if (type === 'expense') {
                    const category = document.getElementById('entry-category').value;
                    await window.db.create('expenses', {
                        amount,
                        description,
                        category,
                        date: new Date().toISOString(),
                        type: 'manual'
                    });
                    Toast.show('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } else {
                    // For sales, you might want to create a simplified sale record
                    Toast.show('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }

                closeQuickEntryModal();
                await updateTodaysSummary();
                await loadTodaysExpenses();

            } catch (error) {
                console.error('‚ùå Error saving quick entry:', error);
                Toast.show('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function showAddExpenseModal() {
            showQuickEntryModal('expense');
        }

        function showReportOptionsModal() {
            const modalHTML = `
                <div id="report-options-modal" class="modal active">
                    <div class="modal-backdrop" onclick="closeReportOptionsModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                            <button class="modal-close" onclick="closeReportOptionsModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="space-y-4">
                                <button class="btn btn-primary btn-lg w-full" onclick="generateDailyReport()">
                                    üìÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
                                </button>
                                <button class="btn btn-secondary btn-lg w-full" onclick="generateWeeklyReport()">
                                    üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                                </button>
                                <button class="btn btn-warning btn-lg w-full" onclick="generateMonthlyReport()">
                                    üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                                </button>
                                <button class="btn btn-success btn-lg w-full" onclick="generateProfitReport()">
                                    üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeReportOptionsModal() {
            const modal = document.getElementById('report-options-modal');
            if (modal) modal.remove();
        }

        // Report Generation Functions
        async function generateDailyReport() {
            closeReportOptionsModal();
            Toast.show('üìÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô...', 'info');
            // Implementation for daily report
        }

        async function generateWeeklyReport() {
            closeReportOptionsModal();
            Toast.show('üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå...', 'info');
            // Implementation for weekly report
        }

        async function generateMonthlyReport() {
            closeReportOptionsModal();
            Toast.show('üìà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...', 'info');
            // Implementation for monthly report
        }

        async function generateProfitReport() {
            closeReportOptionsModal();
            Toast.show('üí∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô...', 'info');
            // Implementation for profit/loss report
        }

        // ====================================
        // COMPREHENSIVE SALES TRACKING SYSTEM
        // ====================================

        // Sales State Management
        const SalesState = {
            currentOrder: {
                items: [],
                customer: null,
                paymentMethod: 'cash',
                discount: 0,
                notes: '',
                subtotal: 0,
                total: 0
            },
            selectedCustomer: null,
            salesHistory: [],
            currentFilter: {
                dateRange: 'today',
                customer: '',
                paymentMethod: ''
            }
        };

        // Sales Modal Functions
        function showSalesModal() {
            resetCurrentOrder();
            loadQuickMenuSelection();
            loadMenuOptions();
            document.getElementById('sales-modal').classList.add('active');
        }

        function closeSalesModal() {
            document.getElementById('sales-modal').classList.remove('active');
            resetCurrentOrder();
        }

        function resetCurrentOrder() {
            SalesState.currentOrder = {
                items: [],
                customer: null,
                paymentMethod: 'cash',
                discount: 0,
                notes: '',
                subtotal: 0,
                total: 0
            };
            SalesState.selectedCustomer = null;

            // Reset UI
            document.getElementById('selected-customer-display').value = '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
            document.getElementById('order-items').innerHTML = '';
            document.getElementById('discount-amount').value = '';
            document.getElementById('sale-notes').value = '';
            updateOrderTotal();
            selectPaymentMethod('cash');
        }

        async function loadQuickMenuSelection() {
            try {
                const menu = await window.db.getAll('menu');
                const popularItems = menu.slice(0, 6); // Show top 6 popular items

                const container = document.getElementById('quick-menu-selection');
                container.innerHTML = popularItems.map(item => `
                    <button type="button" class="btn btn-outline btn-sm" onclick="quickAddMenuItem('${item.id}')">
                        ${item.name}
                        <span class="text-xs block">${Utils.formatCurrency(item.price)}</span>
                    </button>
                `).join('');
            } catch (error) {
                console.error('‚ùå Error loading quick menu:', error);
            }
        }

        async function loadMenuOptions() {
            try {
                const menu = await window.db.getAll('menu');
                const menuSelect = document.getElementById('menu-select');

                menuSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π...</option>' +
                    menu.map(item => `
                        <option value="${item.id}">${item.name} - ${Utils.formatCurrency(item.price)}</option>
                    `).join('');
            } catch (error) {
                console.error('‚ùå Error loading menu options:', error);
            }
        }

        function quickAddMenuItem(menuId) {
            const menuSelect = document.getElementById('menu-select');
            menuSelect.value = menuId;
            addOrderItem();
        }

        async function addOrderItem() {
            const menuSelect = document.getElementById('menu-select');
            const selectedMenuId = menuSelect.value;

            if (!selectedMenuId) {
                Toast.show('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π', 'error');
                return;
            }

            try {
                const menu = await window.db.get('menu', selectedMenuId);
                if (!menu) {
                    Toast.show('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'error');
                    return;
                }

                // Check if item already exists in order
                const existingIndex = SalesState.currentOrder.items.findIndex(item => item.menuId === selectedMenuId);

                if (existingIndex >= 0) {
                    // Increase quantity
                    SalesState.currentOrder.items[existingIndex].quantity++;
                } else {
                    // Add new item
                    SalesState.currentOrder.items.push({
                        menuId: selectedMenuId,
                        name: menu.name,
                        price: menu.price,
                        quantity: 1,
                        subtotal: menu.price
                    });
                }

                updateOrderDisplay();
                updateOrderTotal();
                menuSelect.value = '';

            } catch (error) {
                console.error('‚ùå Error adding order item:', error);
                Toast.show('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
            }
        }

        function updateOrderDisplay() {
            const container = document.getElementById('order-items');

            if (SalesState.currentOrder.items.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <div>üõí</div>
                        <div class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = SalesState.currentOrder.items.map((item, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <div class="font-medium">${item.name}</div>
                        <div class="text-sm text-gray-500">${Utils.formatCurrency(item.price)} √ó ${item.quantity}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm btn-outline" onclick="changeItemQuantity(${index}, -1)">-</button>
                        <span class="font-medium">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline" onclick="changeItemQuantity(${index}, 1)">+</button>
                        <button class="btn btn-sm btn-error" onclick="removeOrderItem(${index})">üóëÔ∏è</button>
                    </div>
                    <div class="font-bold text-primary ml-4">${Utils.formatCurrency(item.subtotal)}</div>
                </div>
            `).join('');
        }

        function changeItemQuantity(index, delta) {
            const item = SalesState.currentOrder.items[index];
            const newQuantity = item.quantity + delta;

            if (newQuantity <= 0) {
                removeOrderItem(index);
                return;
            }

            item.quantity = newQuantity;
            item.subtotal = item.price * item.quantity;

            updateOrderDisplay();
            updateOrderTotal();
        }

        function removeOrderItem(index) {
            SalesState.currentOrder.items.splice(index, 1);
            updateOrderDisplay();
            updateOrderTotal();
        }

        function updateOrderTotal() {
            const subtotal = SalesState.currentOrder.items.reduce((sum, item) => sum + item.subtotal, 0);
            const discount = parseFloat(document.getElementById('discount-amount').value) || 0;
            const total = Math.max(0, subtotal - discount);

            SalesState.currentOrder.subtotal = subtotal;
            SalesState.currentOrder.discount = discount;
            SalesState.currentOrder.total = total;

            document.getElementById('order-subtotal').textContent = Utils.formatCurrency(subtotal);
            document.getElementById('order-total').textContent = Utils.formatCurrency(total);
        }

        function selectPaymentMethod(method) {
            // Update UI
            document.querySelectorAll('.payment-method').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');

            // Update state
            SalesState.currentOrder.paymentMethod = method;
        }

        // Customer Selection Functions
        function showCustomerSelectModal() {
            loadCustomerSelectList();
            document.getElementById('customer-select-modal').classList.add('active');
        }

        function closeCustomerSelectModal() {
            document.getElementById('customer-select-modal').classList.remove('active');
        }

        async function loadCustomerSelectList() {
            try {
                const customers = await window.db.getAll('customers') || [];
                const container = document.getElementById('customer-select-list');

                if (customers.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            <div>üë§</div>
                            <div class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = customers.map(customer => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100" onclick="selectCustomer('${customer.id}')">
                        <div>
                            <div class="font-medium">${customer.name}</div>
                            <div class="text-sm text-gray-500">${customer.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå'}</div>
                        </div>
                        <button class="btn btn-sm btn-primary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Error loading customer list:', error);
            }
        }

        async function selectCustomer(customerId) {
            try {
                const customer = await window.db.get('customers', customerId);
                if (customer) {
                    SalesState.selectedCustomer = customer;
                    document.getElementById('selected-customer-display').value = customer.name;
                }
                closeCustomerSelectModal();
            } catch (error) {
                console.error('‚ùå Error selecting customer:', error);
            }
        }

        function selectWalkInCustomer() {
            SalesState.selectedCustomer = null;
            document.getElementById('selected-customer-display').value = '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
            closeCustomerSelectModal();
        }

        // Sales Completion Functions
        async function saveDraftSale() {
            if (SalesState.currentOrder.items.length === 0) {
                Toast.show('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
                return;
            }

            try {
                const draftSale = {
                    ...SalesState.currentOrder,
                    status: 'draft',
                    customer: SalesState.selectedCustomer,
                    notes: document.getElementById('sale-notes').value,
                    createdAt: new Date().toISOString(),
                    id: Date.now().toString()
                };

                await window.db.add('sales_drafts', draftSale);
                Toast.show('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeSalesModal();

            } catch (error) {
                console.error('‚ùå Error saving draft sale:', error);
                Toast.show('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
            }
        }

        async function completeSale() {
            if (SalesState.currentOrder.items.length === 0) {
                Toast.show('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
                return;
            }

            try {
                const completedSale = {
                    ...SalesState.currentOrder,
                    status: 'completed',
                    customer: SalesState.selectedCustomer,
                    notes: document.getElementById('sale-notes').value,
                    completedAt: new Date().toISOString(),
                    id: Date.now().toString(),
                    receiptNumber: generateReceiptNumber()
                };

                // Save sale record
                await window.db.add('sales', completedSale);

                // Update inventory
                await updateInventoryFromSale(completedSale.items);

                // Update customer purchase history
                if (SalesState.selectedCustomer) {
                    await updateCustomerHistory(SalesState.selectedCustomer.id, completedSale);
                }

                Toast.show('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                showReceipt(completedSale);
                closeSalesModal();

                // Update dashboard if visible
                if (getCurrentScreen() === 'dashboard-screen') {
                    await loadDashboard();
                }

            } catch (error) {
                console.error('‚ùå Error completing sale:', error);
                Toast.show('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
            }
        }

        function generateReceiptNumber() {
            const now = new Date();
            const date = now.toISOString().slice(0, 10).replace(/-/g, '');
            const time = now.toTimeString().slice(0, 8).replace(/:/g, '');
            return `R${date}${time}`;
        }

        async function updateInventoryFromSale(saleItems) {
            try {
                for (const saleItem of saleItems) {
                    const menu = await window.db.get('menu', saleItem.menuId);
                    if (menu && menu.recipe) {
                        for (const ingredient of menu.recipe) {
                            const currentIngredient = await window.db.get('ingredients', ingredient.id);
                            if (currentIngredient) {
                                const usedQuantity = ingredient.quantity * saleItem.quantity;
                                currentIngredient.currentStock = Math.max(0, currentIngredient.currentStock - usedQuantity);
                                await window.db.update('ingredients', currentIngredient);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Error updating inventory:', error);
            }
        }

        async function updateCustomerHistory(customerId, sale) {
            try {
                const customer = await window.db.get('customers', customerId);
                if (customer) {
                    if (!customer.purchaseHistory) customer.purchaseHistory = [];
                    customer.purchaseHistory.push({
                        saleId: sale.id,
                        date: sale.completedAt,
                        amount: sale.total,
                        items: sale.items.length
                    });
                    customer.lastPurchase = sale.completedAt;
                    customer.totalSpent = (customer.totalSpent || 0) + sale.total;
                    customer.visitCount = (customer.visitCount || 0) + 1;

                    await window.db.update('customers', customer);
                }
            } catch (error) {
                console.error('‚ùå Error updating customer history:', error);
            }
        }

        function showReceipt(sale) {
            // Create and show receipt modal (simplified version)
            const receiptHtml = `
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                    <p class="text-sm text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: ${sale.receiptNumber}</p>
                    <p class="text-sm text-gray-500">${new Date(sale.completedAt).toLocaleString('th-TH')}</p>
                </div>

                <div class="space-y-2 mb-4">
                    ${sale.items.map(item => `
                        <div class="flex justify-between">
                            <span>${item.name} √ó ${item.quantity}</span>
                            <span>${Utils.formatCurrency(item.subtotal)}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="border-t pt-2">
                    <div class="flex justify-between">
                        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                        <span>${Utils.formatCurrency(sale.subtotal)}</span>
                    </div>
                    ${sale.discount > 0 ? `
                        <div class="flex justify-between text-red-600">
                            <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
                            <span>-${Utils.formatCurrency(sale.discount)}</span>
                        </div>
                    ` : ''}
                    <div class="flex justify-between font-bold text-lg border-t pt-2">
                        <span>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span>
                        <span>${Utils.formatCurrency(sale.total)}</span>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <p class="text-sm text-gray-500">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞</p>
                </div>
            `;

            // Show in alert or modal
            Toast.show('üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à<br>' + receiptHtml, 'success', 5000);
        }

        // Sales History Functions
        function showSalesHistoryModal() {
            loadSalesHistory();
            document.getElementById('sales-history-modal').classList.add('active');
        }

        function closeSalesHistoryModal() {
            document.getElementById('sales-history-modal').classList.remove('active');
        }

        async function loadSalesHistory() {
            try {
                const sales = await window.db.getAll('sales') || [];
                const customers = await window.db.getAll('customers') || [];

                // Load customer filter options
                const customerFilter = document.getElementById('history-customer-filter');
                customerFilter.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' +
                    customers.map(customer => `
                        <option value="${customer.id}">${customer.name}</option>
                    `).join('');

                filterSalesHistory();

            } catch (error) {
                console.error('‚ùå Error loading sales history:', error);
            }
        }

        async function filterSalesHistory() {
            try {
                const sales = await window.db.getAll('sales') || [];
                const dateRange = document.getElementById('history-date-range').value;
                const customerFilter = document.getElementById('history-customer-filter').value;
                const paymentFilter = document.getElementById('history-payment-filter').value;

                let filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.completedAt);
                    const today = new Date();

                    // Date filter
                    let dateMatch = true;
                    switch (dateRange) {
                        case 'today':
                            dateMatch = saleDate.toDateString() === today.toDateString();
                            break;
                        case 'yesterday':
                            const yesterday = new Date(today);
                            yesterday.setDate(yesterday.getDate() - 1);
                            dateMatch = saleDate.toDateString() === yesterday.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            dateMatch = saleDate >= weekAgo;
                            break;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            dateMatch = saleDate >= monthAgo;
                            break;
                    }

                    // Customer filter
                    const customerMatch = !customerFilter ||
                        (sale.customer && sale.customer.id === customerFilter);

                    // Payment method filter
                    const paymentMatch = !paymentFilter || sale.paymentMethod === paymentFilter;

                    return dateMatch && customerMatch && paymentMatch;
                });

                // Update summary
                updateSalesHistorySummary(filteredSales);

                // Update list
                displaySalesHistoryList(filteredSales);

            } catch (error) {
                console.error('‚ùå Error filtering sales history:', error);
            }
        }

        function updateSalesHistorySummary(sales) {
            const totalSales = sales.length;
            const totalRevenue = sales.reduce((sum, sale) => sum + sale.total, 0);
            const avgOrder = totalSales > 0 ? totalRevenue / totalSales : 0;
            const uniqueCustomers = new Set(sales.filter(sale => sale.customer).map(sale => sale.customer.id)).size;

            document.getElementById('history-total-sales').textContent = totalSales;
            document.getElementById('history-total-revenue').textContent = Utils.formatCurrency(totalRevenue);
            document.getElementById('history-avg-order').textContent = Utils.formatCurrency(avgOrder);
            document.getElementById('history-unique-customers').textContent = uniqueCustomers;
        }

        function displaySalesHistoryList(sales) {
            const container = document.getElementById('sales-history-list');

            if (sales.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">üìä</div>
                        <div class="text-lg font-medium">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
                        <div class="text-sm">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    </div>
                `;
                return;
            }

            // Sort by date (newest first)
            sales.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));

            container.innerHTML = sales.map(sale => `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-medium">${sale.receiptNumber}</div>
                            <div class="text-sm text-gray-500">
                                ${new Date(sale.completedAt).toLocaleString('th-TH')}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg text-success">${Utils.formatCurrency(sale.total)}</div>
                            <div class="text-sm text-gray-500">${getPaymentMethodText(sale.paymentMethod)}</div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-2">
                        <div class="text-sm">
                            <span class="text-gray-600">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span>
                            <span class="font-medium">${sale.customer ? sale.customer.name : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            ${sale.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </div>
                    </div>

                    <div class="text-xs text-gray-500">
                        ${sale.items.map(item => `${item.name} (${item.quantity})`).join(', ')}
                    </div>

                    ${sale.notes ? `
                        <div class="text-xs text-gray-500 mt-1 italic">
                            ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${sale.notes}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function getPaymentMethodText(method) {
            const methods = {
                cash: 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
                card: 'üí≥ ‡∏ö‡∏±‡∏ï‡∏£',
                qr: 'üì± QR Code',
                transfer: 'üè¶ ‡πÇ‡∏≠‡∏ô'
            };
            return methods[method] || method;
        }

        // Peak Hours Analysis Functions
        function showPeakHoursModal() {
            loadPeakHoursData();
            document.getElementById('peak-hours-modal').classList.add('active');
        }

        function closePeakHoursModal() {
            document.getElementById('peak-hours-modal').classList.remove('active');
        }

        async function loadPeakHoursData() {
            try {
                await analyzeCurrentPeriod('week');
            } catch (error) {
                console.error('‚ùå Error loading peak hours data:', error);
            }
        }

        function selectAnalysisPeriod(period) {
            // Update UI
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-period="${period}"]`).classList.add('active');

            // Analyze data
            analyzeCurrentPeriod(period);
        }

        async function analyzeCurrentPeriod(period) {
            try {
                const sales = await window.db.getAll('sales') || [];
                const now = new Date();
                let startDate;

                switch (period) {
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarter':
                        startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        break;
                }

                const periodSales = sales.filter(sale =>
                    new Date(sale.completedAt) >= startDate
                );

                // Analyze peak hours
                const hourlyData = analyzePeakHours(periodSales);

                // Draw chart
                drawPeakHoursChart(hourlyData);

                // Show insights
                showPeakHoursInsights(hourlyData, period);

            } catch (error) {
                console.error('‚ùå Error analyzing peak hours:', error);
            }
        }

        function analyzePeakHours(sales) {
            const hourlyStats = {};

            // Initialize hours
            for (let hour = 0; hour < 24; hour++) {
                hourlyStats[hour] = {
                    hour,
                    sales: 0,
                    revenue: 0,
                    orders: []
                };
            }

            // Process sales data
            sales.forEach(sale => {
                const hour = new Date(sale.completedAt).getHours();
                hourlyStats[hour].sales += 1;
                hourlyStats[hour].revenue += sale.total;
                hourlyStats[hour].orders.push(sale);
            });

            return Object.values(hourlyStats);
        }

        function drawPeakHoursChart(hourlyData) {
            const ctx = document.getElementById('peak-hours-chart');
            if (!ctx) return;

            // Destroy existing chart
            if (AppState.peakHoursChart) {
                AppState.peakHoursChart.destroy();
            }

            const labels = hourlyData.map(data => `${data.hour}:00`);
            const salesData = hourlyData.map(data => data.sales);
            const revenueData = hourlyData.map(data => data.revenue);

            AppState.peakHoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢',
                        data: salesData,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                        data: revenueData,
                        type: 'line',
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 2,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢'
                        }
                    }
                }
            });
        }

        function showPeakHoursInsights(hourlyData, period) {
            // Find peak hours
            const sortedByRevenue = [...hourlyData].sort((a, b) => b.revenue - a.revenue);
            const topHours = sortedByRevenue.filter(data => data.sales > 0).slice(0, 5);

            // Display peak hours
            const peakHoursList = document.getElementById('peak-hours-list');
            peakHoursList.innerHTML = topHours.map((data, index) => `
                <div class="flex justify-between items-center py-2 ${index === 0 ? 'bg-yellow-50 rounded-lg px-3' : ''}">
                    <div>
                        <span class="font-medium">${data.hour}:00 - ${data.hour + 1}:00</span>
                        ${index === 0 ? '<span class="ml-2 text-yellow-600">üëë ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏≤‡∏™‡∏∏‡∏î</span>' : ''}
                    </div>
                    <div class="text-right">
                        <div class="font-medium">${data.sales} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                        <div class="text-sm text-gray-500">${Utils.formatCurrency(data.revenue)}</div>
                    </div>
                </div>
            `).join('');

            // Generate recommendations
            generatePeakHoursRecommendations(topHours, period);
        }

        function generatePeakHoursRecommendations(topHours, period) {
            const recommendations = [];

            if (topHours.length > 0) {
                const peakHour = topHours[0];

                if (peakHour.hour >= 11 && peakHour.hour <= 13) {
                    recommendations.push({
                        icon: 'üçΩÔ∏è',
                        text: '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô 11:00'
                    });
                }

                if (peakHour.hour >= 17 && peakHour.hour <= 19) {
                    recommendations.push({
                        icon: 'üåÜ',
                        text: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ä‡πà‡∏ß‡∏á 5-7 ‡πÇ‡∏°‡∏á'
                    });
                }

                if (topHours.length >= 3) {
                    const avgRevenue = topHours.slice(0, 3).reduce((sum, h) => sum + h.revenue, 0) / 3;
                    recommendations.push({
                        icon: 'üí∞',
                        text: `‡∏ä‡πà‡∏ß‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${Utils.formatCurrency(avgRevenue)}`
                    });
                }

                // Staffing recommendation
                if (peakHour.sales > 10) {
                    recommendations.push({
                        icon: 'üë•',
                        text: '‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡πà‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠'
                    });
                }

                // Stock preparation
                recommendations.push({
                    icon: 'üì¶',
                    text: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡πà‡∏≤ 30 ‡∏ô‡∏≤‡∏ó‡∏µ'
                });
            }

            if (recommendations.length === 0) {
                recommendations.push({
                    icon: 'üìä',
                    text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
                });
            }

            const container = document.getElementById('peak-hours-recommendations');
            container.innerHTML = recommendations.map(rec => `
                <div class="flex items-start gap-2">
                    <span class="text-lg">${rec.icon}</span>
                    <span class="text-sm">${rec.text}</span>
                </div>
            `).join('');
        }

        function loadProfitChart() {
            const ctx = document.getElementById('profitChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (AppState.profitChart) {
                AppState.profitChart.destroy();
            }

            // Sample profit data by menu item
            const profitData = [
                { name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏´‡∏°‡∏π', profit: 15 },
                { name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà', profit: 18 },
                { name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤', profit: 12 },
                { name: '‡∏Å‡∏≤‡πÅ‡∏ü', profit: 8 },
                { name: '‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô', profit: 5 }
            ];

            AppState.profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: profitData.map(item => item.name),
                    datasets: [{
                        label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)',
                        data: profitData.map(item => item.profit),
                        backgroundColor: '#22c55e',
                        borderColor: '#16a34a',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return `‡∏ø${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadCostBreakdownChart() {
            const ctx = document.getElementById('costBreakdownChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (AppState.costBreakdownChart) {
                AppState.costBreakdownChart.destroy();
            }

            // Sample cost breakdown data
            const costData = [
                { category: '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö', amount: 18000, color: '#ef4444' },
                { category: '‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á', amount: 7000, color: '#f97316' },
                { category: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤', amount: 2000, color: '#eab308' },
                { category: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', amount: 1000, color: '#6b7280' }
            ];

            AppState.costBreakdownChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: costData.map(item => item.category),
                    datasets: [{
                        data: costData.map(item => item.amount),
                        backgroundColor: costData.map(item => item.color),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${Utils.formatCurrency(context.raw)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadCostAnalysisTable() {
            try {
                const container = document.getElementById('cost-analysis-table');
                if (!container) return;

                // Sample menu items with cost analysis (replace with real data)
                const menuAnalysis = [
                    {
                        id: 1,
                        name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏´‡∏°‡∏π',
                        sellingPrice: 35,
                        ingredientCost: 18,
                        otherCosts: 2,
                        totalCost: 20,
                        profitPerUnit: 15,
                        profitMargin: 42.9,
                        unitsSold: 156,
                        totalProfit: 2340
                    },
                    {
                        id: 2,
                        name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà',
                        sellingPrice: 40,
                        ingredientCost: 20,
                        otherCosts: 2,
                        totalCost: 22,
                        profitPerUnit: 18,
                        profitMargin: 45.0,
                        unitsSold: 134,
                        totalProfit: 2412
                    },
                    {
                        id: 3,
                        name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤',
                        sellingPrice: 45,
                        ingredientCost: 30,
                        otherCosts: 3,
                        totalCost: 33,
                        profitPerUnit: 12,
                        profitMargin: 26.7,
                        unitsSold: 89,
                        totalProfit: 1068
                    },
                    {
                        id: 4,
                        name: '‡∏Å‡∏≤‡πÅ‡∏ü',
                        sellingPrice: 20,
                        ingredientCost: 10,
                        otherCosts: 2,
                        totalCost: 12,
                        profitPerUnit: 8,
                        profitMargin: 40.0,
                        unitsSold: 203,
                        totalProfit: 1624
                    },
                    {
                        id: 5,
                        name: '‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô',
                        sellingPrice: 18,
                        ingredientCost: 11,
                        otherCosts: 2,
                        totalCost: 13,
                        profitPerUnit: 5,
                        profitMargin: 27.8,
                        unitsSold: 167,
                        totalProfit: 835
                    }
                ];

                container.innerHTML = menuAnalysis.map(item => `
                    <tr>
                        <td class="font-medium">${item.name}</td>
                        <td class="text-right">${Utils.formatCurrency(item.sellingPrice)}</td>
                        <td class="text-right text-error">${Utils.formatCurrency(item.ingredientCost)}</td>
                        <td class="text-right text-warning">${Utils.formatCurrency(item.otherCosts)}</td>
                        <td class="text-right font-semibold text-error">${Utils.formatCurrency(item.totalCost)}</td>
                        <td class="text-right font-semibold ${item.profitPerUnit > 10 ? 'text-success' : item.profitPerUnit > 5 ? 'text-warning' : 'text-error'}">${Utils.formatCurrency(item.profitPerUnit)}</td>
                        <td class="text-right ${item.profitMargin > 35 ? 'text-success' : item.profitMargin > 20 ? 'text-warning' : 'text-error'}">${item.profitMargin.toFixed(1)}%</td>
                        <td class="text-right">${item.unitsSold}</td>
                        <td class="text-right font-semibold text-success">${Utils.formatCurrency(item.totalProfit)}</td>
                        <td class="text-center">
                            <div class="flex justify-center gap-1">
                                <button class="btn-icon btn-sm" onclick="editMenuItemCost(${item.id})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn-icon btn-sm" onclick="viewCostDetails(${item.id})" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                    üëÅÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                // Setup search functionality
                const searchInput = document.getElementById('cost-analysis-search');
                if (searchInput) {
                    searchInput.addEventListener('input', Utils.debounce((e) => {
                        filterCostAnalysis(e.target.value);
                    }, 300));
                }

                // Setup sort functionality
                const sortSelect = document.getElementById('cost-sort');
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => {
                        sortCostAnalysis(e.target.value);
                    });
                }

            } catch (error) {
                console.error('Error loading cost analysis table:', error);
            }
        }

        function generateCostRecommendations() {
            const container = document.getElementById('cost-recommendations');
            if (!container) return;

            const recommendations = [
                {
                    type: 'warning',
                    title: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≥',
                    description: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏û‡∏µ‡∏¢‡∏á 26.7% ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏ß‡πà‡∏≤',
                    action: '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á',
                    priority: '‡∏™‡∏π‡∏á'
                },
                {
                    type: 'success',
                    title: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏π‡∏á',
                    description: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£ 45% ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°',
                    action: '‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ú‡∏•',
                    priority: '‡∏Å‡∏•‡∏≤‡∏á'
                },
                {
                    type: 'info',
                    title: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏π‡∏á',
                    description: '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô 64% ‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏´‡∏≤‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà',
                    action: '‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤',
                    priority: '‡∏Å‡∏•‡∏≤‡∏á'
                },
                {
                    type: 'warning',
                    title: '‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≥',
                    description: '‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á 5 ‡∏ö‡∏≤‡∏ó ‡πÅ‡∏ï‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏≠‡∏≤‡∏à‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô',
                    action: '‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô',
                    priority: '‡∏Å‡∏•‡∏≤‡∏á'
                }
            ];

            const iconMap = {
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                error: '‚ùå'
            };

            const colorMap = {
                success: 'text-success',
                warning: 'text-warning',
                info: 'text-primary',
                error: 'text-error'
            };

            container.innerHTML = recommendations.map(rec => `
                <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-lg">
                    <div class="text-xl ${colorMap[rec.type]}">${iconMap[rec.type]}</div>
                    <div class="flex-1">
                        <div class="font-semibold mb-1">${rec.title}</div>
                        <div class="text-gray-600 text-sm mb-2">${rec.description}</div>
                        <div class="flex items-center gap-4">
                            <button class="btn btn-sm btn-primary">${rec.action}</button>
                            <span class="text-xs px-2 py-1 rounded-full ${rec.priority === '‡∏™‡∏π‡∏á' ? 'bg-error text-white' : rec.priority === '‡∏Å‡∏•‡∏≤‡∏á' ? 'bg-warning text-white' : 'bg-gray-300 text-gray-700'}">
                                ${rec.priority}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateProfitChart() {
            console.log('Updating profit chart');
            loadProfitChart();
            Toast.show('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ú‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏Å‡∏≥‡πÑ‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }

        function updateCostBreakdown() {
            console.log('Updating cost breakdown');
            loadCostBreakdownChart();
            Toast.show('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }

        function refreshCostAnalysis() {
            loadCostAnalysis();
            Toast.show('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function exportCostAnalysis() {
            // Simple CSV export functionality
            const data = [
                ['‡πÄ‡∏°‡∏ô‡∏π', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢', '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö', '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ', '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°', '‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô', '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£', '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢', '‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°']
                // Add your actual data here
            ];

            const csv = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cost_analysis_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            Toast.show('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function filterCostAnalysis(searchTerm) {
            const rows = document.querySelectorAll('#cost-analysis-table tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matches = text.includes(searchTerm.toLowerCase());
                row.style.display = matches ? '' : 'none';
            });
        }

        function sortCostAnalysis(sortBy) {
            console.log('Sorting cost analysis by:', sortBy);
            // Implementation for sorting would go here
            Toast.show('‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }

        function editMenuItemCost(itemId) {
            console.log('Editing cost for item:', itemId);
            Toast.show('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ', 'info');
        }

        function viewCostDetails(itemId) {
            console.log('Viewing cost details for item:', itemId);
            Toast.show('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ', 'info');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize app
            loadDashboard();

            // Menu search
            const menuSearch = document.getElementById('menu-search');
            if (menuSearch) {
                menuSearch.addEventListener('input', Utils.debounce((e) => {
                    renderMenu(e.target.value);
                }, 300));
            }

            // Inventory search
            const inventorySearch = document.getElementById('inventory-search');
            if (inventorySearch) {
                inventorySearch.addEventListener('input', Utils.debounce((e) => {
                    renderInventory(e.target.value);
                }, 300));
            }

            // Expense form
            const expenseForm = document.getElementById('expense-form');
            if (expenseForm) {
                expenseForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const expense = {
                        id: Utils.generateId(),
                        item: document.getElementById('expense-item').value,
                        amount: parseFloat(document.getElementById('expense-amount').value),
                        category: document.getElementById('expense-category').value,
                        notes: document.getElementById('expense-notes').value,
                        date: new Date().toISOString()
                    };

                    AppState.expenses.push(expense);
                    closeExpenseModal();
                    Toast.show(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ${Utils.formatCurrency(expense.amount)} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                });
            }

            // Close modals on backdrop click
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                });
            });

            // Handle back button for SPA navigation
            window.addEventListener('popstate', function() {
                // Handle browser back button if needed
            });

            // Prevent zoom on double tap for iOS
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = new Date().getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // Handle keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // ESC to close modals
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });

            // Comprehensive Button Event Listeners
            // Form Submit Buttons
            const expenseFormSubmit = document.querySelector('#expense-form button[type="submit"]');
            if (expenseFormSubmit) {
                expenseFormSubmit.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('expense-form');
                    if (form) {
                        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                });
            }

            const customerFormSubmit = document.querySelector('#add-customer-form button[type="submit"]');
            if (customerFormSubmit) {
                customerFormSubmit.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('add-customer-form');
                    if (form) {
                        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                });
            }

            const inventoryFormSubmit = document.querySelector('#add-inventory-form button[type="submit"]');
            if (inventoryFormSubmit) {
                inventoryFormSubmit.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('add-inventory-form');
                    if (form) {
                        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                });
            }

            // Navigation Button Event Listeners
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (!item.onclick) {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const screen = this.getAttribute('data-screen');
                        if (screen) {
                            switchScreen(screen + '-screen');
                        }
                    });
                }
            });

            // Add click effects to all buttons
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(button => {
                // Add loading state functionality
                button.addEventListener('click', function() {
                    // Add visual feedback for button clicks
                    if (!this.disabled) {
                        this.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            this.style.transform = '';
                        }, 100);
                    }
                });

                // Add keyboard support for Enter and Space
                button.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });

                // Add touch support for mobile
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.98)';
                }, { passive: true });

                button.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 100);
                }, { passive: true });
            });

            // Modal backdrop click handlers (for dynamically created modals)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop')) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                }
            });

            // Add event delegation for dynamically created buttons
            document.addEventListener('click', function(e) {
                const button = e.target.closest('button');
                if (button) {
                    // Handle dynamically created buttons that might not have onclick
                    const buttonText = button.textContent.trim();
                    const buttonClass = button.className;

                    // Handle specific button patterns
                    if (buttonText === '‡πÄ‡∏û‡∏¥‡πà‡∏°' && buttonClass.includes('btn-primary')) {
                        // This might be an "Add Category" button
                        if (button.closest('#manage-categories-modal')) {
                            addCategory();
                        }
                    }

                    // Handle menu item add buttons in POS
                    if (buttonText === '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°' && buttonClass.includes('btn-primary')) {
                        const menuItem = button.closest('.menu-item');
                        if (menuItem) {
                            const itemId = menuItem.getAttribute('data-item-id');
                            if (itemId) {
                                addToCart(itemId);
                            }
                        }
                    }

                    // Handle cart quantity buttons
                    if ((buttonText === '+' || buttonText === '-') && buttonClass.includes('btn-outline')) {
                        const cartItem = button.closest('.cart-item');
                        if (cartItem) {
                            // Extract item ID and quantity change from onclick attribute
                            const onclickAttr = button.getAttribute('onclick');
                            if (onclickAttr) {
                                try {
                                    eval(onclickAttr);
                                } catch (error) {
                                    console.error('Error executing cart button action:', error);
                                }
                            }
                        }
                    }

                    // Handle remove from cart buttons
                    if (buttonText === 'üóë' && buttonClass.includes('btn-error')) {
                        const cartItem = button.closest('.cart-item');
                        if (cartItem) {
                            const onclickAttr = button.getAttribute('onclick');
                            if (onclickAttr) {
                                try {
                                    eval(onclickAttr);
                                } catch (error) {
                                    console.error('Error executing remove button action:', error);
                                }
                            }
                        }
                    }
                }
            });

            // Add form validation helpers
            const allForms = document.querySelectorAll('form');
            allForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const requiredFields = form.querySelectorAll('[required]');
                    let isValid = true;

                    requiredFields.forEach(field => {
                        if (!field.value.trim()) {
                            field.style.borderColor = 'var(--error)';
                            isValid = false;
                        } else {
                            field.style.borderColor = '';
                        }
                    });

                    if (!isValid) {
                        e.preventDefault();
                        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                    }
                });
            });

            // Handle all form submissions properly
            // Add customer form
            const addCustomerForm = document.getElementById('add-customer-form');
            if (addCustomerForm) {
                addCustomerForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);

                    const customer = {
                        id: Utils.generateId(),
                        name: formData.get('name') || document.getElementById('customer-name').value,
                        phone: formData.get('phone') || document.getElementById('customer-phone').value,
                        email: formData.get('email') || document.getElementById('customer-email').value || '',
                        address: formData.get('address') || document.getElementById('customer-address').value || '',
                        created_at: new Date().toISOString(),
                        totalSpent: 0,
                        visits: 0,
                        lastVisit: new Date().toISOString()
                    };

                    AppState.customers.push(customer);
                    closeAddCustomerModal();
                    loadCustomers();
                    showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                });
            }

            // Add inventory form
            const addInventoryForm = document.getElementById('add-inventory-form');
            if (addInventoryForm) {
                addInventoryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    // Handle inventory form submission
                    const formData = new FormData(this);
                    console.log('Inventory form submitted:', Object.fromEntries(formData));
                    closeAddInventoryModal();
                    showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                });
            }

            // Settings form
            const settingsForm = document.querySelector('#settings-modal form');
            if (settingsForm) {
                settingsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveSettings();
                });
            }

            // Menu item form
            document.addEventListener('submit', function(e) {
                if (e.target.id === 'add-menu-item-form') {
                    e.preventDefault();
                    saveMenuItem();
                }

                if (e.target.id === 'edit-menu-item-form') {
                    e.preventDefault();
                    saveEditedMenuItem();
                }
            });

            // Add input field enhancement
            const allInputs = document.querySelectorAll('input, textarea, select');
            allInputs.forEach(input => {
                // Clear error styling on input
                input.addEventListener('input', function() {
                    this.style.borderColor = '';
                });

                // Add focus styling
                input.addEventListener('focus', function() {
                    this.style.borderColor = 'var(--primary)';
                });

                input.addEventListener('blur', function() {
                    if (!this.style.borderColor || this.style.borderColor === 'var(--primary)') {
                        this.style.borderColor = '';
                    }
                });
            });

            // Handle number inputs for mobile
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('input', function() {
                    // Ensure positive numbers where appropriate
                    if (this.min === '0' && parseFloat(this.value) < 0) {
                        this.value = '0';
                    }
                });
            });

            console.log('ü•™ POS System initialized successfully!');
        });

        // Menu Management Functions
        async function showAddMenuItemModal() {
            // Create and show modal for adding menu items
            const modalHTML = `
                <div id="add-menu-item-modal" class="modal active">
                    <div class="modal-backdrop" onclick="closeAddMenuItemModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</h3>
                            <button class="modal-close" onclick="closeAddMenuItemModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <form id="add-menu-item-form">
                                <div class="form-group">
                                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
                                    <input type="text" class="form-input" id="menu-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Æ‡∏°‡∏ä‡∏µ‡∏™" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" class="form-input" id="menu-price" placeholder="45.00" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" class="form-input" id="menu-cost" placeholder="12.00" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                    <select class="form-select" id="menu-category" required>
                                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                                        <option value="cat_sandwich">ü•™ ‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä</option>
                                        <option value="cat_beverage">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                        <option value="cat_side">üçü ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</option>
                                        <option value="cat_dessert">üç∞ ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                                    <textarea class="form-input" id="menu-description" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                                    <input type="number" class="form-input" id="menu-prep-time" placeholder="5" min="1" value="5">
                                </div>
                                <div class="form-group">
                                    <label class="form-checkbox">
                                        <input type="checkbox" id="menu-featured">
                                        <span>‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddMenuItemModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="button" class="btn btn-primary" onclick="saveMenuItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeAddMenuItemModal() {
            const modal = document.getElementById('add-menu-item-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveMenuItem() {
            try {
                const form = document.getElementById('add-menu-item-form');
                const formData = new FormData(form);

                const menuItem = {
                    name: document.getElementById('menu-name').value,
                    price: parseFloat(document.getElementById('menu-price').value),
                    cost: parseFloat(document.getElementById('menu-cost').value),
                    category: document.getElementById('menu-category').value,
                    description: document.getElementById('menu-description').value,
                    prep_time: parseInt(document.getElementById('menu-prep-time').value) || 5,
                    is_featured: document.getElementById('menu-featured').checked,
                    is_available: true
                };

                await window.db.create('menu_items', menuItem);
                showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeAddMenuItemModal();
                await loadMenuItems();

            } catch (error) {
                console.error('‚ùå Error saving menu item:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function loadMenuItems() {
            try {
                const menuItems = await window.db.getMenuItems();
                const container = document.getElementById('menu-items-container');

                if (!container) return;

                container.innerHTML = menuItems.map(item => `
                    <div class="card" data-menu-id="${item.id}">
                        <div class="card-body">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-lg font-semibold">${item.name}</h4>
                                    <p class="text-sm text-gray-500 mb-2">${item.description || ''}</p>
                                    <div class="flex gap-4 text-sm">
                                        <span class="text-green-600">‡∏£‡∏≤‡∏Ñ‡∏≤: ${Utils.formatCurrency(item.price)}</span>
                                        <span class="text-red-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${Utils.formatCurrency(item.cost)}</span>
                                        <span class="text-blue-600">‡∏Å‡∏≥‡πÑ‡∏£: ${Utils.formatCurrency(item.price - item.cost)}</span>
                                    </div>
                                    ${item.is_featured ? '<span class="badge badge-warning">‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>' : ''}
                                    ${!item.is_available ? '<span class="badge badge-error">‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</span>' : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-secondary" onclick="editMenuItem('${item.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button class="btn btn-sm ${item.is_available ? 'btn-warning' : 'btn-success'}"
                                        onclick="toggleMenuAvailability('${item.id}', ${!item.is_available})">
                                        ${item.is_available ? '‡∏ã‡πà‡∏≠‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('‚ùå Error loading menu items:', error);
            }
        }

        async function editMenuItem(itemId) {
            try {
                const item = await window.db.findById('menu_items', itemId);
                if (!item) return;

                const modalHTML = `
                    <div id="edit-menu-item-modal" class="modal active">
                        <div class="modal-backdrop" onclick="closeEditMenuItemModal()"></div>
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π</h3>
                                <button class="modal-close" onclick="closeEditMenuItemModal()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-menu-item-form">
                                    <input type="hidden" id="edit-item-id" value="${item.id}">
                                    <div class="form-group">
                                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
                                        <input type="text" class="form-input" id="edit-menu-name" value="${item.name}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                                        <input type="number" class="form-input" id="edit-menu-price" value="${item.price}" min="0" step="0.01" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                        <select class="form-input" id="edit-menu-category" required>
                                            <option value="‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä" ${item.category === '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä' ? 'selected' : ''}>‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä</option>
                                            <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°" ${item.category === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°' ? 'selected' : ''}>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                            <option value="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô" ${item.category === '‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô' ? 'selected' : ''}>‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ${item.category === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? 'selected' : ''}>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                                        <textarea class="form-input" id="edit-menu-description" rows="3" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">${item.description || ''}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                                        <input type="url" class="form-input" id="edit-menu-image" value="${item.image || ''}" placeholder="https://example.com/image.jpg">
                                    </div>
                                    <div class="form-group">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" id="edit-menu-available" ${item.is_available ? 'checked' : ''}>
                                            <label for="edit-menu-available">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeEditMenuItemModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button type="button" class="btn btn-primary" onclick="saveEditedMenuItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                <button type="button" class="btn btn-error" onclick="deleteMenuItem('${item.id}')">‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                console.error('‚ùå Error loading menu item for edit:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function closeEditMenuItemModal() {
            const modal = document.getElementById('edit-menu-item-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function saveEditedMenuItem() {
            try {
                const id = document.getElementById('edit-item-id').value;
                const menuItem = {
                    name: document.getElementById('edit-menu-name').value,
                    price: parseFloat(document.getElementById('edit-menu-price').value),
                    category: document.getElementById('edit-menu-category').value,
                    description: document.getElementById('edit-menu-description').value,
                    image: document.getElementById('edit-menu-image').value,
                    is_available: document.getElementById('edit-menu-available').checked
                };

                await window.db.update('menu_items', id, menuItem);
                showToast('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeEditMenuItemModal();
                await loadMenuItems();

            } catch (error) {
                console.error('‚ùå Error updating menu item:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function deleteMenuItem(itemId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ')) {
                try {
                    await window.db.delete('menu_items', itemId);
                    showToast('‚úÖ ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    closeEditMenuItemModal();
                    await loadMenuItems();
                } catch (error) {
                    console.error('‚ùå Error deleting menu item:', error);
                    showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }

        async function toggleMenuAvailability(itemId, isAvailable) {
            try {
                await window.db.update('menu_items', itemId, { is_available: isAvailable });
                showToast(`‚úÖ ${isAvailable ? '‡πÅ‡∏™‡∏î‡∏á' : '‡∏ã‡πà‡∏≠‡∏ô'}‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                await loadMenuItems();
            } catch (error) {
                console.error('‚ùå Error toggling menu availability:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function filterMenuItems() {
            const searchTerm = document.getElementById('menu-search').value.toLowerCase();
            const categoryFilter = document.getElementById('menu-category-filter').value;
            const menuCards = document.querySelectorAll('#menu-items-container .card');

            menuCards.forEach(card => {
                const menuId = card.dataset.menuId;
                const menuName = card.querySelector('h4').textContent.toLowerCase();
                const menuCategory = card.dataset.category || '';

                const matchesSearch = menuName.includes(searchTerm);
                const matchesCategory = !categoryFilter || menuCategory === categoryFilter;

                card.style.display = matchesSearch && matchesCategory ? 'block' : 'none';
            });
        }

        // Data export/import functions
        async function exportData() {
            try {
                const data = await window.db.exportData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sandwich-pos-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                console.error('‚ùå Error exporting data:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                await window.db.importData(data);
                showToast('‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                location.reload(); // Refresh to show imported data
            } catch (error) {
                console.error('‚ùå Error importing data:', error);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Customer Search Utility
        function filterCustomerSelect() {
            const searchTerm = document.getElementById('customer-select-search').value.toLowerCase();
            const customerItems = document.querySelectorAll('#customer-select-list > div');

            customerItems.forEach(item => {
                const customerName = item.querySelector('.font-medium')?.textContent.toLowerCase() || '';
                const customerPhone = item.querySelector('.text-sm')?.textContent.toLowerCase() || '';

                if (customerName.includes(searchTerm) || customerPhone.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ====================================
        // COMPREHENSIVE ANALYTICS DASHBOARD
        // ====================================

        // Analytics State Management
        const AnalyticsState = {
            currentPeriod: 'week',
            salesTrendChart: null,
            topProductsChart: null,
            profitAnalysisChart: null,
            peakHoursChart: null,
            paymentMethodsChart: null,
            salesData: [],
            filteredData: []
        };

        // Main Analytics Functions
        async function updateAnalyticsPeriod() {
            const period = document.getElementById('analytics-period').value;
            AnalyticsState.currentPeriod = period;
            await refreshAllAnalytics();
        }

        async function refreshAllAnalytics() {
            try {
                // Show loading state
                showAnalyticsLoading();

                // Load data based on current period
                await loadAnalyticsData();

                // Update all components
                await Promise.all([
                    updateKPIs(),
                    loadSalesTrendChart(),
                    loadTopProductsChart(),
                    loadProfitAnalysisChart(),
                    loadPeakHoursChart(),
                    loadCustomerAnalytics(),
                    loadPaymentMethodsChart(),
                    generateBusinessRecommendations()
                ]);

                // Hide loading state
                hideAnalyticsLoading();

                Toast.show('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

            } catch (error) {
                console.error('‚ùå Error refreshing analytics:', error);
                Toast.show('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        function showAnalyticsLoading() {
            // Add loading spinners to all charts
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                container.style.opacity = '0.5';
                container.style.pointerEvents = 'none';
            });
        }

        function hideAnalyticsLoading() {
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                container.style.opacity = '1';
                container.style.pointerEvents = 'auto';
            });
        }

        async function loadAnalyticsData() {
            try {
                const sales = await window.db.getAll('sales') || [];
                const now = new Date();
                let startDate;

                // Calculate date range based on current period
                switch (AnalyticsState.currentPeriod) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarter':
                        startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        break;
                }

                // Filter sales data
                AnalyticsState.filteredData = sales.filter(sale =>
                    new Date(sale.completedAt) >= startDate
                );

                AnalyticsState.salesData = sales;

            } catch (error) {
                console.error('‚ùå Error loading analytics data:', error);
                AnalyticsState.filteredData = [];
                AnalyticsState.salesData = [];
            }
        }

        async function updateKPIs() {
            try {
                const sales = AnalyticsState.filteredData;
                const allSales = AnalyticsState.salesData;

                // Calculate current period KPIs
                const totalSales = sales.length;
                const totalRevenue = sales.reduce((sum, sale) => sum + sale.total, 0);
                const avgOrderValue = totalSales > 0 ? totalRevenue / totalSales : 0;
                const totalCost = sales.reduce((sum, sale) => {
                    return sum + sale.items.reduce((itemSum, item) => {
                        return itemSum + (item.cost || item.price * 0.6); // Estimate 60% cost ratio
                    }, 0);
                }, 0);
                const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalCost) / totalRevenue * 100) : 0;

                // Calculate previous period for comparison
                const periodLength = getPeriodLength(AnalyticsState.currentPeriod);
                const previousStartDate = new Date(Date.now() - periodLength * 2);
                const previousEndDate = new Date(Date.now() - periodLength);

                const previousSales = allSales.filter(sale => {
                    const saleDate = new Date(sale.completedAt);
                    return saleDate >= previousStartDate && saleDate < previousEndDate;
                });

                const prevTotalSales = previousSales.length;
                const prevTotalRevenue = previousSales.reduce((sum, sale) => sum + sale.total, 0);
                const prevAvgOrderValue = prevTotalSales > 0 ? prevTotalRevenue / prevTotalSales : 0;

                // Calculate changes
                const salesChange = calculatePercentChange(totalSales, prevTotalSales);
                const revenueChange = calculatePercentChange(totalRevenue, prevTotalRevenue);
                const avgChange = calculatePercentChange(avgOrderValue, prevAvgOrderValue);

                // Update UI
                document.getElementById('kpi-total-sales').textContent = totalSales.toLocaleString();
                document.getElementById('kpi-total-revenue').textContent = Utils.formatCurrency(totalRevenue);
                document.getElementById('kpi-avg-order').textContent = Utils.formatCurrency(avgOrderValue);
                document.getElementById('kpi-profit-margin').textContent = profitMargin.toFixed(1) + '%';

                // Update change indicators
                document.getElementById('kpi-sales-change').textContent = formatChangeText(salesChange, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                document.getElementById('kpi-revenue-change').textContent = formatChangeText(revenueChange, '');
                document.getElementById('kpi-avg-change').textContent = formatChangeText(avgChange, '');
                document.getElementById('kpi-margin-change').textContent = formatChangeText(0, '%'); // Placeholder

            } catch (error) {
                console.error('‚ùå Error updating KPIs:', error);
            }
        }

        function getPeriodLength(period) {
            const lengths = {
                today: 24 * 60 * 60 * 1000,
                week: 7 * 24 * 60 * 60 * 1000,
                month: 30 * 24 * 60 * 60 * 1000,
                quarter: 90 * 24 * 60 * 60 * 1000,
                year: 365 * 24 * 60 * 60 * 1000
            };
            return lengths[period] || lengths.week;
        }

        function calculatePercentChange(current, previous) {
            if (previous === 0) return current > 0 ? 100 : 0;
            return ((current - previous) / previous * 100);
        }

        function formatChangeText(change, unit) {
            const sign = change >= 0 ? '+' : '';
            const arrow = change >= 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
            return `${arrow} ${sign}${change.toFixed(1)}%${unit ? ' ' + unit : ''}`;
        }

        // Sales Trend Chart
        async function loadSalesTrendChart() {
            const ctx = document.getElementById('salesTrendChart');
            if (!ctx) return;

            // Destroy existing chart
            if (AnalyticsState.salesTrendChart) {
                AnalyticsState.salesTrendChart.destroy();
            }

            try {
                const sales = AnalyticsState.filteredData;
                const { labels, salesData, revenueData } = processSalesTrendData(sales);

                AnalyticsState.salesTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)',
                            data: salesData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                            data: revenueData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ'
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('‚ùå Error loading sales trend chart:', error);
            }
        }

        function processSalesTrendData(sales) {
            const groupedData = {};
            const format = getDateFormat(AnalyticsState.currentPeriod);

            sales.forEach(sale => {
                const date = new Date(sale.completedAt);
                const key = formatDateByPeriod(date, AnalyticsState.currentPeriod);

                if (!groupedData[key]) {
                    groupedData[key] = { sales: 0, revenue: 0 };
                }

                groupedData[key].sales += 1;
                groupedData[key].revenue += sale.total;
            });

            const sortedKeys = Object.keys(groupedData).sort();

            return {
                labels: sortedKeys,
                salesData: sortedKeys.map(key => groupedData[key].sales),
                revenueData: sortedKeys.map(key => groupedData[key].revenue)
            };
        }

        function formatDateByPeriod(date, period) {
            switch (period) {
                case 'today':
                    return date.getHours() + ':00';
                case 'week':
                case 'month':
                    return date.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
                case 'quarter':
                case 'year':
                    return date.toLocaleDateString('th-TH', { month: 'short' });
                default:
                    return date.toLocaleDateString('th-TH');
            }
        }

        function changeSalesChartType(type) {
            // Update button states
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            // Update chart type
            if (AnalyticsState.salesTrendChart) {
                AnalyticsState.salesTrendChart.config.type = type;
                AnalyticsState.salesTrendChart.update();
            }
        }

        // Top Products Chart
        async function loadTopProductsChart() {
            const ctx = document.getElementById('topProductsChart');
            if (!ctx) return;

            if (AnalyticsState.topProductsChart) {
                AnalyticsState.topProductsChart.destroy();
            }

            try {
                const metric = document.getElementById('top-products-metric').value || 'quantity';
                const topProducts = calculateTopProducts(AnalyticsState.filteredData, metric);

                AnalyticsState.topProductsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topProducts.map(item => item.name),
                        datasets: [{
                            label: getMetricLabel(metric),
                            data: topProducts.map(item => item.value),
                            backgroundColor: generateColors(topProducts.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: `Top 10 ‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏≤‡∏°${getMetricLabel(metric)}`
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return metric === 'quantity' ? value : Utils.formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('‚ùå Error loading top products chart:', error);
            }
        }

        function calculateTopProducts(sales, metric) {
            const productStats = {};

            sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productStats[item.name]) {
                        productStats[item.name] = {
                            name: item.name,
                            quantity: 0,
                            revenue: 0,
                            profit: 0
                        };
                    }

                    productStats[item.name].quantity += item.quantity;
                    productStats[item.name].revenue += item.subtotal;
                    productStats[item.name].profit += item.subtotal * 0.4; // Estimate 40% profit margin
                });
            });

            return Object.values(productStats)
                .sort((a, b) => b[metric] - a[metric])
                .slice(0, 10)
                .map(item => ({
                    name: item.name,
                    value: item[metric]
                }));
        }

        function getMetricLabel(metric) {
            const labels = {
                quantity: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢',
                revenue: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
                profit: '‡∏Å‡∏≥‡πÑ‡∏£'
            };
            return labels[metric] || labels.quantity;
        }

        function updateTopProductsChart() {
            loadTopProductsChart();
        }

        // Profit Analysis Chart
        async function loadProfitAnalysisChart() {
            const ctx = document.getElementById('profitAnalysisChart');
            if (!ctx) return;

            if (AnalyticsState.profitAnalysisChart) {
                AnalyticsState.profitAnalysisChart.destroy();
            }

            try {
                const analysisType = document.getElementById('profit-analysis-type').value || 'daily';
                const profitData = calculateProfitAnalysis(AnalyticsState.filteredData, analysisType);

                AnalyticsState.profitAnalysisChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: profitData.labels,
                        datasets: [{
                            label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
                            data: profitData.revenue,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        }, {
                            label: '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô',
                            data: profitData.costs,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≥‡πÑ‡∏£ - ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ vs ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return Utils.formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

                // Update profit summary
                updateProfitSummary(profitData);

            } catch (error) {
                console.error('‚ùå Error loading profit analysis chart:', error);
            }
        }

        function calculateProfitAnalysis(sales, analysisType) {
            // Implementation varies by analysis type
            if (analysisType === 'daily') {
                return calculateDailyProfit(sales);
            } else if (analysisType === 'menu') {
                return calculateMenuProfit(sales);
            } else if (analysisType === 'category') {
                return calculateCategoryProfit(sales);
            }
        }

        function calculateDailyProfit(sales) {
            const dailyData = {};

            sales.forEach(sale => {
                const date = new Date(sale.completedAt).toLocaleDateString('th-TH');

                if (!dailyData[date]) {
                    dailyData[date] = { revenue: 0, costs: 0 };
                }

                dailyData[date].revenue += sale.total;
                dailyData[date].costs += sale.total * 0.6; // Estimate 60% cost
            });

            const sortedDates = Object.keys(dailyData).sort();

            return {
                labels: sortedDates,
                revenue: sortedDates.map(date => dailyData[date].revenue),
                costs: sortedDates.map(date => dailyData[date].costs)
            };
        }

        function calculateMenuProfit(sales) {
            const menuData = {};

            sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!menuData[item.name]) {
                        menuData[item.name] = { revenue: 0, costs: 0 };
                    }

                    menuData[item.name].revenue += item.subtotal;
                    menuData[item.name].costs += item.subtotal * 0.6;
                });
            });

            const topMenus = Object.entries(menuData)
                .sort(([,a], [,b]) => b.revenue - a.revenue)
                .slice(0, 10);

            return {
                labels: topMenus.map(([name]) => name),
                revenue: topMenus.map(([,data]) => data.revenue),
                costs: topMenus.map(([,data]) => data.costs)
            };
        }

        function calculateCategoryProfit(sales) {
            // Simplified category analysis
            const categoryData = {
                '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä': { revenue: 0, costs: 0 },
                '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°': { revenue: 0, costs: 0 },
                '‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô': { revenue: 0, costs: 0 },
                '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': { revenue: 0, costs: 0 }
            };

            sales.forEach(sale => {
                sale.items.forEach(item => {
                    const category = item.category || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                    if (categoryData[category]) {
                        categoryData[category].revenue += item.subtotal;
                        categoryData[category].costs += item.subtotal * 0.6;
                    }
                });
            });

            return {
                labels: Object.keys(categoryData),
                revenue: Object.values(categoryData).map(data => data.revenue),
                costs: Object.values(categoryData).map(data => data.costs)
            };
        }

        function updateProfitSummary(profitData) {
            const totalRevenue = profitData.revenue.reduce((sum, val) => sum + val, 0);
            const totalCosts = profitData.costs.reduce((sum, val) => sum + val, 0);
            const netProfit = totalRevenue - totalCosts;

            document.getElementById('profit-total-revenue').textContent = Utils.formatCurrency(totalRevenue);
            document.getElementById('profit-total-cost').textContent = Utils.formatCurrency(totalCosts);
            document.getElementById('profit-net-profit').textContent = Utils.formatCurrency(netProfit);
        }

        function updateProfitAnalysisChart() {
            loadProfitAnalysisChart();
        }

        // Peak Hours Chart (Enhanced)
        async function loadPeakHoursChart() {
            const ctx = document.getElementById('peakHoursChart');
            if (!ctx) return;

            if (AnalyticsState.peakHoursChart) {
                AnalyticsState.peakHoursChart.destroy();
            }

            try {
                const hourlyData = calculateHourlyStats(AnalyticsState.filteredData);
                const peakHour = findPeakHour(hourlyData);
                const slowHour = findSlowHour(hourlyData);

                AnalyticsState.peakHoursChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: hourlyData.labels,
                        datasets: [{
                            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢',
                            data: hourlyData.sales,
                            backgroundColor: hourlyData.sales.map((val, idx) =>
                                idx === peakHour.index ? '#ef4444' :
                                idx === slowHour.index ? '#94a3b8' : '#3b82f6'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Update peak hour display
                document.getElementById('peak-hour-display').textContent =
                    `${peakHour.hour}:00 (${peakHour.sales} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå)`;
                document.getElementById('slow-hour-display').textContent =
                    `${slowHour.hour}:00 (${slowHour.sales} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå)`;

            } catch (error) {
                console.error('‚ùå Error loading peak hours chart:', error);
            }
        }

        function calculateHourlyStats(sales) {
            const hourlyStats = Array.from({ length: 24 }, (_, i) => ({ hour: i, sales: 0 }));

            sales.forEach(sale => {
                const hour = new Date(sale.completedAt).getHours();
                hourlyStats[hour].sales += 1;
            });

            return {
                labels: hourlyStats.map(stat => `${stat.hour}:00`),
                sales: hourlyStats.map(stat => stat.sales)
            };
        }

        function findPeakHour(hourlyData) {
            let maxIndex = 0;
            let maxSales = hourlyData.sales[0];

            hourlyData.sales.forEach((sales, index) => {
                if (sales > maxSales) {
                    maxSales = sales;
                    maxIndex = index;
                }
            });

            return { index: maxIndex, hour: maxIndex, sales: maxSales };
        }

        function findSlowHour(hourlyData) {
            let minIndex = 0;
            let minSales = hourlyData.sales[0];

            hourlyData.sales.forEach((sales, index) => {
                if (sales < minSales && sales > 0) {
                    minSales = sales;
                    minIndex = index;
                }
            });

            return { index: minIndex, hour: minIndex, sales: minSales };
        }

        // Customer Analytics
        async function loadCustomerAnalytics() {
            try {
                const customers = await window.db.getAll('customers') || [];
                const sales = AnalyticsState.filteredData;

                // Calculate customer metrics
                const uniqueCustomers = new Set(sales.filter(sale => sale.customer).map(sale => sale.customer.id)).size;
                const returningCustomers = calculateReturningCustomers(customers, sales);
                const topCustomers = calculateTopCustomers(sales);

                // Update UI
                document.getElementById('total-customers').textContent = customers.length;
                document.getElementById('returning-customers').textContent = returningCustomers;

                // Display top customers
                displayTopCustomers(topCustomers);

            } catch (error) {
                console.error('‚ùå Error loading customer analytics:', error);
            }
        }

        function calculateReturningCustomers(customers, sales) {
            const customerPurchases = {};

            sales.forEach(sale => {
                if (sale.customer) {
                    customerPurchases[sale.customer.id] = (customerPurchases[sale.customer.id] || 0) + 1;
                }
            });

            return Object.values(customerPurchases).filter(count => count > 1).length;
        }

        function calculateTopCustomers(sales) {
            const customerStats = {};

            sales.forEach(sale => {
                if (sale.customer) {
                    const customerId = sale.customer.id;
                    if (!customerStats[customerId]) {
                        customerStats[customerId] = {
                            name: sale.customer.name,
                            totalSpent: 0,
                            orderCount: 0
                        };
                    }
                    customerStats[customerId].totalSpent += sale.total;
                    customerStats[customerId].orderCount += 1;
                }
            });

            return Object.values(customerStats)
                .sort((a, b) => b.totalSpent - a.totalSpent)
                .slice(0, 5);
        }

        function displayTopCustomers(topCustomers) {
            const container = document.getElementById('top-customers-list');

            if (topCustomers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <div>üë§</div>
                        <div class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = topCustomers.map((customer, index) => `
                <div class="flex justify-between items-center p-2 ${index === 0 ? 'bg-yellow-50' : 'bg-gray-50'} rounded-lg">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium">${index + 1}.</span>
                        <div>
                            <div class="font-medium">${customer.name}</div>
                            <div class="text-xs text-gray-500">${customer.orderCount} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-success">${Utils.formatCurrency(customer.totalSpent)}</div>
                        <div class="text-xs text-gray-500">‡∏£‡∏ß‡∏°</div>
                    </div>
                </div>
            `).join('');
        }

        // Payment Methods Chart
        async function loadPaymentMethodsChart() {
            const ctx = document.getElementById('paymentMethodsChart');
            if (!ctx) return;

            if (AnalyticsState.paymentMethodsChart) {
                AnalyticsState.paymentMethodsChart.destroy();
            }

            try {
                const paymentStats = calculatePaymentMethodStats(AnalyticsState.filteredData);

                AnalyticsState.paymentMethodsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: paymentStats.labels,
                        datasets: [{
                            data: paymentStats.values,
                            backgroundColor: [
                                '#10b981', // Cash - Green
                                '#3b82f6', // Card - Blue
                                '#8b5cf6', // QR - Purple
                                '#f59e0b'  // Transfer - Yellow
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.raw} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Display payment method stats
                displayPaymentMethodStats(paymentStats);

            } catch (error) {
                console.error('‚ùå Error loading payment methods chart:', error);
            }
        }

        function calculatePaymentMethodStats(sales) {
            const methodCounts = {
                cash: 0,
                card: 0,
                qr: 0,
                transfer: 0
            };

            const methodRevenue = {
                cash: 0,
                card: 0,
                qr: 0,
                transfer: 0
            };

            sales.forEach(sale => {
                const method = sale.paymentMethod || 'cash';
                methodCounts[method] = (methodCounts[method] || 0) + 1;
                methodRevenue[method] = (methodRevenue[method] || 0) + sale.total;
            });

            const methodLabels = {
                cash: 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
                card: 'üí≥ ‡∏ö‡∏±‡∏ï‡∏£',
                qr: 'üì± QR Code',
                transfer: 'üè¶ ‡πÇ‡∏≠‡∏ô'
            };

            return {
                labels: Object.keys(methodCounts).map(key => methodLabels[key]),
                values: Object.values(methodCounts),
                revenue: methodRevenue,
                counts: methodCounts
            };
        }

        function displayPaymentMethodStats(stats) {
            const container = document.getElementById('payment-methods-stats');
            const methodLabels = {
                cash: 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
                card: 'üí≥ ‡∏ö‡∏±‡∏ï‡∏£',
                qr: 'üì± QR Code',
                transfer: 'üè¶ ‡πÇ‡∏≠‡∏ô'
            };

            const totalTransactions = Object.values(stats.counts).reduce((sum, val) => sum + val, 0);

            container.innerHTML = Object.keys(stats.counts).map(method => {
                const count = stats.counts[method];
                const revenue = stats.revenue[method];
                const percentage = totalTransactions > 0 ? (count / totalTransactions * 100).toFixed(1) : 0;

                if (count === 0) return '';

                return `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-sm">${methodLabels[method]}</span>
                        <div class="text-right">
                            <span class="font-medium">${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${percentage}%)</span>
                            <div class="text-xs text-gray-500">${Utils.formatCurrency(revenue)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Business Recommendations
        async function generateBusinessRecommendations() {
            try {
                const recommendations = [];
                const sales = AnalyticsState.filteredData;
                const allSales = AnalyticsState.salesData;

                // Sales performance recommendations
                if (sales.length === 0) {
                    recommendations.push({
                        icon: 'üìä',
                        type: 'info',
                        title: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
                        message: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ',
                        priority: 'high'
                    });
                } else {
                    // Analyze sales trends
                    const recentSales = sales.slice(-7); // Last 7 transactions
                    const averageOrderValue = sales.reduce((sum, sale) => sum + sale.total, 0) / sales.length;

                    if (averageOrderValue < 50) {
                        recommendations.push({
                            icon: 'üí∞',
                            type: 'warning',
                            title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢',
                            message: `‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${Utils.formatCurrency(averageOrderValue)} ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á`,
                            priority: 'medium'
                        });
                    }

                    // Peak hours recommendations
                    const hourlyStats = calculateHourlyStats(sales);
                    const peakHour = findPeakHour(hourlyStats);

                    if (peakHour.sales > 5) {
                        recommendations.push({
                            icon: '‚è∞',
                            type: 'success',
                            title: '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏µ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß',
                            message: `‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏≤ ${peakHour.hour}:00 ‡∏°‡∏µ ${peakHour.sales} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°`,
                            priority: 'medium'
                        });
                    }

                    // Top products recommendations
                    const topProducts = calculateTopProducts(sales, 'quantity');
                    if (topProducts.length > 0) {
                        const bestSeller = topProducts[0];
                        recommendations.push({
                            icon: 'üèÜ',
                            type: 'success',
                            title: '‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ',
                            message: `${bestSeller.name} ‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (${bestSeller.value} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ‡∏Ñ‡∏ß‡∏£‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å`,
                            priority: 'low'
                        });
                    }

                    // Customer recommendations
                    const uniqueCustomers = new Set(sales.filter(sale => sale.customer).map(sale => sale.customer.id)).size;
                    const walkInRatio = (sales.filter(sale => !sale.customer).length / sales.length * 100);

                    if (walkInRatio > 80) {
                        recommendations.push({
                            icon: 'üë•',
                            type: 'info',
                            title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ê‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥',
                            message: `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ${walkInRatio.toFixed(1)}% ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥`,
                            priority: 'medium'
                        });
                    }

                    // Payment method recommendations
                    const paymentStats = calculatePaymentMethodStats(sales);
                    const cashRatio = (paymentStats.counts.cash / sales.length * 100);

                    if (cashRatio > 90) {
                        recommendations.push({
                            icon: 'üí≥',
                            type: 'info',
                            title: '‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                            message: `‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ${cashRatio.toFixed(1)}% ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° QR Code ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`,
                            priority: 'low'
                        });
                    }
                }

                // Inventory recommendations
                try {
                    const ingredients = await window.db.getAll('ingredients') || [];
                    const lowStockItems = ingredients.filter(ing =>
                        ing.currentStock <= ing.minimumStock
                    );

                    if (lowStockItems.length > 0) {
                        recommendations.push({
                            icon: 'üì¶',
                            type: 'warning',
                            title: '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î',
                            message: `‡∏°‡∏µ ${lowStockItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Ñ`,
                            priority: 'high'
                        });
                    }
                } catch (error) {
                    console.error('Error checking inventory:', error);
                }

                // Display recommendations
                displayBusinessRecommendations(recommendations);

            } catch (error) {
                console.error('‚ùå Error generating business recommendations:', error);
            }
        }

        function displayBusinessRecommendations(recommendations) {
            const container = document.getElementById('business-recommendations');

            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-6">
                        <div class="text-3xl mb-2">‚úÖ</div>
                        <div class="font-medium">‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏π‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß!</div>
                        <div class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>
                    </div>
                `;
                return;
            }

            // Sort by priority
            const sortedRecommendations = recommendations.sort((a, b) => {
                const priority = { high: 3, medium: 2, low: 1 };
                return priority[b.priority] - priority[a.priority];
            });

            container.innerHTML = sortedRecommendations.map(rec => `
                <div class="alert alert-${rec.type} flex items-start gap-3">
                    <span class="text-2xl">${rec.icon}</span>
                    <div class="flex-1">
                        <div class="font-medium">${rec.title}</div>
                        <div class="text-sm mt-1">${rec.message}</div>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full bg-white bg-opacity-20 text-gray-700">
                        ${rec.priority === 'high' ? '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' : rec.priority === 'medium' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}
                    </span>
                </div>
            `).join('');
        }

        // Utility Functions
        function generateColors(count) {
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'
            ];
            return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
        }

        function getDateFormat(period) {
            const formats = {
                today: 'HH:mm',
                week: 'MM/dd',
                month: 'MM/dd',
                quarter: 'MM/yyyy',
                year: 'MM/yyyy'
            };
            return formats[period] || formats.week;
        }

        // Initialize Analytics Dashboard when reports screen is shown
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Show selected screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                AppState.currentScreen = screenId;

                // Initialize analytics if reports screen is shown
                if (screenId === 'reports-screen') {
                    setTimeout(() => {
                        refreshAllAnalytics();
                    }, 100);
                }
            }

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });

            const activeNav = document.querySelector(`[onclick="switchScreen('${screenId}')"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }
        }

        function getCurrentScreen() {
            return AppState.currentScreen;
        }

        // ====================================
        // DATA EXPORT AND REPORTING SYSTEM
        // ====================================

        // Reporting State Management
        const ReportingState = {
            selectedReportType: null,
            selectedDatePeriod: 'today',
            selectedFormat: 'pdf',
            customStartDate: null,
            customEndDate: null,
            reportData: null,
            schedules: []
        };

        // Report Modal Functions
        function showReportsModal() {
            resetReportForm();
            document.getElementById('reports-modal').classList.add('active');
        }

        function closeReportsModal() {
            document.getElementById('reports-modal').classList.remove('active');
            resetReportForm();
        }

        function resetReportForm() {
            ReportingState.selectedReportType = null;
            ReportingState.selectedDatePeriod = 'today';
            ReportingState.selectedFormat = 'pdf';

            // Reset UI
            document.querySelectorAll('.report-option .border').forEach(el => {
                el.classList.remove('bg-blue-50', 'border-blue-300', 'bg-green-50', 'border-green-300',
                                   'bg-yellow-50', 'border-yellow-300', 'bg-purple-50', 'border-purple-300',
                                   'bg-red-50', 'border-red-300', 'bg-indigo-50', 'border-indigo-300');
            });

            document.getElementById('selected-report-display').classList.add('hidden');
            document.getElementById('custom-date-range').classList.add('hidden');
            document.getElementById('report-preview').classList.add('hidden');

            // Reset buttons
            document.querySelectorAll('.period-select-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-period="today"]').classList.add('active');

            document.querySelectorAll('.format-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-format="pdf"]').classList.add('active');

            document.getElementById('preview-btn').disabled = true;
            document.getElementById('download-btn').disabled = true;
        }

        function selectReportType(type) {
            ReportingState.selectedReportType = type;

            // Reset all report options
            document.querySelectorAll('.report-option .border').forEach(el => {
                el.classList.remove('bg-blue-50', 'border-blue-300', 'bg-green-50', 'border-green-300',
                                   'bg-yellow-50', 'border-yellow-300', 'bg-purple-50', 'border-purple-300',
                                   'bg-red-50', 'border-red-300', 'bg-indigo-50', 'border-indigo-300');
            });

            // Highlight selected report type
            const reportTypes = {
                sales: { name: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢', icon: 'üõí', classes: ['bg-blue-50', 'border-blue-300'] },
                profit: { name: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô', icon: 'üí∞', classes: ['bg-green-50', 'border-green-300'] },
                inventory: { name: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ', icon: 'üì¶', classes: ['bg-yellow-50', 'border-yellow-300'] },
                customer: { name: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', icon: 'üë•', classes: ['bg-purple-50', 'border-purple-300'] },
                expenses: { name: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', icon: 'üí∏', classes: ['bg-red-50', 'border-red-300'] },
                comprehensive: { name: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à', icon: 'üìà', classes: ['bg-indigo-50', 'border-indigo-300'] }
            };

            const selectedReport = reportTypes[type];
            const reportElement = document.querySelector(`[onclick="selectReportType('${type}')"] .border`);
            if (reportElement) {
                reportElement.classList.add(...selectedReport.classes);
            }

            // Show selected report display
            document.getElementById('selected-report-icon').textContent = selectedReport.icon;
            document.getElementById('selected-report-name').textContent = selectedReport.name;
            document.getElementById('selected-report-display').classList.remove('hidden');

            // Enable buttons
            document.getElementById('preview-btn').disabled = false;
            document.getElementById('download-btn').disabled = false;

            Toast.show(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å${selectedReport.name}‡πÅ‡∏•‡πâ‡∏ß`, 'success', 2000);
        }

        function selectDatePeriod(period) {
            ReportingState.selectedDatePeriod = period;

            // Update button states
            document.querySelectorAll('.period-select-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-period="${period}"]`).classList.add('active');

            // Show/hide custom date range
            const customDateRange = document.getElementById('custom-date-range');
            if (period === 'custom') {
                customDateRange.classList.remove('hidden');

                // Set default dates
                const today = new Date();
                const startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000); // 30 days ago

                document.getElementById('report-start-date').value = startDate.toISOString().split('T')[0];
                document.getElementById('report-end-date').value = today.toISOString().split('T')[0];
            } else {
                customDateRange.classList.add('hidden');
            }
        }

        function selectExportFormat(format) {
            ReportingState.selectedFormat = format;

            // Update button states
            document.querySelectorAll('.format-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-format="${format}"]`).classList.add('active');
        }

        // Report Generation Functions
        async function previewReport() {
            try {
                if (!ReportingState.selectedReportType) {
                    Toast.show('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                    return;
                }

                Toast.show('üìã ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...', 'info');

                // Generate report data
                const reportData = await generateReportData();
                ReportingState.reportData = reportData;

                // Show preview
                displayReportPreview(reportData);

            } catch (error) {
                console.error('‚ùå Error previewing report:', error);
                Toast.show('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', 'error');
            }
        }

        async function generateAndDownloadReport() {
            try {
                if (!ReportingState.selectedReportType) {
                    Toast.show('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                    return;
                }

                Toast.show('üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...', 'info');

                // Generate report data if not already generated
                if (!ReportingState.reportData) {
                    ReportingState.reportData = await generateReportData();
                }

                // Generate file based on selected format
                switch (ReportingState.selectedFormat) {
                    case 'pdf':
                        await generatePDFReport(ReportingState.reportData);
                        break;
                    case 'csv':
                        await generateCSVReport(ReportingState.reportData);
                        break;
                    case 'excel':
                        await generateExcelReport(ReportingState.reportData);
                        break;
                }

                Toast.show('‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                closeReportsModal();

            } catch (error) {
                console.error('‚ùå Error generating report:', error);
                Toast.show('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
            }
        }

        async function generateReportData() {
            const dateRange = getDateRange();
            const reportType = ReportingState.selectedReportType;

            // Get base data
            const sales = await window.db.getAll('sales') || [];
            const filteredSales = filterSalesByDateRange(sales, dateRange);

            let reportData = {
                type: reportType,
                dateRange: dateRange,
                period: ReportingState.selectedDatePeriod,
                generatedAt: new Date(),
                data: {}
            };

            switch (reportType) {
                case 'sales':
                    reportData.data = await generateSalesReportData(filteredSales);
                    break;
                case 'profit':
                    reportData.data = await generateProfitReportData(filteredSales);
                    break;
                case 'inventory':
                    reportData.data = await generateInventoryReportData();
                    break;
                case 'customer':
                    reportData.data = await generateCustomerReportData(filteredSales);
                    break;
                case 'expenses':
                    reportData.data = await generateExpensesReportData(dateRange);
                    break;
                case 'comprehensive':
                    reportData.data = await generateComprehensiveReportData(filteredSales, dateRange);
                    break;
            }

            return reportData;
        }

        function getDateRange() {
            const period = ReportingState.selectedDatePeriod;
            const now = new Date();

            if (period === 'custom') {
                const startDate = document.getElementById('report-start-date').value;
                const endDate = document.getElementById('report-end-date').value;
                return {
                    startDate: new Date(startDate),
                    endDate: new Date(endDate + 'T23:59:59')
                };
            }

            let startDate;
            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                default:
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            }

            return {
                startDate: startDate,
                endDate: new Date()
            };
        }

        function filterSalesByDateRange(sales, dateRange) {
            return sales.filter(sale => {
                const saleDate = new Date(sale.completedAt);
                return saleDate >= dateRange.startDate && saleDate <= dateRange.endDate;
            });
        }

        // Report Data Generators
        async function generateSalesReportData(sales) {
            const totalSales = sales.length;
            const totalRevenue = sales.reduce((sum, sale) => sum + sale.total, 0);
            const avgOrderValue = totalSales > 0 ? totalRevenue / totalSales : 0;

            // Daily breakdown
            const dailyBreakdown = {};
            sales.forEach(sale => {
                const date = new Date(sale.completedAt).toLocaleDateString('th-TH');
                if (!dailyBreakdown[date]) {
                    dailyBreakdown[date] = { sales: 0, revenue: 0 };
                }
                dailyBreakdown[date].sales += 1;
                dailyBreakdown[date].revenue += sale.total;
            });

            // Top products
            const productStats = {};
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productStats[item.name]) {
                        productStats[item.name] = { quantity: 0, revenue: 0 };
                    }
                    productStats[item.name].quantity += item.quantity;
                    productStats[item.name].revenue += item.subtotal;
                });
            });

            const topProducts = Object.entries(productStats)
                .sort(([,a], [,b]) => b.quantity - a.quantity)
                .slice(0, 10);

            // Payment methods
            const paymentMethods = {};
            sales.forEach(sale => {
                const method = sale.paymentMethod || 'cash';
                paymentMethods[method] = (paymentMethods[method] || 0) + 1;
            });

        }

        async function generateProfitReportData(sales) {
            const menu = await window.db.getAll('menu') || [];
            const ingredients = await window.db.getAll('ingredients') || [];

            let totalRevenue = 0;
            let totalCost = 0;
            const productProfits = {};

            for (const sale of sales) {
                totalRevenue += sale.total;

                for (const item of sale.items) {
                    const menuItem = menu.find(m => m.name === item.name);
                    if (menuItem && menuItem.cost) {
                        const itemCost = menuItem.cost * item.quantity;
                        totalCost += itemCost;

                        if (!productProfits[item.name]) {
                            productProfits[item.name] = {
                                revenue: 0,
                                cost: 0,
                                profit: 0,
                                margin: 0,
                                quantity: 0
                            };
                        }

                        productProfits[item.name].revenue += item.subtotal;
                        productProfits[item.name].cost += itemCost;
                        productProfits[item.name].quantity += item.quantity;
                    }
                }
            }

            // Calculate profit margins
            Object.keys(productProfits).forEach(product => {
                const data = productProfits[product];
                data.profit = data.revenue - data.cost;
                data.margin = data.revenue > 0 ? (data.profit / data.revenue) * 100 : 0;
            });

            const totalProfit = totalRevenue - totalCost;
            const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;

            // Sort products by profit
            const topProfitableProducts = Object.entries(productProfits)
                .sort(([,a], [,b]) => b.profit - a.profit)
                .slice(0, 10);

            return {
                summary: {
                    totalRevenue,
                    totalCost,
                    totalProfit,
                    profitMargin
                },
                productProfits,
                topProfitableProducts
            };
        }

        async function generateInventoryReportData() {
            const ingredients = await window.db.getAll('ingredients') || [];

            let totalValue = 0;
            const lowStockItems = [];
            const expiringSoonItems = [];
            const outOfStockItems = [];

            const now = new Date();
            const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            ingredients.forEach(ingredient => {
                const currentStock = ingredient.currentStock || 0;
                const minStock = ingredient.minStock || 10;
                const value = currentStock * (ingredient.costPerUnit || 0);
                totalValue += value;

                if (currentStock === 0) {
                    outOfStockItems.push(ingredient);
                } else if (currentStock <= minStock) {
                    lowStockItems.push(ingredient);
                }

                if (ingredient.expiryDate) {
                    const expiryDate = new Date(ingredient.expiryDate);
                    if (expiryDate <= sevenDaysFromNow && expiryDate > now) {
                        expiringSoonItems.push(ingredient);
                    }
                }
            });

            // Stock value by category
            const categoryValues = {};
            ingredients.forEach(ingredient => {
                const category = ingredient.category || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                const value = (ingredient.currentStock || 0) * (ingredient.costPerUnit || 0);
                categoryValues[category] = (categoryValues[category] || 0) + value;
            });

            return {
                summary: {
                    totalItems: ingredients.length,
                    totalValue,
                    lowStockCount: lowStockItems.length,
                    outOfStockCount: outOfStockItems.length,
                    expiringSoonCount: expiringSoonItems.length
                },
                lowStockItems,
                expiringSoonItems,
                outOfStockItems,
                categoryValues,
                allIngredients: ingredients
            };
        }

        async function generateCustomerReportData(sales) {
            const customerStats = {};
            let totalUniqueCustomers = 0;

            sales.forEach(sale => {
                const customerName = sale.customerName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                if (!customerStats[customerName]) {
                    customerStats[customerName] = {
                        orderCount: 0,
                        totalSpent: 0,
                        avgOrderValue: 0,
                        firstOrder: sale.completedAt,
                        lastOrder: sale.completedAt
                    };
                    if (customerName !== '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ') {
                        totalUniqueCustomers++;
                    }
                } else {
                    if (new Date(sale.completedAt) < new Date(customerStats[customerName].firstOrder)) {
                        customerStats[customerName].firstOrder = sale.completedAt;
                    }
                    if (new Date(sale.completedAt) > new Date(customerStats[customerName].lastOrder)) {
                        customerStats[customerName].lastOrder = sale.completedAt;
                    }
                }

                customerStats[customerName].orderCount += 1;
                customerStats[customerName].totalSpent += sale.total;
                customerStats[customerName].avgOrderValue =
                    customerStats[customerName].totalSpent / customerStats[customerName].orderCount;
            });

            // Top customers by spending
            const topCustomers = Object.entries(customerStats)
                .filter(([name]) => name !== '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')
                .sort(([,a], [,b]) => b.totalSpent - a.totalSpent)
                .slice(0, 20);

            // Customer segments
            const segments = {
                vip: topCustomers.filter(([,data]) => data.totalSpent >= 1000).length,
                regular: topCustomers.filter(([,data]) => data.totalSpent >= 500 && data.totalSpent < 1000).length,
                occasional: topCustomers.filter(([,data]) => data.totalSpent < 500).length
            };

            const avgOrderValue = sales.length > 0 ?
                sales.reduce((sum, sale) => sum + sale.total, 0) / sales.length : 0;

            return {
                summary: {
                    totalUniqueCustomers,
                    totalOrders: sales.length,
                    avgOrderValue,
                    repeatCustomerRate: totalUniqueCustomers > 0 ?
                        (topCustomers.filter(([,data]) => data.orderCount > 1).length / totalUniqueCustomers) * 100 : 0
                },
                topCustomers,
                segments,
                customerStats
            };
        }

        async function generateExpensesReportData(dateRange) {
            // Mock expenses data - in a real app, this would come from an expenses database
            const expenses = [
                { category: '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö', amount: 15000, date: new Date(), description: '‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
                { category: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤', amount: 8000, date: new Date(), description: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô' },
                { category: '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', amount: 2500, date: new Date(), description: '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
                { category: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥', amount: 800, date: new Date(), description: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
                { category: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', amount: 3000, date: new Date(), description: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î' }
            ];

            const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);

            // Group by category
            const categoryExpenses = {};
            expenses.forEach(expense => {
                categoryExpenses[expense.category] = (categoryExpenses[expense.category] || 0) + expense.amount;
            });

            // Monthly trend (mock data)
            const monthlyTrend = {
                '‡∏°.‡∏Ñ.': 28000,
                '‡∏Å.‡∏û.': 27500,
                '‡∏°‡∏µ.‡∏Ñ.': 29300,
                '‡πÄ‡∏°.‡∏¢.': totalExpenses
            };

            return {
                summary: {
                    totalExpenses,
                    categoryCount: Object.keys(categoryExpenses).length,
                    avgExpensePerCategory: totalExpenses / Object.keys(categoryExpenses).length
                },
                categoryExpenses,
                monthlyTrend,
                expenses
            };
        }

        async function generateComprehensiveReportData(sales, dateRange) {
            const salesData = await generateSalesReportData(sales);
            const profitData = await generateProfitReportData(sales);
            const inventoryData = await generateInventoryReportData();
            const customerData = await generateCustomerReportData(sales);
            const expensesData = await generateExpensesReportData(dateRange);

            // Business health score calculation
            const healthMetrics = {
                profitabilityScore: Math.min(100, Math.max(0, profitData.summary.profitMargin)),
                inventoryScore: Math.min(100, Math.max(0, 100 - (inventoryData.summary.lowStockCount * 10))),
                customerScore: Math.min(100, customerData.summary.repeatCustomerRate),
                salesGrowthScore: 75 // Mock score - would calculate based on historical data
            };

            const overallHealthScore = Object.values(healthMetrics).reduce((sum, score) => sum + score, 0) / 4;

            // Key recommendations
            const recommendations = [];

            if (profitData.summary.profitMargin < 20) {
                recommendations.push('üí° ‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≥: ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô');
            }

            if (inventoryData.summary.lowStockCount > 5) {
                recommendations.push('üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥: ‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°');
            }

            if (customerData.summary.repeatCustomerRate < 30) {
                recommendations.push('üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ô‡πâ‡∏≠‡∏¢: ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤');
            }

            if (salesData.summary.avgOrderValue < 100) {
                recommendations.push('üõí ‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≥: ‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°');
            }

            return {
                summary: {
                    overallHealthScore: Math.round(overallHealthScore),
                    totalRevenue: salesData.summary.totalRevenue,
                    totalProfit: profitData.summary.totalProfit,
                    totalExpenses: expensesData.summary.totalExpenses,
                    netIncome: profitData.summary.totalProfit - expensesData.summary.totalExpenses
                },
                healthMetrics,
                recommendations,
                salesData,
                profitData,
                inventoryData,
                customerData,
                expensesData
            };
        }

        // Report Preview Functions
        function displayReportPreview(reportData) {
            const previewContainer = document.getElementById('report-preview');
            const previewContent = document.getElementById('preview-content');

            let previewHTML = '';

            switch (reportData.type) {
                case 'sales':
                    previewHTML = generateSalesPreview(reportData.data);
                    break;
                case 'profit':
                    previewHTML = generateProfitPreview(reportData.data);
                    break;
                case 'inventory':
                    previewHTML = generateInventoryPreview(reportData.data);
                    break;
                case 'customer':
                    previewHTML = generateCustomerPreview(reportData.data);
                    break;
                case 'expenses':
                    previewHTML = generateExpensesPreview(reportData.data);
                    break;
                case 'comprehensive':
                    previewHTML = generateComprehensivePreview(reportData.data);
                    break;
            }

            previewContent.innerHTML = previewHTML;
            previewContainer.classList.remove('hidden');
        }

        function generateSalesPreview(data) {
            return `
                <div class="bg-white rounded-lg p-4 border">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${data.summary.totalSales}</div>
                            <div class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">‡∏ø${data.summary.totalRevenue.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600">‡∏ø${Math.round(data.summary.avgOrderValue)}</div>
                            <div class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">üèÜ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ (Top 5)</h4>
                        <div class="space-y-2">
                            ${data.topProducts.slice(0, 5).map(([name, stats]) => `
                                <div class="flex justify-between items-center py-2 border-b">
                                    <span class="font-medium">${name}</span>
                                    <div class="text-right">
                                        <div class="text-sm font-bold">${stats.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                                        <div class="text-xs text-gray-500">‡∏ø${stats.revenue.toLocaleString()}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="text-xs text-gray-400 text-center mt-4">
                        üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏∂‡∏á: ${new Date().toLocaleDateString('th-TH')}
                    </div>
                </div>
            `;
        }

        function generateProfitPreview(data) {
            return `
                <div class="bg-white rounded-lg p-4 border">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</h3>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">‡∏ø${data.summary.totalRevenue.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600">‡∏ø${data.summary.totalCost.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">‡∏ø${data.summary.totalProfit.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600">${data.summary.profitMargin.toFixed(1)}%</div>
                            <div class="text-sm text-gray-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">üèÜ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Top 5)</h4>
                        <div class="space-y-2">
                            ${data.topProfitableProducts.slice(0, 5).map(([name, stats]) => `
                                <div class="flex justify-between items-center py-2 border-b">
                                    <span class="font-medium">${name}</span>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-green-600">‡∏ø${stats.profit.toLocaleString()}</div>
                                        <div class="text-xs text-gray-500">${stats.margin.toFixed(1)}% margin</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateInventoryPreview(data) {
            return `
                <div class="bg-white rounded-lg p-4 border">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</h3>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${data.summary.totalItems}</div>
                            <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">‡∏ø${data.summary.totalValue.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Ñ</div>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600">${data.summary.lowStockCount}</div>
                            <div class="text-sm text-gray-600">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600">${data.summary.outOfStockCount}</div>
                            <div class="text-sm text-gray-600">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏°‡∏î</div>
                        </div>
                    </div>

                    ${data.summary.lowStockCount > 0 ? `
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2 text-yellow-600">‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h4>
                        <div class="space-y-1">
                            ${data.lowStockItems.slice(0, 5).map(item => `
                                <div class="flex justify-between items-center py-1 text-sm">
                                    <span>${item.name}</span>
                                    <span class="text-yellow-600 font-medium">${item.currentStock}/${item.minStock}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function generateCustomerPreview(data) {
            return `
                <div class="bg-white rounded-lg p-4 border">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üë• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600">${data.summary.totalUniqueCustomers}</div>
                            <div class="text-sm text-gray-600">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${data.summary.totalOrders}</div>
                            <div class="text-sm text-gray-600">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">‡∏ø${Math.round(data.summary.avgOrderValue)}</div>
                            <div class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600">${data.summary.repeatCustomerRate.toFixed(1)}%</div>
                            <div class="text-sm text-gray-600">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">üèÜ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ VIP (Top 5)</h4>
                        <div class="space-y-2">
                            ${data.topCustomers.slice(0, 5).map(([name, stats]) => `
                                <div class="flex justify-between items-center py-2 border-b">
                                    <span class="font-medium">${name}</span>
                                    <div class="text-right">
                                        <div class="text-sm font-bold">‡∏ø${stats.totalSpent.toLocaleString()}</div>
                                        <div class="text-xs text-gray-500">${stats.orderCount} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateExpensesPreview(data) {
            return `
                <div class="bg-white rounded-lg p-4 border">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üí∏ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>

                    <div class="bg-red-50 p-4 rounded-lg text-center mb-6">
                        <div class="text-3xl font-bold text-red-600">‡∏ø${data.summary.totalExpenses.toLocaleString()}</div>
                        <div class="text-sm text-gray-600">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
                    </div>

                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">üìä ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h4>
                        <div class="space-y-2">
                            ${Object.entries(data.categoryExpenses).map(([category, amount]) => {
                                const percentage = (amount / data.summary.totalExpenses * 100).toFixed(1);
                                return `
                                    <div class="flex justify-between items-center py-2 border-b">
                                        <span class="font-medium">${category}</span>
                                        <div class="text-right">
                                            <div class="text-sm font-bold">‡∏ø${amount.toLocaleString()}</div>
                                            <div class="text-xs text-gray-500">${percentage}%</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateComprehensivePreview(data) {
            return `
                <div class="bg-white rounded-lg p-4 border">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h3>

                    <div class="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg mb-6 text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2">${data.summary.overallHealthScore}/100</div>
                        <div class="text-sm text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-green-600">‡∏ø${data.summary.totalRevenue.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-blue-600">‡∏ø${data.summary.totalProfit.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-red-600">‡∏ø${data.summary.totalExpenses.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <div class="text-xl font-bold text-purple-600">‡∏ø${data.summary.netIncome.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h4>
                        <div class="space-y-2">
                            ${data.recommendations.map(rec => `
                                <div class="bg-yellow-50 p-2 rounded border-l-4 border-yellow-400 text-sm">
                                    ${rec}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // File Export Functions
        async function generatePDFReport(reportData) {
            // Simple HTML-to-PDF approach using browser print
            const printWindow = window.open('', '_blank');
            const reportHTML = generatePrintableHTML(reportData);

            printWindow.document.write(reportHTML);
            printWindow.document.close();

            // Trigger print dialog
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                // printWindow.close(); // Optional: close after printing
            }, 500);
        }

        async function generateCSVReport(reportData) {
            let csvContent = '';
            const reportType = reportData.type;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

            switch (reportType) {
                case 'sales':
                    csvContent = generateSalesCSV(reportData.data);
                    break;
                case 'profit':
                    csvContent = generateProfitCSV(reportData.data);
                    break;
                case 'inventory':
                    csvContent = generateInventoryCSV(reportData.data);
                    break;
                case 'customer':
                    csvContent = generateCustomerCSV(reportData.data);
                    break;
                case 'expenses':
                    csvContent = generateExpensesCSV(reportData.data);
                    break;
                case 'comprehensive':
                    csvContent = generateComprehensiveCSV(reportData.data);
                    break;
            }

            // Download CSV file
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${reportType}-report-${timestamp}.csv`;
            link.click();
        }

        async function generateExcelReport(reportData) {
            // For Excel export, we'll use a simple HTML table format that Excel can open
            const reportHTML = generateExcelHTML(reportData);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

            const blob = new Blob([reportHTML], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${reportData.type}-report-${timestamp}.xls`;
            link.click();
        }

        function generatePrintableHTML(reportData) {
            const reportTypeNames = {
                sales: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
                profit: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô',
                inventory: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                customer: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
                expenses: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                comprehensive: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à'
            };

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${reportTypeNames[reportData.type]} - Sandwich Shop</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
                        .summary-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; }
                        .summary-value { font-size: 24px; font-weight: bold; color: #2563eb; }
                        .summary-label { font-size: 14px; color: #666; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        .text-right { text-align: right; }
                        .recommendation { background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 10px; margin: 10px 0; }
                        @media print { body { margin: 0; } .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ü•™ Sandwich Shop</h1>
                        <h2>${reportTypeNames[reportData.type]}</h2>
                        <p>üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}</p>
                        <p>üìä ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ${formatDateRange(reportData.dateRange)}</p>
                    </div>
                    ${generatePrintContent(reportData)}
                </body>
                </html>
            `;
        }

        function generatePrintContent(reportData) {
            switch (reportData.type) {
                case 'sales':
                    return generateSalesPrintContent(reportData.data);
                case 'profit':
                    return generateProfitPrintContent(reportData.data);
                case 'inventory':
                    return generateInventoryPrintContent(reportData.data);
                case 'customer':
                    return generateCustomerPrintContent(reportData.data);
                case 'expenses':
                    return generateExpensesPrintContent(reportData.data);
                case 'comprehensive':
                    return generateComprehensivePrintContent(reportData.data);
                default:
                    return '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>';
            }
        }

        function generateSalesPrintContent(data) {
            return `
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-value">${data.summary.totalSales}</div>
                        <div class="summary-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">‡∏ø${data.summary.totalRevenue.toLocaleString()}</div>
                        <div class="summary-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">‡∏ø${Math.round(data.summary.avgOrderValue)}</div>
                        <div class="summary-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                    </div>
                </div>

                <h3>üèÜ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h3>
                <table>
                    <thead>
                        <tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-right">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th></tr>
                    </thead>
                    <tbody>
                        ${data.topProducts.map(([name, stats]) => `
                            <tr>
                                <td>${name}</td>
                                <td class="text-right">${stats.quantity}</td>
                                <td class="text-right">‡∏ø${stats.revenue.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function generateProfitPrintContent(data) {
            return `
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-value">‡∏ø${data.summary.totalRevenue.toLocaleString()}</div>
                        <div class="summary-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">‡∏ø${data.summary.totalCost.toLocaleString()}</div>
                        <div class="summary-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">‡∏ø${data.summary.totalProfit.toLocaleString()}</div>
                        <div class="summary-label">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${data.summary.profitMargin.toFixed(1)}%</div>
                        <div class="summary-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</div>
                    </div>
                </div>

                <h3>üí∞ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                <table>
                    <thead>
                        <tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-right">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th class="text-right">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th><th class="text-right">‡∏Å‡∏≥‡πÑ‡∏£</th><th class="text-right">% ‡∏Å‡∏≥‡πÑ‡∏£</th></tr>
                    </thead>
                    <tbody>
                        ${data.topProfitableProducts.map(([name, stats]) => `
                            <tr>
                                <td>${name}</td>
                                <td class="text-right">‡∏ø${stats.revenue.toLocaleString()}</td>
                                <td class="text-right">‡∏ø${stats.cost.toLocaleString()}</td>
                                <td class="text-right">‡∏ø${stats.profit.toLocaleString()}</td>
                                <td class="text-right">${stats.margin.toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function formatDateRange(dateRange) {
            const start = dateRange.startDate.toLocaleDateString('th-TH');
            const end = dateRange.endDate.toLocaleDateString('th-TH');
            return start === end ? start : `${start} - ${end}`;
        }

        // CSV Generation Functions
        function generateSalesCSV(data) {
            let csv = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢\n\n';
            csv += '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢\n';
            csv += '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤\n';
            csv += `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,${data.summary.totalSales}\n`;
            csv += `‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°,${data.summary.totalRevenue}\n`;
            csv += `‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå,${data.summary.avgOrderValue}\n\n`;

            csv += '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ\n';
            csv += '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ\n';
            data.topProducts.forEach(([name, stats]) => {
                csv += `${name},${stats.quantity},${stats.revenue}\n`;
            });

            return csv;
        }

        function generateProfitCSV(data) {
            let csv = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô\n\n';
            csv += '‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≥‡πÑ‡∏£\n';
            csv += '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤\n';
            csv += `‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°,${data.summary.totalRevenue}\n`;
            csv += `‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°,${data.summary.totalCost}\n`;
            csv += `‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥,${data.summary.totalProfit}\n`;
            csv += `‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£,${data.summary.profitMargin.toFixed(1)}%\n\n`;

            csv += '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î\n';
            csv += '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ,‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô,‡∏Å‡∏≥‡πÑ‡∏£,‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£(%)\n';
            data.topProfitableProducts.forEach(([name, stats]) => {
                csv += `${name},${stats.revenue},${stats.cost},${stats.profit},${stats.margin.toFixed(1)}\n`;
            });

            return csv;
        }

        function generateInventoryCSV(data) {
            let csv = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n\n';
            csv += '‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ï‡πá‡∏≠‡∏Ñ\n';
            csv += '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô\n';
            csv += `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,${data.summary.totalItems}\n`;
            csv += `‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Ñ,${data.summary.totalValue}\n`;
            csv += `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥,${data.summary.lowStockCount}\n`;
            csv += `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏°‡∏î,${data.summary.outOfStockCount}\n\n`;

            if (data.lowStockItems.length > 0) {
                csv += '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥\n';
                csv += '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô,‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î\n';
                data.lowStockItems.forEach(item => {
                    csv += `${item.name},${item.currentStock},${item.minStock}\n`;
                });
            }

            return csv;
        }

        function generateCustomerCSV(data) {
            let csv = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤\n\n';
            csv += '‡∏™‡∏£‡∏∏‡∏õ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤\n';
            csv += '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô\n';
            csv += `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,${data.summary.totalUniqueCustomers}\n`;
            csv += `‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,${data.summary.totalOrders}\n`;
            csv += `‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢,${data.summary.avgOrderValue}\n`;
            csv += `‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥,${data.summary.repeatCustomerRate.toFixed(1)}%\n\n`;

            csv += '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ VIP\n';
            csv += '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤,‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå,‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢\n';
            data.topCustomers.forEach(([name, stats]) => {
                csv += `${name},${stats.totalSpent},${stats.orderCount},${stats.avgOrderValue}\n`;
            });

            return csv;
        }

        function generateExpensesCSV(data) {
            let csv = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢\n\n';
            csv += '‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢\n';
            csv += `‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°,${data.summary.totalExpenses}\n\n`;

            csv += '‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà\n';
            csv += '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå\n';
            Object.entries(data.categoryExpenses).forEach(([category, amount]) => {
                const percentage = (amount / data.summary.totalExpenses * 100).toFixed(1);
                csv += `${category},${amount},${percentage}%\n`;
            });

            return csv;
        }

        function generateComprehensiveCSV(data) {
            let csv = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à\n\n';
            csv += '‡∏™‡∏£‡∏∏‡∏õ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à\n';
            csv += '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤\n';
            csv += `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à,${data.summary.overallHealthScore}/100\n`;
            csv += `‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°,${data.summary.totalRevenue}\n`;
            csv += `‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°,${data.summary.totalProfit}\n`;
            csv += `‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢,${data.summary.totalExpenses}\n`;
            csv += `‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥,${data.summary.netIncome}\n\n`;

            csv += '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç\n';
            data.recommendations.forEach((rec, index) => {
                csv += `${index + 1}. ${rec.replace(/[üèÜüì¶üë•üõíüí°]/g, '')}\n`;
            });

            return csv;
        }

        function generateExcelHTML(reportData) {
            // Generate Excel-compatible HTML table
            const reportTypeNames = {
                sales: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
                profit: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô',
                inventory: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                customer: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
                expenses: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                comprehensive: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à'
            };

            return `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                        th { background-color: #f0f0f0; font-weight: bold; }
                        .header { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ü•™ Sandwich Shop - ${reportTypeNames[reportData.type]}</h1>
                        <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}</p>
                        <p>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ${formatDateRange(reportData.dateRange)}</p>
                    </div>
                    ${generateExcelTableContent(reportData)}
                </body>
                </html>
            `;
        }

        function generateExcelTableContent(reportData) {
            // Generate table content based on report type
            // Implementation would be similar to print content but in table format
            return '<p>Excel table content would be generated here</p>';
        }

        // Report Scheduling Functions
        function showScheduleModal() {
            document.getElementById('schedule-modal').classList.add('active');
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').classList.remove('active');
        }

        function saveScheduledReport() {
            const reportType = document.getElementById('schedule-report-type').value;
            const frequency = document.getElementById('schedule-frequency').value;
            const email = document.getElementById('schedule-email').value;
            const time = document.getElementById('schedule-time').value;

            if (!reportType || !frequency || !email) {
                Toast.show('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            const schedule = {
                id: Date.now(),
                reportType,
                frequency,
                email,
                time,
                enabled: true,
                createdAt: new Date(),
                nextRun: calculateNextRun(frequency, time)
            };

            // Save to state (in real app, would save to database)
            ReportingState.schedules.push(schedule);

            Toast.show('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            closeScheduleModal();
            updateSchedulesList();
        }

        function calculateNextRun(frequency, time) {
            const now = new Date();
            const [hours, minutes] = time.split(':').map(Number);

            const nextRun = new Date();
            nextRun.setHours(hours, minutes, 0, 0);

            if (nextRun <= now) {
                // If time has passed today, schedule for tomorrow
                nextRun.setDate(nextRun.getDate() + 1);
            }

            // Adjust based on frequency
            switch (frequency) {
                case 'weekly':
                    // Set to next Monday
                    while (nextRun.getDay() !== 1) {
                        nextRun.setDate(nextRun.getDate() + 1);
                    }
                    break;
                case 'monthly':
                    // Set to first day of next month
                    nextRun.setDate(1);
                    nextRun.setMonth(nextRun.getMonth() + 1);
                    break;
            }

            return nextRun;
        }

        function updateSchedulesList() {
            // This would update the schedules list in the UI
            // In a real implementation, this would show all scheduled reports
            console.log('Scheduled reports:', ReportingState.schedules);
        }

        // ====================================
        // MOBILE OPTIMIZATION & PERFORMANCE
        // ====================================

        // Touch handling for better mobile experience
        let lastTouchTime = 0;

        function handleDoubleTouch(callback) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTouchTime;

            if (tapLength < 500 && tapLength > 0) {
                callback();
            }
            lastTouchTime = currentTime;
        }

        // Swipe gesture handling
        let startX = 0;
        let startY = 0;
        let distX = 0;
        let distY = 0;

        document.addEventListener('touchstart', function(e) {
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
        });

        document.addEventListener('touchmove', function(e) {
            e.preventDefault(); // Prevent scrolling
        }, { passive: false });

        document.addEventListener('touchend', function(e) {
            const touch = e.changedTouches[0];
            distX = touch.clientX - startX;
            distY = touch.clientY - startY;

            // Horizontal swipe (minimum 100px)
            if (Math.abs(distX) > Math.abs(distY) && Math.abs(distX) > 100) {
                if (distX > 0) {
                    // Swipe right - go to previous screen
                    handleSwipeRight();
                } else {
                    // Swipe left - go to next screen
                    handleSwipeLeft();
                }
            }
        });

        function handleSwipeRight() {
            // Navigate to previous screen based on current screen
            const currentScreen = AppState.currentScreen;
            switch (currentScreen) {
                case 'sales':
                    showScreen('menu');
                    break;
                case 'inventory':
                    showScreen('sales');
                    break;
                case 'cost-analysis':
                    showScreen('inventory');
                    break;
                case 'analytics':
                    showScreen('cost-analysis');
                    break;
                default:
                    // Do nothing for main menu or unsupported screens
                    break;
            }
        }

        function handleSwipeLeft() {
            // Navigate to next screen based on current screen
            const currentScreen = AppState.currentScreen;
            switch (currentScreen) {
                case 'menu':
                    showScreen('sales');
                    break;
                case 'sales':
                    showScreen('inventory');
                    break;
                case 'inventory':
                    showScreen('cost-analysis');
                    break;
                case 'cost-analysis':
                    showScreen('analytics');
                    break;
                default:
                    // Do nothing for analytics or unsupported screens
                    break;
            }
        }

        // Performance optimization for large lists
        function virtualizeList(containerId, items, renderItem, itemHeight = 60) {
            const container = document.getElementById(containerId);
            const scrollTop = container.scrollTop;
            const containerHeight = container.clientHeight;

            const startIndex = Math.floor(scrollTop / itemHeight);
            const endIndex = Math.min(startIndex + Math.ceil(containerHeight / itemHeight) + 1, items.length);

            // Clear container
            container.innerHTML = '';

            // Create spacer for items above viewport
            if (startIndex > 0) {
                const topSpacer = document.createElement('div');
                topSpacer.style.height = `${startIndex * itemHeight}px`;
                container.appendChild(topSpacer);
            }

            // Render visible items
            for (let i = startIndex; i < endIndex; i++) {
                const itemElement = renderItem(items[i], i);
                container.appendChild(itemElement);
            }

            // Create spacer for items below viewport
            if (endIndex < items.length) {
                const bottomSpacer = document.createElement('div');
                bottomSpacer.style.height = `${(items.length - endIndex) * itemHeight}px`;
                container.appendChild(bottomSpacer);
            }
        }

        // Offline support and data sync
        const OfflineManager = {
            isOnline: navigator.onLine,
            pendingOperations: [],

            init() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.syncPendingOperations();
                    Toast.show('üåê ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    Toast.show('üì± ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå', 'warning');
                });
            },

            addPendingOperation(operation) {
                this.pendingOperations.push({
                    ...operation,
                    timestamp: new Date(),
                    id: Date.now()
                });
                this.savePendingOperations();
            },

            async syncPendingOperations() {
                if (!this.isOnline || this.pendingOperations.length === 0) return;

                const operations = [...this.pendingOperations];
                this.pendingOperations = [];

                for (const operation of operations) {
                    try {
                        // Process each pending operation
                        await this.processOperation(operation);
                    } catch (error) {
                        console.error('Failed to sync operation:', error);
                        // Re-add failed operation
                        this.pendingOperations.push(operation);
                    }
                }

                this.savePendingOperations();

                if (this.pendingOperations.length === 0) {
                    Toast.show('‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            },

            async processOperation(operation) {
                // Process different types of operations
                switch (operation.type) {
                    case 'sale':
                        // Sync sale data
                        break;
                    case 'inventory_update':
                        // Sync inventory update
                        break;
                    case 'menu_update':
                        // Sync menu changes
                        break;
                    default:
                        console.warn('Unknown operation type:', operation.type);
                }
            },

            savePendingOperations() {
                try {
                    localStorage.setItem('pendingOperations', JSON.stringify(this.pendingOperations));
                } catch (error) {
                    console.error('Failed to save pending operations:', error);
                }
            },

            loadPendingOperations() {
                try {
                    const saved = localStorage.getItem('pendingOperations');
                    this.pendingOperations = saved ? JSON.parse(saved) : [];
                } catch (error) {
                    console.error('Failed to load pending operations:', error);
                    this.pendingOperations = [];
                }
            }
        };

        // Initialize offline manager
        OfflineManager.init();
        OfflineManager.loadPendingOperations();

        // Data compression for better performance
        function compressData(data) {
            // Simple compression by removing unnecessary whitespace
            return JSON.stringify(data).replace(/\s+/g, ' ');
        }

        function decompressData(compressedData) {
            return JSON.parse(compressedData);
        }

        // Memory management for better performance
        const MemoryManager = {
            cache: new Map(),
            maxCacheSize: 50,

            set(key, value, ttl = 300000) { // 5 minutes default TTL
                if (this.cache.size >= this.maxCacheSize) {
                    // Remove oldest entry
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }

                this.cache.set(key, {
                    value,
                    expires: Date.now() + ttl
                });
            },

            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;

                if (Date.now() > item.expires) {
                    this.cache.delete(key);
                    return null;
                }

                return item.value;
            },

            clear() {
                this.cache.clear();
            },

            cleanup() {
                const now = Date.now();
                for (const [key, item] of this.cache.entries()) {
                    if (now > item.expires) {
                        this.cache.delete(key);
                    }
                }
            }
        };

        // Cleanup memory cache every 5 minutes
        setInterval(() => {
            MemoryManager.cleanup();
        }, 300000);

        // Enhanced error handling and logging
        const ErrorLogger = {
            logs: [],
            maxLogs: 100,

            log(level, message, details = null) {
                const logEntry = {
                    timestamp: new Date(),
                    level,
                    message,
                    details,
                    url: window.location.href,
                    userAgent: navigator.userAgent
                };

                this.logs.push(logEntry);

                // Keep only recent logs
                if (this.logs.length > this.maxLogs) {
                    this.logs = this.logs.slice(-this.maxLogs);
                }

                // Save to localStorage
                try {
                    localStorage.setItem('errorLogs', JSON.stringify(this.logs));
                } catch (error) {
                    console.warn('Failed to save error logs:', error);
                }

                // Console output
                console[level](message, details);
            },

            error(message, details) {
                this.log('error', message, details);
            },

            warn(message, details) {
                this.log('warn', message, details);
            },

            info(message, details) {
                this.log('info', message, details);
            },

            exportLogs() {
                const blob = new Blob([JSON.stringify(this.logs, null, 2)],
                                    { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `error-logs-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        // Global error handler
        window.addEventListener('error', (e) => {
            ErrorLogger.error('JavaScript Error', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                stack: e.error?.stack
            });
        });

        window.addEventListener('unhandledrejection', (e) => {
            ErrorLogger.error('Unhandled Promise Rejection', {
                reason: e.reason,
                stack: e.reason?.stack
            });
        });

        // ====================================
        // SYSTEM INITIALIZATION
        // ====================================

        // System startup and initialization
        async function initializeSystem() {
            try {
                ErrorLogger.info('üöÄ Starting Sandwich Shop POS System...');

                // Show loading screen
                showLoadingScreen();

                // Initialize database
                await window.db.init();
                ErrorLogger.info('‚úÖ Database initialized');

                // Load initial data
                await loadInitialData();
                ErrorLogger.info('‚úÖ Initial data loaded');

                // Initialize analytics
                initializeAnalytics();
                ErrorLogger.info('‚úÖ Analytics initialized');

                // Setup offline support
                OfflineManager.init();
                ErrorLogger.info('‚úÖ Offline support initialized');

                // Load user preferences
                loadUserPreferences();
                ErrorLogger.info('‚úÖ User preferences loaded');

                // Hide loading screen and show main menu
                hideLoadingScreen();
                showScreen('menu');

                // Show welcome message
                setTimeout(() => {
                    Toast.show('ü•™ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Sandwich Shop POS!', 'success', 3000);
                }, 500);

                ErrorLogger.info('üéâ System initialization completed successfully');

            } catch (error) {
                ErrorLogger.error('‚ùå System initialization failed', error);
                showErrorScreen('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        }

        function showLoadingScreen() {
            document.body.innerHTML = `
                <div class="loading-screen" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    color: white;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    z-index: 10000;
                ">
                    <div class="loading-animation" style="
                        width: 80px;
                        height: 80px;
                        border: 4px solid rgba(255,255,255,0.3);
                        border-radius: 50%;
                        border-top-color: white;
                        animation: spin 1s ease-in-out infinite;
                        margin-bottom: 20px;
                    "></div>
                    <h2 style="margin: 0 0 10px 0; font-size: 24px;">ü•™ Sandwich Shop</h2>
                    <p style="margin: 0; font-size: 16px; opacity: 0.8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...</p>
                    <div class="loading-progress" style="
                        width: 200px;
                        height: 4px;
                        background: rgba(255,255,255,0.3);
                        border-radius: 2px;
                        margin-top: 20px;
                        overflow: hidden;
                    ">
                        <div class="progress-bar" style="
                            width: 0%;
                            height: 100%;
                            background: white;
                            border-radius: 2px;
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;

            // Simulate loading progress
            const progressBar = document.querySelector('.progress-bar');
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                progressBar.style.width = `${progress}%`;
            }, 200);
        }

        function hideLoadingScreen() {
            const loadingScreen = document.querySelector('.loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                loadingScreen.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    loadingScreen.remove();
                    // No need to restore HTML - just remove loading screen
                    // Re-initialize analytics if needed
                    if (typeof initializeAnalytics === 'function') {
                        initializeAnalytics();
                    }
                }, 500);
            }
        }

        function showErrorScreen(message) {
            document.body.innerHTML = `
                <div class="error-screen" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    color: white;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    text-align: center;
                    padding: 20px;
                    z-index: 10000;
                ">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h2 style="margin: 0 0 20px 0; font-size: 24px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
                    <p style="margin: 0 0 30px 0; font-size: 16px; opacity: 0.9; max-width: 400px; line-height: 1.5;">${message}</p>
                    <button onclick="location.reload()" style="
                        padding: 12px 24px;
                        background: white;
                        color: #ee5a24;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: transform 0.2s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </button>
                </div>
            `;
        }

        async function loadInitialData() {
            // Create sample data if database is empty
            const menuItems = await window.db.getAll('menu');

            if (!menuItems || menuItems.length === 0) {
                // Create initial menu items
                const sampleMenuItems = [
                    {
                        name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÅ‡∏Æ‡∏°',
                        price: 45,
                        cost: 25,
                        category: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä',
                        image: 'ü•™',
                        ingredients: ['‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', '‡πÅ‡∏Æ‡∏°', '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î', '‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™']
                    },
                    {
                        name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡πÑ‡∏Å‡πà',
                        price: 50,
                        cost: 28,
                        category: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä',
                        image: 'ü•™',
                        ingredients: ['‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', '‡πÑ‡∏Å‡πà', '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î', '‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™']
                    },
                    {
                        name: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä‡∏ó‡∏π‡∏ô‡πà‡∏≤',
                        price: 55,
                        cost: 30,
                        category: '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä',
                        image: 'ü•™',
                        ingredients: ['‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', '‡∏ó‡∏π‡∏ô‡πà‡∏≤', '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î', '‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™']
                    }
                ];

                for (const item of sampleMenuItems) {
                    await window.db.add('menu', item);
                }

                // Create initial ingredients
                const sampleIngredients = [
                    { name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', currentStock: 100, minStock: 20, costPerUnit: 2, unit: '‡πÅ‡∏ú‡πà‡∏ô', category: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á' },
                    { name: '‡πÅ‡∏Æ‡∏°', currentStock: 50, minStock: 10, costPerUnit: 8, unit: '‡πÅ‡∏ú‡πà‡∏ô', category: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå' },
                    { name: '‡πÑ‡∏Å‡πà', currentStock: 30, minStock: 5, costPerUnit: 12, unit: '‡∏ä‡∏¥‡πâ‡∏ô', category: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå' },
                    { name: '‡∏ó‡∏π‡∏ô‡πà‡∏≤', currentStock: 25, minStock: 5, costPerUnit: 15, unit: '‡∏Å‡∏•‡πà‡∏≠‡∏á', category: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå' },
                    { name: '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î', currentStock: 20, minStock: 5, costPerUnit: 3, unit: '‡∏ñ‡πâ‡∏ß‡∏¢', category: '‡∏ú‡∏±‡∏Å' },
                    { name: '‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™', currentStock: 10, minStock: 2, costPerUnit: 25, unit: '‡∏´‡∏•‡∏≠‡∏î', category: '‡∏ã‡∏≠‡∏™' }
                ];

                for (const ingredient of sampleIngredients) {
                    await window.db.add('ingredients', ingredient);
                }

                ErrorLogger.info('‚úÖ Sample data created');
            }
        }

        function loadUserPreferences() {
            try {
                const preferences = localStorage.getItem('userPreferences');
                if (preferences) {
                    const parsed = JSON.parse(preferences);
                    // Apply user preferences
                    if (parsed.theme) {
                        document.body.className = parsed.theme;
                    }
                }
            } catch (error) {
                ErrorLogger.warn('Failed to load user preferences:', error);
            }
        }

        // Final system completion notification
        console.log(`
        üéâ SANDWICH SHOP POS SYSTEM COMPLETED! üéâ

        ‚úÖ Features Implemented:
        ‚Ä¢ üì± Mobile-first responsive design
        ‚Ä¢ üçî Enhanced menu management with custom sandwich builder
        ‚Ä¢ üõí Complete sales tracking with customer management
        ‚Ä¢ üì¶ Advanced inventory management with smart alerts
        ‚Ä¢ üí∞ Comprehensive cost analysis and profit tracking
        ‚Ä¢ üìä Visual analytics dashboard with business intelligence
        ‚Ä¢ üìÑ Complete reporting system with PDF/CSV/Excel export
        ‚Ä¢ üìÖ Automated report scheduling with email delivery
        ‚Ä¢ üì± Touch-optimized mobile interface with gestures
        ‚Ä¢ üåê Offline support with data synchronization
        ‚Ä¢ ‚ö° Performance optimization and error handling
        ‚Ä¢ üíæ Local database with IndexedDB
        ‚Ä¢ üé® Professional UI with animations and transitions

        üöÄ Ready for production use!

        To start the system, the page will automatically initialize.
        Perfect for non-technical sandwich shop owners!
        `);

        // Auto-initialize system when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSystem);
        } else {
            // Delay initialization slightly to ensure all resources are loaded
            setTimeout(initializeSystem, 100);
        }

        // Service Worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
